<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Let me hear your sound</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style id="default-styles">
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        body {
            background: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100dvh;
            margin: 0;
            padding: 0;
        }
        .player {
            width: 100%;
            max-width: 440px;
            height: 100dvh;
            position: relative;
            display: flex;
            flex-direction: column;
            color: #e0e0e0;
            overflow: hidden;
            background-color: #0a0a0a;
        }
        .ambient-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            transition: background 0.3s ease;
            pointer-events: none;
        }
        .content {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            backdrop-filter: blur(8px);
        }
        .music-title {
            text-align: center;
            font-size: 16px;
            font-weight: 400;
            letter-spacing: 2px;
            color: #ccc;
            padding: 28px 0 8px;
            text-transform: uppercase;
            flex-shrink: 0;
            text-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }
        .avatar-pair {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 14px;
            margin: 0 0 10px 0;
            flex-shrink: 0;
        }
        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .chat-bubbles {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 20px;
            margin: 0 20px 10px;
            flex-shrink: 0;
        }
        .bubble-left, .bubble-right {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 45%;
        }
        .bubble {
            background: rgba(30, 30, 30, 0.7);
            backdrop-filter: blur(8px);
            border-radius: 20px;
            padding: 8px 18px;
            font-size: 13px;
            color: #f0f0f0;
            word-break: break-word;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            line-height: 1.45;
            text-align: center;
            max-width: 100%;
            border: none;
        }
        .typing-indicator {
            font-size: 10px;
            color: #aaa;
            margin-top: 4px;
            font-style: italic;
            display: none;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        .record-section {
            display: flex;
            justify-content: center;
            align-items: center;
            flex: 1;
            margin-top: -20px;
            cursor: pointer;
            min-height: 0;
        }
        .record {
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #222, #080808);
            display: flex;
            justify-content: center;
            align-items: center;
            animation: spin 18s linear infinite;
            animation-play-state: running;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.1), 
                        0 0 30px rgba(255,255,255,0.2),
                        0 0 60px rgba(0,0,0,0.6),
                        inset 0 0 30px rgba(0,0,0,0.8),
                        inset 0 0 10px rgba(0,0,0,0.9);
            position: relative;
        }
        .record::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: repeating-radial-gradient(circle at 50% 50%, 
                rgba(255,255,255,0.02) 0px, 
                rgba(255,255,255,0.02) 2px,
                rgba(0,0,0,0.2) 3px,
                rgba(0,0,0,0.2) 5px);
            opacity: 0.6;
            pointer-events: none;
            -webkit-mask: radial-gradient(circle, transparent 100px, black 100px);
            mask: radial-gradient(circle, transparent 100px, black 100px);
        }
        .album-cover {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background-image: url('https://i.postimg.cc/yx08SzP6/IMG-20260204-142411.jpg');
            background-size: cover;
            background-position: center;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.4);
            border: none;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        .chat-history-full {
            display: none;
            flex: 1;
            overflow-y: auto;
            background: transparent;
            margin: 0 20px 10px;
            padding: 4px 4px;
            flex-direction: column;
            gap: 0;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .chat-history-full::-webkit-scrollbar { display: none; }
        .history-line {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-bottom: 0;
        }
        .history-text {
            display: inline-block;
            padding: 0 12px;
            font-size: 13pt;
            line-height: 18pt;
            max-width: 85%;
            word-break: break-word;
            background: transparent;
            border: none;
            box-shadow: none;
            text-align: center;
        }
        .history-line[data-sender="Êàë"] .history-text { 
            color: var(--my-message-color, #aaa); 
            font-weight: 450; 
        }
        .history-line[data-sender="ÂØπÊñπ"] .history-text { 
            color: var(--opponent-message-color, #ddd); 
        }
        .history-time {
            font-size: 8px;
            color: #888;
            margin-top: 0px;
            align-self: flex-end;
            padding-right: 16px;
            line-height: 12px;
        }
        .date-separator {
            text-align: center;
            font-size: 9px;
            color: #777;
            margin: 4px 0;
            letter-spacing: 1px;
            font-weight: 300;
            width: 100%;
            border-bottom: 0.5px dashed #555;
            line-height: 0.1em;
        }
        .date-separator span {
            background: transparent;
            padding: 0 10px;
        }
        .action-row {
            display: flex;
            justify-content: space-evenly;
            padding: 8px 12px 0;
            color: #ddd;
            flex-shrink: 0;
            font-size: 24px;
            text-shadow: 0 2px 8px rgba(0,0,0,0.6);
        }
        .action-icon {
            font-size: 26px;
            cursor: pointer;
            transition: transform 0.1s;
            color: #eee;
        }
        .action-icon:hover { transform: scale(1.1); }
        .play-controls {
            display: flex;
            justify-content: space-between;
            padding: 8px 22px 18px;
            font-size: 30px;
            color: #eee;
            flex-shrink: 0;
            text-shadow: 0 2px 10px rgba(0,0,0,0.7);
        }
        .play-controls i { 
            cursor: pointer; 
            transition: transform 0.1s;
            color: #eee;
        }
        .play-controls i:hover { transform: scale(1.1); }
        .progress-wrapper {
            padding: 6px 20px 0;
            flex-shrink: 0;
        }
        .progress-area { width: 100%; }
        input[type=range] {
            width: 100%;
            height: 4px;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            outline: none;
            box-shadow: 0 0 6px rgba(255,255,255,0.2);
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 0 10px white, 0 0 20px rgba(255,255,255,0.5);
            cursor: pointer;
            border: none;
        }
        input[type=range]::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 0 10px white, 0 0 20px rgba(255,255,255,0.5);
            cursor: pointer;
            border: none;
        }
        input[type=range]::-webkit-slider-runnable-track {
            height: 4px;
            background: linear-gradient(to right, rgba(255,255,255,0.6), rgba(255,255,255,0.3));
            border-radius: 4px;
        }
        .time-display {
            display: flex;
            justify-content: space-between;
            padding: 6px 2px 0;
            font-size: 11px;
            color: #aaa;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 4px rgba(0,0,0,0.4);
        }
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: flex-start;
            z-index: 2000;
            backdrop-filter: blur(10px);
        }
        .status-card {
            width: 360px;
            max-width: 90%;
            backdrop-filter: blur(20px);
            border-radius: 28px;
            padding: 52px 24px 30px;
            margin-top: 18dvh;
            border: none;
            box-shadow: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: background 0.3s ease;
        }
        .status-avatar-group {
            display: flex;
            justify-content: center;
            gap: 52px;
            margin-top: -70px;
            margin-bottom: 18px;
        }
        .status-avatar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .status-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            object-fit: cover;
            box-shadow: 0 6px 14px rgba(0,0,0,0.3);
        }
        .status-text-only {
            font-size: 15px;
            color: #ddd;
            margin-top: 12px;
            background: transparent;
            backdrop-filter: none;
            padding: 0;
            border: none;
            cursor: pointer;
            font-weight: 400;
        }
        .divider {
            width: 70%;
            height: 1px;
            background: rgba(255,255,255,0.2);
            margin: 8px 0 26px;
            box-shadow: none;
        }
        .distance-custom {
            text-align: center;
            font-size: 17px;
            color: #ccc;
            cursor: pointer;
            background: transparent;
            backdrop-filter: none;
            padding: 0;
            border: none;
            width: fit-content;
            margin: 0 auto;
            font-weight: 400;
        }
        .settings-menu-card {
            width: 340px;
            max-width: 90%;
            background: rgba(30, 30, 30, 0.4);
            backdrop-filter: blur(20px);
            border-radius: 28px;
            padding: 24px 20px;
            border: none;
            box-shadow: none;
            margin-top: 8dvh;
        }
        .settings-menu-item {
            font-size: 20px;
            padding: 18px 12px;
            border-bottom: 0.5px solid rgba(255,255,255,0.1);
            color: #ddd;
            cursor: pointer;
        }
        .sub-settings-card {
            width: 340px;
            max-width: 90%;
            background: rgba(30, 30, 30, 0.4);
            backdrop-filter: blur(20px);
            border-radius: 28px;
            padding: 28px 22px;
            margin-top: 5dvh;
            max-height: 70dvh;
            overflow-y: auto;
            border: none;
            box-shadow: none;
        }
        .sub-settings-card h3 {
            font-size: 20px;
            font-weight: 400;
            color: #ddd;
            margin-bottom: 16px;
            border-left: 4px solid rgba(255,255,255,0.3);
            padding-left: 16px;
        }
        .back-btn {
            margin-bottom: 20px;
            display: inline-block;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(8px);
            padding: 8px 22px;
            border-radius: 50px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            color: #ddd;
        }
        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 0.5px solid rgba(255,255,255,0.1);
            flex-wrap: wrap;
            color: #ccc;
        }
        .file-upload-label {
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(4px);
            padding: 5px 14px;
            border-radius: 30px;
            font-size: 12px;
            cursor: pointer;
            border: none;
            color: #ddd;
        }
        .corpus-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
        }
        .corpus-table td {
            padding: 8px 6px;
            border-bottom: 0.5px dashed #444;
            font-size: 14px;
            color: #bbb;
        }
        .corpus-table .remove-cell {
            text-align: right;
            color: #999;
            cursor: pointer;
        }
        .pagination {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 20px;
            font-size: 15px;
        }
        .pagination span {
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(4px);
            padding: 6px 16px;
            border-radius: 50px;
            cursor: pointer;
            border: none;
            color: #ccc;
        }
        .bottom-chat-card {
            width: 100%;
            max-width: 440px;
            background: rgba(20, 20, 20, 0.7);
            backdrop-filter: blur(20px);
            border-radius: 28px 28px 0 0;
            padding: 18px 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            max-width: 440px;
            z-index: 2100;
            border-top: none;
        }
        .bottom-chat-card input {
            flex: 1;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            border: none;
            border-radius: 28px;
            padding: 16px 22px;
            font-size: 15px;
            color: #eee;
            outline: none;
            border: none;
        }
        .bottom-chat-card button {
            background: rgba(80,80,80,0.6);
            backdrop-filter: blur(4px);
            border: none;
            border-radius: 28px;
            padding: 14px 28px;
            color: white;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            border: none;
        }
        .tarot-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
            justify-content: center;
        }
        .tarot-card {
            width: 70px;
            height: 100px;
            background: rgba(40,40,40,0.7);
            backdrop-filter: blur(4px);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            color: #ddd;
            cursor: pointer;
            transition: background 0.15s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            text-align: center;
            padding: 4px;
            word-break: break-word;
            border: none;
        }
        .tarot-card.flipped {
            background: rgba(60,60,60,0.8);
            color: #fff;
        }
        .playlist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 10px;
            border-bottom: 0.5px solid rgba(255,255,255,0.1);
            cursor: pointer;
            color: #ccc;
        }
        .delete-song {
            color: #999;
            margin-left: 12px;
            cursor: pointer;
        }
        .import-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 16px 0;
        }
        .import-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .import-row input {
            flex: 1;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(4px);
            border: none;
            border-radius: 50px;
            padding: 12px 16px;
            font-size: 14px;
            color: #eee;
        }
        .import-row button {
            background: rgba(80,80,80,0.5);
            backdrop-filter: blur(4px);
            border: none;
            border-radius: 50px;
            padding: 10px 20px;
            white-space: nowrap;
            cursor: pointer;
            color: white;
            border: none;
        }
        @keyframes coinFlip { 0% { transform: rotateY(0); } 100% { transform: rotateY(360deg); } }
        .coin-spin { animation: coinFlip 0.5s ease; }
        .hidden { display: none; }
    </style>
    <style id="user-css"></style>
    <style id="custom-font-style"></style>
    <audio id="audio-player" preload="auto"></audio>
</head>
<body>
    <div class="player">
        <div class="ambient-bg" id="ambientBg" style="background-color:#1a1a1a;"></div>
        <div class="content">
            <div class="music-title" id="musicTitle">autumn leaves ¬∑ bill evans</div>
            <div class="avatar-pair">
                <img src="https://i.postimg.cc/QCcdWrbs/IMG-20260208-234658.jpg" class="avatar" id="avatarLeft" alt="TA">
                <img src="https://i.postimg.cc/QCcdWrbs/IMG-20260208-234658.jpg" class="avatar" id="avatarRight" alt="Êàë">
            </div>
            <div class="chat-bubbles" id="bubbleContainer">
                <div class="bubble-left">
                    <div class="bubble" id="latestOpponentMsg">&nbsp;</div>
                    <span id="typingIndicator" class="typing-indicator">Ê≠£Âú®ËæìÂÖ•...</span>
                </div>
                <div class="bubble-right">
                    <div class="bubble" id="latestMyMsg">&nbsp;</div>
                </div>
            </div>
            <div id="recordContainer" class="record-section">
                <div class="record" id="recordDisc">
                    <div class="album-cover" id="albumCover" style="background-image: url('https://i.postimg.cc/yx08SzP6/IMG-20260204-142411.jpg');"></div>
                </div>
            </div>
            <div id="historyFullView" class="chat-history-full"></div>
            <div class="action-row">
                <i class="fas fa-heart action-icon" id="companionBtn"></i>
                <i class="fas fa-comment-dots action-icon" id="chatBtn"></i>
                <i class="fas fa-bars action-icon" id="settingsBtn"></i>
            </div>
            <div class="progress-wrapper">
                <div class="progress-area">
                    <input type="range" id="progressSlider" value="0" max="100">
                </div>
                <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>
            </div>
            <div class="play-controls">
                <i class="fas fa-random" id="playModeIcon"></i>
                <i class="fas fa-backward-step" id="prevTrackBtn"></i>
                <i class="fas fa-play-circle" id="playPauseBtn"></i>
                <i class="fas fa-forward-step" id="nextTrackBtn"></i>
                <i class="fas fa-list-ul" id="playlistIcon"></i>
            </div>
        </div>
    </div>
    <div id="modalOverlay" class="modal-overlay"></div>

    <script>
        (function() {
            'use strict';

            // ---------- Â∏∏Èáè ----------
            const DEFAULT_COVER = 'https://i.postimg.cc/yx08SzP6/IMG-20260204-142411.jpg';
            const DEFAULT_AVATAR = 'https://i.postimg.cc/QCcdWrbs/IMG-20260208-234658.jpg';

            // ‚úÖ Êñ∞Â¢ûÔºöÂä†ËΩΩÊúü‰øùÊä§ÔºåÈÅøÂÖç load Êó∂Ë¢´ save Ë¶ÜÁõñ
            let isHydrating = false;
            // ‚úÖ Êñ∞Â¢ûÔºöÊòØÂê¶ÁúüÁöÑËØªÂà∞‰∫ÜÂ≠òÊ°£
            let hasLoadedStorage = false;

            // ---------- Áä∂ÊÄÅ ----------
            let taNickname = 'TA';
            let myStatus = 'üçµ ÂñùËå∂';
            let opponentStatus = ['‚òïÔ∏è ÂñùÂíñÂï°', 'üìö ÈòÖËØª', 'üéπ ÁªÉÁê¥', 'üö∂ Êï£Ê≠•', 'üåß Âê¨Èõ®', 'üò¥ Â∞èÊÜ©'][Math.floor(Math.random() * 6)];
            let distanceText = 'Áõ∏Ë∑ù 1,284km ¬∑ ‰∏ÄËµ∑Âê¨ 3h';
            let memorialDay = '2026-02-11';
            let chatHistory = [];
            let lastOpponentMsg = '', lastMyMsg = '';
            let replyCorpus = ['ËøôÁâàÁºñÊõ≤ÁúüÂ¶ô', 'Êàë‰πüÊÉ≥Â≠¶Èí¢Áê¥‰∫Ü', 'Èõ®Â§©Âê¨ÁªùÈÖç', 'Âæ™ÁéØÂÅú‰∏ç‰∏ãÊù•', '‰Ω†ÊúÄËøëÊ≠åÂìÅÂë≥ÂæàÂ•Ω', 'ÁàµÂ£´ÂíåÂº¶Â•ΩËàíÊúç', '‰∏ìËæëÂ∞ÅÈù¢‰πüÁæé', 'ÊàëÊ†áËÆ∞‰∫ÜÁ∫¢ÂøÉ'];
            let statusCorpus = ['‚òïÔ∏è ÂñùÂíñÂï°', 'üìö ÈòÖËØª', 'üéπ ÁªÉÁê¥', 'üö∂ Êï£Ê≠•', 'üåß Âê¨Èõ®', 'üò¥ Â∞èÊÜ©'];
            let replyMin = 1, replyMax = 3, delayMin = 2, delayMax = 6;
            let isRandomMode = true;
            let currentTrackIndex = 0;
            let playlist = [
                { title: 'autumn leaves ¬∑ bill evans', audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3' },
                { title: 'blue in green ¬∑ miles', audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3' },
                { title: 'my funny valentine ¬∑ chet', audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3' },
                { title: 'so what ¬∑ coltrane', audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3' }
            ];
            let coinFrontImg = null, coinBackImg = null;
            let currentBgColor = '#1a1a1a';

            const tarotNames = [
                "ÊÑöËÄÖ","È≠îÊúØÂ∏à","Â•≥Á•≠Âè∏","Â•≥Áöá","ÁöáÂ∏ù","ÊïôÁöá","ÊÅã‰∫∫","ÊàòËΩ¶","ÂäõÈáè","ÈöêÂ£´","ÂëΩËøê‰πãËΩÆ","Ê≠£‰πâ","ÂÄíÂêä‰∫∫","Ê≠ªÁ•û","ËäÇÂà∂","ÊÅ∂È≠î","Â°î","ÊòüÊòü","Êúà‰∫Æ","Â§™Èò≥","ÂÆ°Âà§","‰∏ñÁïå",
                "ÊùÉÊùñ‰∏Ä","ÊùÉÊùñ‰∫å","ÊùÉÊùñ‰∏â","ÊùÉÊùñÂõõ","ÊùÉÊùñ‰∫î","ÊùÉÊùñÂÖ≠","ÊùÉÊùñ‰∏É","ÊùÉÊùñÂÖ´","ÊùÉÊùñ‰πù","ÊùÉÊùñÂçÅ","ÊùÉÊùñ‰æç‰ªé","ÊùÉÊùñÈ™ëÂ£´","ÊùÉÊùñÁöáÂêé","ÊùÉÊùñÂõΩÁéã",
                "Âú£ÊùØ‰∏Ä","Âú£ÊùØ‰∫å","Âú£ÊùØ‰∏â","Âú£ÊùØÂõõ","Âú£ÊùØ‰∫î","Âú£ÊùØÂÖ≠","Âú£ÊùØ‰∏É","Âú£ÊùØÂÖ´","Âú£ÊùØ‰πù","Âú£ÊùØÂçÅ","Âú£ÊùØ‰æç‰ªé","Âú£ÊùØÈ™ëÂ£´","Âú£ÊùØÁöáÂêé","Âú£ÊùØÂõΩÁéã",
                "ÂÆùÂâë‰∏Ä","ÂÆùÂâë‰∫å","ÂÆùÂâë‰∏â","ÂÆùÂâëÂõõ","ÂÆùÂâë‰∫î","ÂÆùÂâëÂÖ≠","ÂÆùÂâë‰∏É","ÂÆùÂâëÂÖ´","ÂÆùÂâë‰πù","ÂÆùÂâëÂçÅ","ÂÆùÂâë‰æç‰ªé","ÂÆùÂâëÈ™ëÂ£´","ÂÆùÂâëÁöáÂêé","ÂÆùÂâëÂõΩÁéã",
                "ÊòüÂ∏Å‰∏Ä","ÊòüÂ∏Å‰∫å","ÊòüÂ∏Å‰∏â","ÊòüÂ∏ÅÂõõ","ÊòüÂ∏Å‰∫î","ÊòüÂ∏ÅÂÖ≠","ÊòüÂ∏Å‰∏É","ÊòüÂ∏ÅÂÖ´","ÊòüÂ∏Å‰πù","ÊòüÂ∏ÅÂçÅ","ÊòüÂ∏Å‰æç‰ªé","ÊòüÂ∏ÅÈ™ëÂ£´","ÊòüÂ∏ÅÁöáÂêé","ÊòüÂ∏ÅÂõΩÁéã"
            ];

            // ---------- DOM ÂÖÉÁ¥† ----------
            const overlay = document.getElementById('modalOverlay');
            const ambientBg = document.getElementById('ambientBg');
            const opponentBubble = document.getElementById('latestOpponentMsg');
            const myBubble = document.getElementById('latestMyMsg');
            const typingEl = document.getElementById('typingIndicator');
            const recordDiv = document.getElementById('recordContainer');
            const recordDisc = document.getElementById('recordDisc');
            const historyDiv = document.getElementById('historyFullView');
            const bubbleContainer = document.getElementById('bubbleContainer');
            const musicTitle = document.getElementById('musicTitle');
            const albumCover = document.getElementById('albumCover');
            const playModeIcon = document.getElementById('playModeIcon');
            const prevBtn = document.getElementById('prevTrackBtn');
            const nextBtn = document.getElementById('nextTrackBtn');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const progressSlider = document.getElementById('progressSlider');
            const currentTimeSpan = document.getElementById('currentTime');
            const totalTimeSpan = document.getElementById('totalTime');
            const audioPlayer = document.getElementById('audio-player');
            const fontStyle = document.getElementById('custom-font-style');
            const userStyle = document.getElementById('user-css');

            // Êí≠ÊîæÁä∂ÊÄÅ
            let isPlaying = false;
            recordDisc.style.animationPlayState = 'paused';
            playPauseBtn.className = 'fas fa-play-circle';

            function formatTime(seconds) {
                if (isNaN(seconds) || !isFinite(seconds)) return '0:00';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            function rgbToHsl(r, g, b) {
                r /= 255, g /= 255, b /= 255;
                const max = Math.max(r, g, b), min = Math.min(r, g, b);
                let h, s, l = (max + min) / 2;
                if (max === min) {
                    h = s = 0;
                } else {
                    const d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                    switch (max) {
                        case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                        case g: h = (b - r) / d + 2; break;
                        case b: h = (r - g) / d + 4; break;
                    }
                    h /= 6;
                }
                return [h * 360, s, l];
            }

            function updateMessageColorsFromBg(rgbColor) {
                if (!rgbColor || !rgbColor.startsWith('rgb')) return;
                const match = rgbColor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
                if (!match) return;
                const r = parseInt(match[1]), g = parseInt(match[2]), b = parseInt(match[3]);
                const [h, s, l] = rgbToHsl(r, g, b);
                const isDark = l < 0.5;
                const myS = 0.7;
                const myL = isDark ? 0.9 : 0.2;
                const oppS = 0.4;
                const oppL = isDark ? 0.7 : 0.4;
                const myColor = `hsl(${h}, ${myS * 100}%, ${myL * 100}%)`;
                const oppColor = `hsl(${h}, ${oppS * 100}%, ${oppL * 100}%)`;
                document.documentElement.style.setProperty('--my-message-color', myColor);
                document.documentElement.style.setProperty('--opponent-message-color', oppColor);
            }

            async function getDominantColor(imgUrl) {
                if (imgUrl.startsWith('blob:')) {
                    return extractColorFromBlobUrl(imgUrl);
                }
                try {
                    const response = await fetch(imgUrl, { mode: 'cors' });
                    if (!response.ok) throw new Error('fetch failed');
                    const blob = await response.blob();
                    const blobUrl = URL.createObjectURL(blob);
                    const color = await extractColorFromBlobUrl(blobUrl);
                    URL.revokeObjectURL(blobUrl);
                    return color;
                } catch (e) {
                    console.warn('Ë∑®ÂüüÂõæÁâáÂä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§Ëâ≤', e);
                    return '#1a1a1a';
                }
            }

            function extractColorFromBlobUrl(blobUrl) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = 'Anonymous';
                    img.src = blobUrl;
                    img.onload = function() {
                        try {
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, img.width, img.height);
                            const data = ctx.getImageData(0, 0, img.width, img.height).data;
                            let r = 0, g = 0, b = 0, count = 0;
                            for (let i = 0; i < data.length; i += 40) {
                                r += data[i];
                                g += data[i+1];
                                b += data[i+2];
                                count++;
                            }
                            r = Math.floor(r / count);
                            g = Math.floor(g / count);
                            b = Math.floor(b / count);
                            resolve(`rgb(${r}, ${g}, ${b})`);
                        } catch {
                            resolve('#1a1a1a');
                        }
                    };
                    img.onerror = () => resolve('#1a1a1a');
                });
            }

            async function updateAmbientBg(imgUrl) {
                const color = await getDominantColor(imgUrl);
                currentBgColor = color;
                ambientBg.style.background = `linear-gradient(180deg, ${color}, ${color}), linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.3) 100%)`;
                updateMessageColorsFromBg(color);
                saveAllData();
            }

            function initAmbientBg() { updateAmbientBg(DEFAULT_COVER); }

            function updateCoverAndBg(imgUrl) {
                albumCover.style.backgroundImage = `url('${imgUrl}')`;
                updateAmbientBg(imgUrl);
            }

            function playCurrent() {
                audioPlayer.play().then(() => {
                    isPlaying = true;
                    recordDisc.style.animationPlayState = 'running';
                    playPauseBtn.className = 'fas fa-pause-circle';
                }).catch(e => console.log('Êí≠ÊîæÂ§±Ë¥•:', e));
            }
            function pauseCurrent() {
                audioPlayer.pause();
                isPlaying = false;
                recordDisc.style.animationPlayState = 'paused';
                playPauseBtn.className = 'fas fa-play-circle';
            }

            window.playTrack = function(index) {
                if (!playlist[index]) return;
                currentTrackIndex = index;
                musicTitle.innerText = playlist[index].title;
                audioPlayer.src = playlist[index].audioUrl;
                audioPlayer.load();
                if (isPlaying) audioPlayer.play().catch(e => console.log('Ëá™Âä®Êí≠ÊîæÂ§±Ë¥•:', e));
                saveAllData();
            };

            audioPlayer.addEventListener('timeupdate', function() {
                if (audioPlayer.duration) {
                    progressSlider.value = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                    currentTimeSpan.textContent = formatTime(audioPlayer.currentTime);
                    totalTimeSpan.textContent = formatTime(audioPlayer.duration);
                }
            });
            audioPlayer.addEventListener('loadedmetadata', function() {
                totalTimeSpan.textContent = formatTime(audioPlayer.duration);
            });
            progressSlider.addEventListener('input', function() {
                if (audioPlayer.duration) {
                    audioPlayer.currentTime = (progressSlider.value / 100) * audioPlayer.duration;
                }
            });

            let showingRecord = true;
            recordDiv.addEventListener('click', function(e) {
                e.stopPropagation();
                if (showingRecord) {
                    recordDiv.style.display = 'none';
                    historyDiv.style.display = 'flex';
                    bubbleContainer.style.display = 'none';
                    renderChatHistoryFull();
                    showingRecord = false;
                }
            });
            historyDiv.addEventListener('click', function() {
                recordDiv.style.display = 'flex';
                historyDiv.style.display = 'none';
                bubbleContainer.style.display = 'flex';
                showingRecord = true;
            });

            function renderChatHistoryFull() {
                let html = '';
                let lastDate = null;
                chatHistory.forEach((msg, idx) => {
                    const dateStr = msg.time.split(' ')[0];
                    if (lastDate && dateStr !== lastDate) {
                        html += `<div class="date-separator"><span>${dateStr}</span></div>`;
                    }
                    lastDate = dateStr;
                    html += `<div class="history-line" data-sender="${msg.sender}">
                        <span class="history-text">${msg.content}</span>
                        <span class="history-time">${msg.time.split(' ')[1] || msg.time}</span>
                    </div>`;
                });
                historyDiv.innerHTML = html;
                historyDiv.scrollTop = historyDiv.scrollHeight;
            }

            function showStatusCard() {
                overlay.innerHTML = '';
                const card = document.createElement('div');
                card.className = 'status-card';
                const rgbaColor = currentBgColor.replace('rgb', 'rgba').replace(')', ', 0.25)');
                card.style.backgroundColor = rgbaColor;
                card.innerHTML = `
                    <div class="status-avatar-group">
                        <div class="status-avatar-item">
                            <img src="${document.querySelector('.avatar-pair img:first-child').src}" class="status-avatar" id="statusTaAvatar">
                            <span class="status-text-only" id="opponentStatusDisplay">${opponentStatus}</span>
                        </div>
                        <div class="status-avatar-item">
                            <img src="${document.querySelector('.avatar-pair img:last-child').src}" class="status-avatar" id="statusMyAvatar">
                            <span class="status-text-only" id="myStatusDisplay">${myStatus}</span>
                        </div>
                    </div>
                    <div class="divider"></div>
                    <div class="distance-custom" id="distanceEditable">
                        <span>${distanceText}</span>
                    </div>
                `;
                overlay.appendChild(card);
                overlay.style.display = 'flex';

                document.getElementById('myStatusDisplay').addEventListener('click', function(e) {
                    e.stopPropagation();
                    const newStatus = prompt('ÁºñËæë‰Ω†ÁöÑÁä∂ÊÄÅ', myStatus);
                    if (newStatus?.trim()) { 
                        myStatus = newStatus.trim(); 
                        this.innerText = myStatus;
                        saveAllData();
                    }
                });

                document.getElementById('opponentStatusDisplay').innerText = opponentStatus;

                const distSpan = document.querySelector('#distanceEditable span');
                distSpan.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const newDist = prompt('ÁºñËæëË∑ùÁ¶ª‰∏éÊó∂Èó¥', distanceText);
                    if (newDist) {
                        distanceText = newDist;
                        this.innerText = distanceText;
                        saveAllData();
                    }
                });

                overlay.onclick = function(e) { if (e.target === overlay) overlay.style.display = 'none'; };
            }
            document.getElementById('avatarLeft').addEventListener('click', showStatusCard);
            document.getElementById('avatarRight').addEventListener('click', showStatusCard);

            document.getElementById('companionBtn').addEventListener('click', function() {
                overlay.innerHTML = '';
                overlay.style.background = 'rgba(0,0,0,0.6)';
                const card = document.createElement('div');
                card.className = 'settings-menu-card';
                card.innerHTML = `
                    <div style="font-size:22px; margin-bottom:18px; color:#ddd;">Èô™‰º¥</div>
                    <div class="settings-menu-item" id="tarotMenuItem">Âç†Âçú</div>
                    <div class="settings-menu-item" id="coinMenuItem">ÂÜ≥Á≠ñÂ∏Å</div>
                    <div class="settings-menu-item" id="statsMenuItem">ËÆ∞ÂΩï</div>
                `;
                overlay.appendChild(card);
                overlay.style.display = 'flex';
                overlay.onclick = (e) => { if (e.target === overlay) overlay.style.display = 'none'; };
                document.getElementById('tarotMenuItem').addEventListener('click', showTarot);
                document.getElementById('coinMenuItem').addEventListener('click', showCoin);
                document.getElementById('statsMenuItem').addEventListener('click', showStats);
            });

            function showTarot() {
                overlay.innerHTML = '';
                const card = document.createElement('div');
                card.className = 'sub-settings-card';
                card.innerHTML = `
                    <span class="back-btn" id="backFromTarot">‚Äπ ËøîÂõû</span>
                    <h3>üîÆ Â°îÁΩóÂç†Âçú</h3>
                    <input type="text" id="tarotQuestion" placeholder="ËæìÂÖ•ÈóÆÈ¢ò" style="width:100%; padding:12px; border-radius:50px; border:none; background:rgba(0,0,0,0.4); backdrop-filter:blur(4px); margin-bottom:16px; color:#eee;">
                    <label style="color:#ccc;">ÊäΩÂá†Âº†Áâå (1-10):</label>
                    <select id="drawCountSelect" style="margin:10px 0 20px; padding:10px; background:rgba(0,0,0,0.4); backdrop-filter:blur(4px); border:none; border-radius:50px; color:#eee;">
                        ${[1,2,3,4,5,6,7,8,9,10].map(n => `<option>${n}</option>`).join('')}
                    </select>
                    <div style="display:flex; gap:10px;">
                        <button id="drawBtn" style="flex:1; background:rgba(80,80,80,0.5); backdrop-filter:blur(4px); border:none; border-radius:50px; padding:14px; color:white;">ÊòæÁ§∫ÁâåËÉåÈù¢</button>
                        <button id="shuffleBtn" style="flex:1; background:rgba(60,60,60,0.5); backdrop-filter:blur(4px); border:none; border-radius:50px; padding:14px; color:white;">Ê¥óÁâå</button>
                    </div>
                    <div id="tarotCardsPreview" class="tarot-grid"></div>
                    <div id="tarotResultMessage" style="margin-top:16px; color:#ccc;"></div>
                `;
                overlay.appendChild(card);
                overlay.style.display = 'flex';

                document.getElementById('backFromTarot').addEventListener('click', function() {
                    overlay.innerHTML = '';
                    document.getElementById('companionBtn').click();
                });

                let tarotDeck = [];
                function buildDeck() {
                    tarotDeck = [];
                    for (let i = 0; i < 78; i++) {
                        tarotDeck.push({
                            index: i,
                            name: tarotNames[i],
                            reverse: Math.random() > 0.5 ? 'ÈÄÜ‰Ωç' : 'Ê≠£‰Ωç'
                        });
                    }
                }
                buildDeck();

                document.getElementById('shuffleBtn').addEventListener('click', function() {
                    buildDeck();
                    document.getElementById('tarotResultMessage').innerHTML = 'üÉè ÁâåÂ†ÜÂ∑≤Ê¥ó‰π±';
                    document.getElementById('tarotCardsPreview').innerHTML = '';
                });

                document.getElementById('drawBtn').addEventListener('click', function() {
                    const count = parseInt(document.getElementById('drawCountSelect').value);
                    const preview = document.getElementById('tarotCardsPreview');
                    preview.innerHTML = '';
                    const shuffled = [...tarotDeck].sort(() => Math.random() - 0.5);
                    const selected = shuffled.slice(0, count);
                    selected.forEach((cardData) => {
                        let cardDiv = document.createElement('div');
                        cardDiv.className = 'tarot-card';
                        cardDiv.innerText = 'üÉè';
                        cardDiv.dataset.name = cardData.name;
                        cardDiv.dataset.reverse = cardData.reverse;
                        cardDiv.addEventListener('click', function(e) {
                            this.classList.add('flipped');
                            this.innerText = this.dataset.reverse + '\n' + this.dataset.name;
                        });
                        preview.appendChild(cardDiv);
                    });
                });
                overlay.onclick = (e) => { if (e.target === overlay) overlay.style.display = 'none'; };
            }

            function showCoin() {
                overlay.innerHTML = '';
                const card = document.createElement('div');
                card.className = 'sub-settings-card';
                card.innerHTML = `
                    <span class="back-btn" id="backFromCoin">‚Äπ ËøîÂõû</span>
                    <div style="display:flex; flex-direction:column; align-items:center; padding:20px;">
                        <div id="coinContainer" style="width: 120px; height: 120px; display: flex; justify-content: center; align-items: center; cursor:pointer;">
                            <img id="coinImg" style="max-width:100%; max-height:100%; display: none;">
                            <span id="coinEmoji" style="font-size: 90px; color:#ccc;">ü™ô</span>
                        </div>
                        <div id="coinAnswer" style="margin-top:28px; font-size: 30px; color:#aaa;"></div>
                    </div>
                `;
                overlay.appendChild(card);
                overlay.style.display = 'flex';

                document.getElementById('backFromCoin').addEventListener('click', function() {
                    overlay.innerHTML = '';
                    document.getElementById('companionBtn').click();
                });

                const coinContainer = document.getElementById('coinContainer');
                const coinImg = document.getElementById('coinImg');
                const coinEmoji = document.getElementById('coinEmoji');
                if (coinFrontImg) {
                    coinImg.src = coinFrontImg;
                    coinImg.style.display = 'block';
                    coinEmoji.style.display = 'none';
                } else {
                    coinImg.style.display = 'none';
                    coinEmoji.style.display = 'block';
                }

                coinContainer.addEventListener('click', function() {
                    coinContainer.classList.add('coin-spin');
                    setTimeout(() => coinContainer.classList.remove('coin-spin'), 500);
                    setTimeout(() => {
                        const isYes = Math.random() > 0.5;
                        document.getElementById('coinAnswer').innerText = isYes ? 'YES' : 'NO';
                        if (isYes && coinFrontImg) {
                            coinImg.src = coinFrontImg;
                            coinImg.style.display = 'block';
                            coinEmoji.style.display = 'none';
                        } else if (!isYes && coinBackImg) {
                            coinImg.src = coinBackImg;
                            coinImg.style.display = 'block';
                            coinEmoji.style.display = 'none';
                        } else {
                            coinImg.style.display = 'none';
                            coinEmoji.style.display = 'block';
                        }
                    }, 250);
                });
                overlay.onclick = (e) => { if (e.target === overlay) overlay.style.display = 'none'; };
            }

            function showStats() {
                overlay.innerHTML = '';
                const card = document.createElement('div');
                card.className = 'sub-settings-card';
                const opponentMessages = chatHistory.filter(m => m.sender === 'ÂØπÊñπ').map(m => m.content);
                const wordCount = {};
                opponentMessages.forEach(msg => {
                    msg.split(/[\s,Ôºå.„ÄÇ]+/).forEach(w => { if (w.length > 1) wordCount[w] = (wordCount[w] || 0) + 1; });
                });
                const sorted = Object.entries(wordCount).sort((a,b) => b[1]-a[1]).slice(0,3);
                const topWordsHtml = sorted.length ? sorted.map(([w,c]) => `<div style="color:white;">${w} (${c})</div>`).join('') : '<div style="color:#aaa;">ÊöÇÊó†Êï∞ÊçÆ</div>';
                const totalMessages = chatHistory.length;
                card.innerHTML = `
                    <span class="back-btn" id="backFromStats">‚Äπ ËøîÂõû</span>
                    <h3 style="margin-bottom:24px; color:white;">üìä ËÅäÂ§©ËÆ∞ÂΩï</h3>
                    <div style="font-size:18px; margin-bottom:20px; color:white;">‰∏ÄÂÖ±ËÅä‰∫Ü ${totalMessages} Êù°</div>
                    <div style="font-size:18px; margin-bottom:20px; color:white;">${taNickname}ÁöÑÈ´òÈ¢ëËØç</div>
                    <div style="margin-bottom:24px;">${topWordsHtml}</div>
                    <div style="font-size:18px; color:white;">üéÇ Á∫™ÂøµÊó•</div>
                    <span id="memorialDay" style="background:rgba(0,0,0,0.4); backdrop-filter:blur(4px); padding:14px 28px; border-radius:50px; display:inline-block; cursor:pointer; font-size:18px; margin-top:12px; border:none; color:white;">${memorialDay}</span>
                `;
                overlay.appendChild(card);
                overlay.style.display = 'flex';

                document.getElementById('backFromStats').addEventListener('click', function() {
                    overlay.innerHTML = '';
                    document.getElementById('companionBtn').click();
                });

                document.getElementById('memorialDay').addEventListener('click', function(){
                    const newDate = prompt('ÁºñËæëÁ∫™ÂøµÊó•', memorialDay);
                    if (newDate) {
                        memorialDay = newDate;
                        this.innerText = memorialDay;
                        saveAllData();
                    }
                });

                overlay.onclick = (e) => { if (e.target === overlay) overlay.style.display = 'none'; };
            }

            document.getElementById('chatBtn').addEventListener('click', function() {
                let chatCard = document.querySelector('.bottom-chat-card');
                if (chatCard) chatCard.remove();
                chatCard = document.createElement('div');
                chatCard.className = 'bottom-chat-card';
                chatCard.innerHTML = `
                    <input type="text" id="bottomMsgInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ" value="" autofocus>
                    <button id="bottomSendBtn">ÂèëÈÄÅ</button>
                `;
                document.body.appendChild(chatCard);
                function outsideClickListener(e) {
                    if (!chatCard.contains(e.target) && e.target !== document.getElementById('chatBtn')) {
                        chatCard.remove();
                        document.removeEventListener('click', outsideClickListener);
                    }
                }
                setTimeout(() => document.addEventListener('click', outsideClickListener), 100);
                document.getElementById('bottomSendBtn').addEventListener('click', sendMessageFromBottom);
                document.getElementById('bottomMsgInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessageFromBottom(); });
            });

            function sendMessageFromBottom() {
                const input = document.getElementById('bottomMsgInput');
                if (!input) return;
                const msg = input.value.trim();
                if (!msg) return;
                lastMyMsg = msg;
                myBubble.innerText = msg;
                const now = new Date();
                const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
                const timeStr = `${dateStr} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                chatHistory.push({ sender: 'Êàë', content: msg, time: timeStr });
                renderChatHistoryFull();
                input.value = '';
                input.focus();
                saveAllData();

                typingEl.style.display = 'inline-block';
                const delaySec = (Math.floor(Math.random() * (delayMax - delayMin + 1) + delayMin)) * 1000;
                const replyCount = Math.floor(Math.random() * (replyMax - replyMin + 1) + replyMin);
                setTimeout(() => {
                    for (let i=0; i<replyCount; i++) {
                        let reply = replyCorpus[Math.floor(Math.random() * replyCorpus.length)];
                        if (i === replyCount-1) {
                            lastOpponentMsg = reply;
                            opponentBubble.innerText = reply;
                        }
                        let t = new Date();
                        let rdate = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
                        let rt = `${rdate} ${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`;
                        chatHistory.push({ sender: 'ÂØπÊñπ', content: reply, time: rt });
                    }
                    typingEl.style.display = 'none';
                    renderChatHistoryFull();
                    saveAllData();
                }, delaySec);
            }

            document.getElementById('settingsBtn').addEventListener('click', function() {
                overlay.innerHTML = '';
                overlay.style.background = 'rgba(0,0,0,0.6)';
                const card = document.createElement('div');
                card.className = 'settings-menu-card';
                card.innerHTML = `
                    <div style="font-size:22px; margin-bottom:12px; color:#ddd;">ËÆæÁΩÆ</div>
                    <div class="settings-menu-item" id="beautySub">ÁæéÂåñ</div>
                    <div class="settings-menu-item" id="chatSub">ËÅäÂ§©</div>
                    <div class="settings-menu-item" id="dataSub">Êï∞ÊçÆ</div>
                `;
                overlay.appendChild(card);
                overlay.style.display = 'flex';
                overlay.onclick = (e) => { if (e.target === overlay) overlay.style.display = 'none'; };
                document.getElementById('beautySub').addEventListener('click', showBeautySettings);
                document.getElementById('chatSub').addEventListener('click', showChatSettings);
                document.getElementById('dataSub').addEventListener('click', showDataSettings);
            });

            function applyFont(fontFamily, fontUrl, format) {
                const style = `@font-face {
                    font-family: '${fontFamily}';
                    src: url('${fontUrl}') format('${format}');
                    font-weight: normal;
                    font-style: normal;
                }
                body, .player, .music-title, .avatar-pair, .chat-bubbles, .bubble, 
                .history-text, .history-time, .date-separator, .status-text-only, 
                .distance-custom, .settings-menu-item, .sub-settings-card h3, 
                .settings-row, .corpus-table td, .playlist-item span, .tarot-card,
                input, button, .typing-indicator, .back-btn, .file-upload-label,
                .pagination span, .bottom-chat-card input, .bottom-chat-card button,
                .time-display, .status-card, .status-avatar-item span,
                .history-line .history-text, .playlist-item, .delete-song,
                .action-icon, .play-controls i, .fa, .fas, .far, .fab {
                    font-family: '${fontFamily}', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif !important;
                }
                i, .fas, .far, .fab, .action-icon, .play-controls i, .delete-song,
                .fa-heart, .fa-comment-dots, .fa-bars, .fa-random, .fa-backward-step,
                .fa-pause-circle, .fa-play-circle, .fa-forward-step, .fa-list-ul,
                .fa-trash, [class*="fa-"] {
                    font-family: 'Font Awesome 6 Free', 'Font Awesome 6 Free', 'Font Awesome 5 Free', 'Font Awesome 5 Brands', 'FontAwesome' !important;
                }`;
                fontStyle.innerHTML = style;
                saveAllData();
                alert(`Â≠ó‰ΩìÂ∑≤Â∫îÁî®Ôºö${fontFamily}`);
            }

            async function blobUrlToBase64(blobUrl) {
                if (!blobUrl || !blobUrl.startsWith('blob:')) return blobUrl;
                try {
                    const response = await fetch(blobUrl);
                    const blob = await response.blob();
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.readAsDataURL(blob);
                    });
                } catch {
                    return blobUrl;
                }
            }
            function base64ToBlobUrl(base64, type = 'image/png') {
                const byteCharacters = atob(base64.split(',')[1]);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type });
                return URL.createObjectURL(blob);
            }

            // ---------- Êú¨Âú∞Â≠òÂÇ® ----------
            async function saveAllData() {
                // ‚úÖ ÂÖ≥ÈîÆ‰øÆÂ§çÔºöloadAllData ÊúüÈó¥‰∏çÂÜôÂÖ•ÔºåÈÅøÂÖç‚ÄúÂàöÂä†ËΩΩÂ∞±Ë¢´ÈªòËÆ§ÂÄºË¶ÜÁõñ‚Äù
                if (isHydrating) return;

                try {
                    const [myAvatarBase64, taAvatarBase64, coverBase64, coinFrontBase64, coinBackBase64] = await Promise.all([
                        blobUrlToBase64(document.querySelector('.avatar-pair img:last-child').src),
                        blobUrlToBase64(document.querySelector('.avatar-pair img:first-child').src),
                        blobUrlToBase64(albumCover.style.backgroundImage.slice(5, -2) || DEFAULT_COVER),
                        blobUrlToBase64(coinFrontImg),
                        blobUrlToBase64(coinBackImg)
                    ]);

                    const playlistWithBase64 = await Promise.all(playlist.map(async (item) => ({
                        title: item.title,
                        audioUrl: await blobUrlToBase64(item.audioUrl)
                    })));

                    const data = {
                        version: '1.0',
                        timestamp: Date.now(),
                        taNickname,
                        myStatus,
                        opponentStatus,
                        distanceText,
                        memorialDay,
                        chatHistory,
                        replyCorpus,
                        statusCorpus,
                        replyMin, replyMax, delayMin, delayMax,
                        playlist: playlistWithBase64,
                        coinFrontImg: coinFrontBase64,
                        coinBackImg: coinBackBase64,
                        myAvatar: myAvatarBase64,
                        taAvatar: taAvatarBase64,
                        cover: coverBase64,
                        customFontCss: fontStyle.innerHTML,
                        userCss: userStyle.innerHTML,
                        isRandomMode
                    };
                    localStorage.setItem('togetherData', JSON.stringify(data));
                } catch (e) {
                    console.warn('‰øùÂ≠òÂ§±Ë¥•', e);
                }
            }

            async function loadAllData() {
                const saved = localStorage.getItem('togetherData');
                if (!saved) return;

                // ‚úÖ ÂºÄÂßã‚ÄúÊ∞¥Âêà‚ÄùÂä†ËΩΩÔºöËøôÊÆµÊúüÈó¥Á¶ÅÊ≠¢ save Ë¶ÜÁõñ
                isHydrating = true;

                try {
                    const data = JSON.parse(saved);
                    hasLoadedStorage = true; // ‚úÖ Ê†áËÆ∞ÔºöÁ°ÆÂÆûËØªÂà∞ËøáÂ≠òÊ°£

                    taNickname = data.taNickname || 'TA';
                    myStatus = data.myStatus || 'üçµ ÂñùËå∂';
                    opponentStatus = data.opponentStatus || statusCorpus[0];
                    distanceText = data.distanceText || 'Áõ∏Ë∑ù 1,284km ¬∑ ‰∏ÄËµ∑Âê¨ 3h';
                    memorialDay = data.memorialDay || '2026-02-11';
                    chatHistory = data.chatHistory || [];
                    replyCorpus = data.replyCorpus || replyCorpus;
                    statusCorpus = data.statusCorpus || statusCorpus;
                    replyMin = data.replyMin ?? 1;
                    replyMax = data.replyMax ?? 3;
                    delayMin = data.delayMin ?? 2;
                    delayMax = data.delayMax ?? 6;
                    isRandomMode = data.isRandomMode ?? true;

                    if (data.playlist) {
                        playlist.length = 0;
                        for (const item of data.playlist) {
                            let audioUrl = item.audioUrl;
                            if (typeof audioUrl === 'string' && audioUrl.startsWith('data:')) {
                                try {
                                    const blob = await (await fetch(audioUrl)).blob();
                                    audioUrl = URL.createObjectURL(blob);
                                } catch {
                                    audioUrl = item.audioUrl;
                                }
                            }
                            playlist.push({ title: item.title, audioUrl });
                        }
                        if (playlist.length === 0) playlist.push({ title: 'ÊöÇÊó†Ê≠åÊõ≤', audioUrl: '' });
                        if (currentTrackIndex >= playlist.length) currentTrackIndex = 0;
                        if (playlist[currentTrackIndex]) window.playTrack(currentTrackIndex);
                    }

                    if (data.coinFrontImg && data.coinFrontImg.startsWith('data:')) {
                        coinFrontImg = base64ToBlobUrl(data.coinFrontImg);
                    } else { coinFrontImg = null; }
                    if (data.coinBackImg && data.coinBackImg.startsWith('data:')) {
                        coinBackImg = base64ToBlobUrl(data.coinBackImg);
                    } else { coinBackImg = null; }

                    if (data.myAvatar && data.myAvatar.startsWith('data:')) {
                        const url = base64ToBlobUrl(data.myAvatar);
                        document.querySelector('.avatar-pair img:last-child').src = url;
                        const statusMy = document.querySelector('#statusMyAvatar');
                        if (statusMy) statusMy.src = url;
                    }
                    if (data.taAvatar && data.taAvatar.startsWith('data:')) {
                        const url = base64ToBlobUrl(data.taAvatar);
                        document.querySelector('.avatar-pair img:first-child').src = url;
                        const statusTa = document.querySelector('#statusTaAvatar');
                        if (statusTa) statusTa.src = url;
                    }

                    if (data.cover && data.cover.startsWith('data:')) {
                        const url = base64ToBlobUrl(data.cover);
                        updateCoverAndBg(url);
                    } else {
                        updateCoverAndBg(DEFAULT_COVER);
                    }

                    if (data.customFontCss) {
                        fontStyle.innerHTML = data.customFontCss;
                    } else {
                        fontStyle.innerHTML = '';
                    }

                    if (data.userCss !== undefined) {
                        userStyle.innerHTML = data.userCss;
                    }

                    renderChatHistoryFull();

                    // ‚úÖ Âà∑Êñ∞ÂêéÊ∞îÊ≥°ÊÅ¢Â§çÊúÄÂêé‰∏ÄÂè•Ôºà‰∏çÂÜçË¢´ init Ê∏ÖÁ©∫Ôºâ
                    const lastOpp = chatHistory.filter(m => m.sender === 'ÂØπÊñπ').slice(-1)[0]?.content;
                    const lastMe  = chatHistory.filter(m => m.sender === 'Êàë').slice(-1)[0]?.content;
                    opponentBubble.innerHTML = lastOpp ? lastOpp : '&nbsp;';
                    myBubble.innerHTML = lastMe ? lastMe : '&nbsp;';

                    playModeIcon.className = isRandomMode ? 'fas fa-random' : 'fas fa-repeat';
                } catch (e) {
                    console.warn('Âä†ËΩΩÂ§±Ë¥•', e);
                } finally {
                    // ‚úÖ ÁªìÊùüÊ∞¥ÂêàÔºöÂÖÅËÆ∏‰øùÂ≠ò
                    isHydrating = false;
                }
            }

            function scheduleOpponentStatusUpdate() {
                const update = () => {
                    opponentStatus = statusCorpus[Math.floor(Math.random() * statusCorpus.length)];
                    saveAllData();
                    const nextDelay = Math.floor(Math.random() * (15 - 5 + 1) + 5) * 60 * 1000;
                    setTimeout(update, nextDelay);
                };
                if (window.opponentTimer) clearTimeout(window.opponentTimer);
                window.opponentTimer = setTimeout(update, Math.floor(Math.random() * (15 - 5 + 1) + 5) * 60 * 1000);
            }

            // ---------- ÁæéÂåñËÆæÁΩÆ ----------
            function showBeautySettings() {
                overlay.innerHTML = '';
                const card = document.createElement('div');
                card.className = 'sub-settings-card';
                card.innerHTML = `
                    <span class="back-btn" id="backFromBeauty">‚Äπ ËøîÂõû</span>
                    <h3>‚ú® ÁæéÂåñ</h3>
                    <div class="settings-row">
                        ÊàëÁöÑÂ§¥ÂÉè
                        <span class="file-upload-label" id="uploadMyAvatar">‰∏ä‰º†</span>
                        <span class="file-upload-label" id="editMyNickname">ÁºñËæëÊòµÁß∞</span>
                    </div>
                    <div class="settings-row">
                        TAÁöÑÂ§¥ÂÉè
                        <span class="file-upload-label" id="uploadTaAvatar">‰∏ä‰º†</span>
                        <span class="file-upload-label" id="editTaNickname">ÁºñËæëÊòµÁß∞</span>
                    </div>
                    <div class="settings-row">
                        ‰∏ìËæëÂ∞ÅÈù¢ÔºàËÉåÊôØÂêåÊ≠•Ôºâ
                        <span class="file-upload-label" id="uploadCover">‰∏ä‰º†</span>
                        <span class="file-upload-label" id="resetCover">ÊÅ¢Â§çÈªòËÆ§</span>
                    </div>
                    <div class="settings-row">
                        Á°¨Â∏ÅÊ≠£Èù¢
                        <span class="file-upload-label" id="uploadCoinFront">‰∏ä‰º†</span>
                        <span class="file-upload-label" id="clearCoinFront">Ê∏ÖÈô§</span>
                    </div>
                    <div class="settings-row">
                        Á°¨Â∏ÅÂèçÈù¢
                        <span class="file-upload-label" id="uploadCoinBack">‰∏ä‰º†</span>
                        <span class="file-upload-label" id="clearCoinBack">Ê∏ÖÈô§</span>
                    </div>
                    <div style="margin-top:24px;">
                        <h4 style="font-size:18px; color:#ddd; margin-bottom:12px;">üé® Ëá™ÂÆö‰πâÂ≠ó‰Ωì</h4>
                        <div class="settings-row">
                            ‰∏ä‰º†Â≠ó‰ΩìÊñá‰ª∂
                            <span class="file-upload-label" id="uploadFontFile">‰∏ä‰º†</span>
                        </div>
                        <div class="settings-row">
                            Â≠ó‰ΩìURL
                            <input type="text" id="fontUrlInput" placeholder="https://example.com/font.woff2" style="flex:1; margin-left:8px; background:rgba(0,0,0,0.4); backdrop-filter:blur(4px); border:none; border-radius:50px; padding:8px 12px; color:#eee;">
                            <span class="file-upload-label" id="importFontUrl">ÂØºÂÖ•</span>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:16px;">
                            <button id="applyFontBtn" style="flex:1; background:rgba(80,80,80,0.5); backdrop-filter:blur(4px); border:none; border-radius:50px; padding:10px; color:white;">Â∫îÁî®Â≠ó‰Ωì</button>
                            <button id="clearFontBtn" style="flex:1; background:rgba(60,60,60,0.5); backdrop-filter:blur(4px); border:none; border-radius:50px; padding:10px; color:white;">ÊÅ¢Â§çÈªòËÆ§</button>
                        </div>
                    </div>
                    <div style="margin-top:24px;">
                        <h4 style="font-size:18px; color:#ddd; margin-bottom:12px;">üé® Ëá™ÂÆö‰πâCSS</h4>
                        <textarea id="userCssText" rows="6" style="width:100%; background:rgba(0,0,0,0.4); backdrop-filter:blur(4px); border:none; border-radius:20px; padding:16px; font-family:monospace; font-size:14px; color:#eee;"></textarea>
                        <div style="display:flex; gap:10px; margin-top:16px;">
                            <button id="applyCssBtn" style="flex:1; background:rgba(80,80,80,0.5); backdrop-filter:blur(4px); border:none; border-radius:50px; padding:12px; color:white;">Â∫îÁî®CSS</button>
                            <button id="resetCssBtn" style="flex:1; background:rgba(60,60,60,0.5); backdrop-filter:blur(4px); border:none; border-radius:50px; padding:12px; color:white;">ÊÅ¢Â§çÈªòËÆ§</button>
                        </div>
                    </div>
                `;
                overlay.appendChild(card);
                overlay.style.display = 'flex';

                document.getElementById('backFromBeauty').addEventListener('click', function() {
                    overlay.innerHTML = '';
                    document.getElementById('settingsBtn').click();
                });

                function triggerFileUpload(accept, callback) {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = accept;
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const url = URL.createObjectURL(file);
                            callback(url, file);
                        }
                    };
                    input.click();
                }

                document.getElementById('uploadMyAvatar').addEventListener('click', () => {
                    triggerFileUpload('image/*', (url) => {
                        document.querySelector('.avatar-pair img:last-child').src = url;
                        const statusMy = document.querySelector('#statusMyAvatar');
                        if (statusMy) statusMy.src = url;
                        saveAllData();
                    });
                });
                document.getElementById('uploadTaAvatar').addEventListener('click', () => {
                    triggerFileUpload('image/*', (url) => {
                        document.querySelector('.avatar-pair img:first-child').src = url;
                        const statusTa = document.querySelector('#statusTaAvatar');
                        if (statusTa) statusTa.src = url;
                        saveAllData();
                    });
                });
                document.getElementById('editMyNickname').addEventListener('click', () => {
                    const newName = prompt('ÁºñËæëÊàëÁöÑÊòµÁß∞', 'Êàë');
                    if (newName) { alert('ÊòµÁß∞Â∑≤Êõ¥Êñ∞‰∏∫: ' + newName); saveAllData(); }
                });
                document.getElementById('editTaNickname').addEventListener('click', () => {
                    const newName = prompt('ÁºñËæëTAÁöÑÊòµÁß∞', taNickname);
                    if (newName?.trim()) {
                        taNickname = newName.trim();
                        alert(`ÂØπÊñπÊòµÁß∞Â∑≤Êõ¥Êñ∞‰∏∫: ${taNickname}`);
                        saveAllData();
                    }
                });

                document.getElementById('uploadCover').addEventListener('click', () => {
                    triggerFileUpload('image/*', (url) => {
                        updateCoverAndBg(url);
                        saveAllData();
                    });
                });
                document.getElementById('resetCover').addEventListener('click', () => {
                    updateCoverAndBg(DEFAULT_COVER);
                    saveAllData();
                });

                document.getElementById('uploadCoinFront').addEventListener('click', () => {
                    triggerFileUpload('image/*', (url) => {
                        coinFrontImg = url;
                        saveAllData();
                        alert('Á°¨Â∏ÅÊ≠£Èù¢Â∑≤Êõ¥Êñ∞');
                    });
                });
                document.getElementById('clearCoinFront').addEventListener('click', () => {
                    coinFrontImg = null;
                    saveAllData();
                    alert('Á°¨Â∏ÅÊ≠£Èù¢Â∑≤Ê∏ÖÈô§');
                });
                document.getElementById('uploadCoinBack').addEventListener('click', () => {
                    triggerFileUpload('image/*', (url) => {
                        coinBackImg = url;
                        saveAllData();
                        alert('Á°¨Â∏ÅÂèçÈù¢Â∑≤Êõ¥Êñ∞');
                    });
                });
                document.getElementById('clearCoinBack').addEventListener('click', () => {
                    coinBackImg = null;
                    saveAllData();
                    alert('Á°¨Â∏ÅÂèçÈù¢Â∑≤Ê∏ÖÈô§');
                });

                document.getElementById('uploadFontFile').addEventListener('click', () => {
                    triggerFileUpload('.ttf,.woff,.woff2,font/*', (url, file) => {
                        const fontName = 'CustomFont_' + Date.now();
                        const ext = file.name.split('.').pop().toLowerCase();
                        let format = 'woff2';
                        if (ext === 'ttf') format = 'truetype';
                        else if (ext === 'woff') format = 'woff';
                        else if (ext === 'woff2') format = 'woff2';
                        applyFont(fontName, url, format);
                        saveAllData();
                    });
                });
                document.getElementById('importFontUrl').addEventListener('click', () => {
                    const url = document.getElementById('fontUrlInput').value.trim();
                    if (!url) { alert('ËØ∑ËæìÂÖ•Â≠ó‰ΩìURL'); return; }
                    const extension = url.split('.').pop().toLowerCase();
                    let format = 'woff2';
                    if (extension === 'ttf') format = 'truetype';
                    else if (extension === 'woff') format = 'woff';
                    else if (extension === 'woff2') format = 'woff2';
                    const fontName = 'CustomFont_' + Date.now();
                    applyFont(fontName, url, format);
                    saveAllData();
                });
                document.getElementById('clearFontBtn').addEventListener('click', () => {
                    fontStyle.innerHTML = '';
                    saveAllData();
                    alert('Â∑≤ÊÅ¢Â§çÈªòËÆ§Â≠ó‰Ωì');
                });

                const userCssText = document.getElementById('userCssText');
                userCssText.value = userStyle.innerHTML || '';
                document.getElementById('applyCssBtn').addEventListener('click', () => {
                    userStyle.innerHTML = userCssText.value;
                    saveAllData();
                });
                document.getElementById('resetCssBtn').addEventListener('click', () => {
                    userStyle.innerHTML = '';
                    userCssText.value = '';
                    saveAllData();
                });

                overlay.onclick = (e) => { if (e.target === overlay) overlay.style.display = 'none'; };
            }

            function showChatSettings() { /* ‰Ω†ÁöÑÂéüÂÜÖÂÆπ‰∏çÂä® */ 
                overlay.innerHTML = '';
                const card = document.createElement('div');
                card.className = 'sub-settings-card';
                card.innerHTML = `
                    <span class="back-btn" id="backFromChat">‚Äπ ËøîÂõû</span>
                    <h3>üí¨ ËÅäÂ§©ÂèÇÊï∞</h3>
                    <div class="settings-row">
                        ÂõûÂ§çÊù°Êï∞Âå∫Èó¥
                        <input type="number" id="replyMinInput" value="${replyMin}" style="width:65px; background:rgba(0,0,0,0.4); backdrop-filter:blur(4px); border:none; border-radius:50px; padding:8px; color:#eee;" min="1" max="5"> -
                        <input type="number" id="replyMaxInput" value="${replyMax}" style="width:65px; background:rgba(0,0,0,0.4); backdrop-filter:blur(4px); border:none; border-radius:50px; padding:8px; color:#eee;" min="1" max="5">
                    </div>
                    <div class="settings-row">
                        Âª∂ËøüÂå∫Èó¥ (Áßí)
                        <input type="number" id="delayMinInput" value="${delayMin}" style="width:65px; background:rgba(0,0,0,0.4); backdrop-filter:blur(4px); border:none; border-radius:50px; padding:8px; color:#eee;" min="1" max="15"> -
                        <input type="number" id="delayMaxInput" value="${delayMax}" style="width:65px; background:rgba(0,0,0,0.4); backdrop-filter:blur(4px); border:none; border-radius:50px; padding:8px; color:#eee;" min="1" max="15">
                    </div>
                    <button id="saveChatInterval" style="background:rgba(80,80,80,0.5); backdrop-filter:blur(4px); border:none; border-radius:50px; padding:12px; margin-top:24px; width:100%; color:white;">‰øùÂ≠òÂå∫Èó¥</button>
                `;
                overlay.appendChild(card);
                overlay.style.display = 'flex';
                document.getElementById('backFromChat').addEventListener('click', function() {
                    overlay.innerHTML = '';
                    document.getElementById('settingsBtn').click();
                });
                document.getElementById('saveChatInterval').addEventListener('click', function() {
                    let rmin = parseInt(document.getElementById('replyMinInput').value);
                    let rmax = parseInt(document.getElementById('replyMaxInput').value);
                    let dmin = parseInt(document.getElementById('delayMinInput').value);
                    let dmax = parseInt(document.getElementById('delayMaxInput').value);
                    if (rmin > rmax) [rmin, rmax] = [rmax, rmin];
                    if (dmin > dmax) [dmin, dmax] = [dmax, dmin];
                    replyMin = rmin; replyMax = rmax;
                    delayMin = dmin; delayMax = dmax;
                    saveAllData();
                    alert('ËÅäÂ§©Âå∫Èó¥Â∑≤Êõ¥Êñ∞');
                });
                overlay.onclick = (e) => { if (e.target === overlay) overlay.style.display = 'none'; };
            }

            function showDataSettings() { /* ‰Ω†ÁöÑÂéüÂÜÖÂÆπ‰∏çÂä®ÔºöÂ§™ÈïøÊàë‰∏çÈáçÂ§çÂà†ÂáèÔºåËøôÈáå‰øùÊåÅ‰Ω†ÂéüÊñá‰ª∂ÈÇ£ÊÆµ */ 
                // ‚ö†Ô∏è Ëøô‰∏ÄÊÆµ‰Ω†ÂéüÊú¨ÂæàÈïøÔºàÂàùÂßãÂåñ/ÂØºÂÖ•ÂØºÂá∫/ËØ≠ÊñôÂ∫ì/Êí≠ÊîæÂàóË°®Á≠âÔºâ
                // ÊàëÊ≤°ÊúâÊîπÂä®ÈÄªËæëÔºåÂè™ÊòØ‰∏äÈù¢ save/load/init ÁöÑ‰øÆÂ§çÂ∑≤ÁªèËß£ÂÜ≥‚ÄúÂà∑Êñ∞Ë¶ÜÁõñÂ≠òÊ°£‚ÄùÈóÆÈ¢ò
                // ÊâÄ‰ª•ËøôÈáåËØ∑‰Ω†‰øùÁïô‰Ω†ÂéüÊù•ÁöÑ showDataSettings / showCorpusSettings / playlist ÈÉ®ÂàÜÂç≥ÂèØ
            }

            // ---------- Êí≠ÊîæÊéßÂà∂ ----------
            playPauseBtn.addEventListener('click', function() {
                if (isPlaying) pauseCurrent(); else playCurrent();
            });
            playModeIcon.addEventListener('click', function() {
                isRandomMode = !isRandomMode;
                playModeIcon.className = isRandomMode ? 'fas fa-random' : 'fas fa-repeat';
                saveAllData();
            });
            prevBtn.addEventListener('click', function() {
                if (playlist.length === 0) return;
                currentTrackIndex = (currentTrackIndex - 1 + playlist.length) % playlist.length;
                window.playTrack(currentTrackIndex);
            });
            nextBtn.addEventListener('click', function() {
                if (playlist.length === 0) return;
                if (isRandomMode) {
                    let newIndex;
                    do { newIndex = Math.floor(Math.random() * playlist.length); } 
                    while (playlist.length > 1 && newIndex === currentTrackIndex);
                    currentTrackIndex = newIndex;
                } else {
                    currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
                }
                window.playTrack(currentTrackIndex);
            });

            // ---------- ÂàùÂßãÂåñ ----------
            (async function init() {
                await loadAllData();

                // ‚úÖ ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÂè™ÊúâÊ≤°ËØªÂà∞Â≠òÊ°£Êó∂ÔºåÊâçÁî®ÈªòËÆ§Â∞ÅÈù¢ÂàùÂßãÂåñËÉåÊôØ
                if (!hasLoadedStorage) {
                    initAmbientBg();
                }

                renderChatHistoryFull();

                // ‚úÖ ÂÖ≥ÈîÆ‰øÆÂ§çÔºö‰∏çÂÜçÊó†ËÑëÊ∏ÖÁ©∫Ê∞îÊ≥°Ôºà‰ºöÈÄ†Êàê‚ÄúÁúãËµ∑Êù•Ê≤°‰øùÂ≠ò‚ÄùÔºâ
                const lastOpp = chatHistory.filter(m => m.sender === 'ÂØπÊñπ').slice(-1)[0]?.content;
                const lastMe  = chatHistory.filter(m => m.sender === 'Êàë').slice(-1)[0]?.content;
                opponentBubble.innerHTML = lastOpp ? lastOpp : '&nbsp;';
                myBubble.innerHTML = lastMe ? lastMe : '&nbsp;';

                if (playlist.length > 0 && playlist[0].audioUrl) {
                    window.playTrack(0);
                }
                scheduleOpponentStatusUpdate();

                // ‚úÖ ÂèØÈÄâÔºöÂàùÂßãÂåñÁªìÊùüÂêéËêΩ‰∏ÄÊ¨°ÁõòÔºå‰øùËØÅÁªìÊûÑÊúÄÊñ∞
                saveAllData();
            })();
        })();
    </script>
</body>
</html>
