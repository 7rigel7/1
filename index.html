<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#ffffff">
<meta name="color-scheme" content="light dark">
<link rel="manifest" href="manifest.json">
<title>我的珍藏 - 全屏透明版</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
    :root {
        --active-color: #333; --bg-color: #f5f5f5; --card-bg: #fff;
        --text-main: #333; --text-sub: #999;
        --nav-height: 50px;
        --default-font: -apple-system, BlinkMacSystemFont, "PingFang SC", "Helvetica Neue", Arial, sans-serif;
        --bottom-bar-bg: #fff;
        --post-card-bg: #fff;
        --safe-top: env(safe-area-inset-top, 15px);
        --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    
    html { 
    font-size: var(--app-font-size, 13.5px); 
    width: 100%; 
    height: 100%; 
    overflow: hidden; 
    -webkit-text-size-adjust: 100%; 
    background-color: transparent;   /* 新增 */
}
body { 
    width: 100%; 
    height: 100%; 
    overflow: hidden; 
    background-color: transparent;   /* 新增，双保险 */
}
    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
        font-size: 1rem;
        font-family: var(--app-font, var(--default-font)) !important;
        background-color: transparent; color: var(--text-main);
        -webkit-user-select: none; user-select: none; line-height: 1.5;
    }
    
    #global-bg-layer { 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    z-index: 0;              /* 这里改了 */
    background-color: var(--bg-color); 
    background-size: cover; 
    background-position: center; 
    pointer-events: none; 
}
    
    /* 视图系统 */
    .view-container { position: relative; width: 100%; height: 100%; overflow: hidden; }
    /* 优化后的视图系统：支持顺滑过渡 */
            .view { 
        position: absolute; 
        top: 0; left: 0; width: 100%; height: 100%; 
        overflow-y: auto; overflow-x: hidden; 
        background: transparent; 
        padding-bottom: calc(60px + var(--safe-bottom)); 
        opacity: 0; 
        /* 关键：用 visibility 配合淡入淡出动画 */
        visibility: hidden;
        transition: opacity 0.25s ease-out; 
        z-index: 10; 
    }
    .view.active { 
        opacity: 1; 
        visibility: visible; 
        z-index: 20; 
    }
/* 添加进入和离开动画 */
.view.leaving {
    opacity: 0;
    transform: translateX(-20px);
}
.view.entering {
    opacity: 0;
    transform: translateX(20px);
}
    
    #view-editor, #view-collection-create { background: #fff; padding-bottom: 0; z-index: 2000; display: none; flex-direction: column; height: 100%; }
    #view-editor.active, #view-collection-create.active { display: flex; opacity: 1; }
    #view-html-detail { background: #fff; padding: 0; margin: 0; z-index: 3000; display: none; width: 100%; height: 100%; overflow-y: auto; }
    #view-html-detail.active { display: block; }
    #view-collection-detail { background: transparent; padding-bottom: 0; z-index: 2000; }
    #view-html-home { 
        background: transparent; 
        padding-top: 0; /* 把这里的 padding-top 删掉或者设为 0 */
    }
    
    #view-detail { 
        background: var(--post-card-bg); background-size: cover; background-position: center; 
        background-repeat: no-repeat; background-attachment: scroll; 
        padding-bottom: 80px; z-index: 2000; transition: background-image 0.3s; width: 100%; 
    }

    /* 通用组件 */
    .icon { width: 22px; height: 22px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
    .hidden-input { display: none; }
    .loading-mask { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index: 9999; display:none; flex-direction:column; justify-content:center; align-items:center; color:#333; font-weight:bold; }
    .loading-spinner { width: 36px; height: 36px; border: 3px solid #f3f3f3; border-top: 3px solid var(--active-color); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #scroll-sentinel { height: 20px; width: 100%; opacity: 0; pointer-events: none; }
    
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4000; display: none; align-items: center; justify-content: center; }
    .context-menu { background: #fff; width: 80%; border-radius: 12px; overflow: hidden; animation: popUp 0.2s ease-out; max-height: 80vh; overflow-y: auto; }
    .menu-item { padding: 14px; text-align: center; border-bottom: 1px solid #eee; font-size: 1.04rem; color: #333; display: flex; justify-content: center; align-items: center; position: relative; }
    .menu-item.danger { color: #ff4d4f; }
    .menu-item.active { color: var(--active-color); font-weight: bold; background: #f7f7f7; }
    .menu-section-title { background: #f9f9f9; color: #999; font-size: 0.81rem; padding: 8px 15px; font-weight: bold; text-align: left; border-bottom: 1px solid #eee; }
    @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .image-viewer-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; display: none; flex-direction: column; justify-content: center; align-items: center; animation: fadeIn 0.2s ease; }
    .iv-img-wrapper { width: 100%; height: 80%; display: flex; justify-content: center; align-items: center; }
    .iv-img-wrapper img { max-width: 100%; max-height: 100%; object-fit: contain; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    .iv-controls { position: absolute; bottom: calc(40px + var(--safe-bottom)); display: flex; gap: 20px; }
    .iv-btn { background: rgba(255,255,255,0.2); color: #fff; padding: 8px 20px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(10px); cursor: pointer; font-size: 0.96rem; font-weight: bold; display: flex; align-items: center; gap: 5px; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* 底部导航 (应用底部背景) */
    .bottom-bar { 
        position: fixed; bottom: 0; left: 0; width: 100%; 
        height: calc(var(--nav-height) + var(--safe-bottom)); 
        padding-bottom: var(--safe-bottom); 
        background: var(--bottom-bar-bg); 
        background-size: cover; background-position: center; 
        backdrop-filter: blur(10px); 
        border-top: 1px solid rgba(0,0,0,0.05); 
        display: flex; justify-content: space-around; align-items: center; 
        z-index: 1000; transition: transform 0.3s ease; 
    }
    .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; width: 20%; height: 100%; cursor: pointer; }
    .nav-item.active { color: var(--text-main); }
    .custom-nav-icon { width: 24px; height: 24px; border-radius: 6px; object-fit: cover; margin-bottom: 2px; }
    .nav-icon-plus { background: transparent; color: var(--text-main); width: 36px; height: 100%; display: flex; align-items: center; justify-content: center; box-shadow: none; border-radius: 0; }
    .nav-icon-plus svg { width: 28px; height: 28px; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; fill: none; }

    .batch-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: calc(50px + var(--safe-bottom)); padding-bottom: var(--safe-bottom); background: #fff; display: none; justify-content: space-around; align-items: center; z-index: 2100; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); border-top: 1px solid #eee; }
    body.batch-mode .batch-bar { display: flex; animation: slideUp 0.3s ease; }
    body.batch-mode .bottom-bar { display: none; }
    body.batch-mode .post-card { transform: scale(0.95); opacity: 0.8; cursor: pointer; transition: all 0.2s; }
    body.batch-mode .post-card.selected { transform: scale(1); opacity: 1; box-shadow: 0 0 0 3px var(--active-color); }
    body.batch-mode .post-card.selected::after { content: '✓'; position: absolute; top: 10px; right: 10px; background: var(--active-color); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight:bold; z-index: 5; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    /* Home Header (全透明修改) */
    .home-header { 
        position: sticky; 
        top: 0; 
        z-index: 50; 
        background: transparent; 
        padding: calc(12px + var(--safe-top)) 15px 10px 15px; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
    }

    /* 搜索框保留微弱背景，防止看不见 */
    .search-box { 
        background: rgba(255,255,255, 0.3); 
        border-radius: 18px; padding: 5px 12px; display: flex; align-items: center; flex: 1; margin-right: 10px; 
        backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); 
    }
    .search-box input { border: none; background: transparent; font-size: 0.96rem; width: 100%; color: #333; }
    
    .posts-container { padding: 12px; transition: all 0.3s ease; min-height: 300px; display: block; }

    /* 瀑布流双列布局系统 */
    .waterfall-container { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
    .waterfall-col { flex: 1; width: 48%; display: flex; flex-direction: column; gap: 10px; }

    /* 卡片 */
    .post-card { 
        background: var(--post-card-bg); 
        background-size: cover; background-position: center; background-repeat: no-repeat; background-attachment: scroll !important; 
        border-radius: 10px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
        position: relative; transition: transform 0.1s; 
        content-visibility: auto; contain-intrinsic-size: 300px; width: 100%; 
    }
    .post-card:active { transform: scale(0.98); }
    .post-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px 6px; }
    .post-date { display: flex; align-items: baseline; gap: 4px; }
    .date-day { font-size: 1.48rem; font-weight: 600; color: #333; line-height: 1; }
    .date-info { font-size: 0.81rem; color: #999; }
    .post-content-wrap { padding: 8px 12px 12px; }
    .post-title { font-size: 1.11rem; font-weight: 600; color: #333; line-height: 1.4; margin-bottom: 6px; }
    .post-text { font-size: 0.96rem; color: #555; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;}
    .pin-mark { position: absolute; top: 8px; right: 10px; width: 16px; height: 16px; display: none; z-index: 5; color: #666; }
    .pin-mark svg { width: 100%; height: 100%; fill: none; stroke: currentColor; stroke-width: 3; stroke-linecap: round; stroke-linejoin: round; }
    .is-top .pin-mark { display: block; }
    
    /* 标签容器 */
.post-tags {
    display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px;
}
.d-tags {
    display: flex; flex-wrap: wrap; gap: 5px; padding: 10px 20px;
}
    
    /* 模式区分 */
    .posts-container.mode-list .post-card { margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
    .posts-container.mode-list .post-img-grid { display: grid; gap: 4px; padding: 0 12px; }
    .posts-container.mode-list .post-img-item { width: 100%; aspect-ratio: 4/3; overflow: hidden; border-radius: 4px; position: relative; }
    .posts-container.mode-list .post-img-item img { width: 100%; height: 100%; object-fit: cover; display: block; }
    
    /* Grid 模式下图片 1:1 强制 */
    .post-img-grid img { width: 100%; height: auto; display: block; aspect-ratio: 1/1; object-fit: cover; }

    .img-count-badge { position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.6); color: #fff; font-size: 0.74rem; padding: 2px 6px; border-radius: 10px; display: flex; align-items: center; gap: 3px; pointer-events: none; }
    
    .timeline-wrapper { display: none; padding: 0 14px; }
    .month-section { margin-bottom: 20px; content-visibility: auto; contain-intrinsic-size: 500px; }
    .month-header { display: flex; justify-content: space-between; align-items: baseline; padding: 10px 0 10px; border-bottom: 1px dashed #eee; margin-bottom: 10px; }
    .month-left { display: flex; align-items: baseline; gap: 5px; }
    .month-num { font-size: 1.63rem; font-weight: bold; color: #333; }
    .year-num { font-size: 0.96rem; color: #999; }
    .post-count-badge { background: #f0f0f0; color: #999; font-size: 0.74rem; padding: 2px 8px; border-radius: 10px; }
    .grid-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 3px; }
    .grid-item { aspect-ratio: 1 / 1; background: #f7f7f7; border-radius: 4px; overflow: hidden; position: relative; cursor: pointer; }
    .grid-item img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
    .grid-item:active img { transform: scale(0.95); }
    .text-card { width: 100%; height: 100%; background: #fff; padding: 8px; display: flex; align-items: flex-start; border: 1px solid #f0f0f0; border-radius: 4px; }
    .text-content-sm { font-size: 0.81rem; line-height: 1.4; color: #666; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 6; -webkit-box-orient: vertical; width: 100%; word-break: break-all; }

    /* 编辑器样式 - 标签 */
    .editor-header { display: flex; justify-content: space-between; align-items: center; padding: calc(8px + var(--safe-top)) 15px 8px 15px; height: calc(46px + var(--safe-top)); background: #fff; flex-shrink: 0; }
    .editor-content { padding: 15px; overflow-y: auto; flex: 1; position: relative;}
    .editor-gallery { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
    .editor-img-item { width: 90px; height: 90px; position: relative; border-radius: 8px; overflow: hidden; }
    .editor-img-item img { width: 100%; height: 100%; object-fit: cover; }
    .editor-img-remove { position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.5); color: #fff; width: 18px; height: 18px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 0.89rem; cursor: pointer; }
    .image-upload-area { width: 90px; height: 90px; background: #f7f7f7; border-radius: 8px; border: 1px dashed #e0e0e0; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #ccc; cursor: pointer; }
    
    .editor-tags-input {
        margin-bottom: 15px;
    }
    .tags-input-row {
        display: flex; gap: 5px; align-items: center; margin-bottom: 5px;
    }
    .tag-input {
        flex: 1; 
        border: 1px solid #e0e0e0; 
        border-radius: 6px; 
        padding: 6px 10px; 
        font-size: 0.89rem;
        background: #f7f7f7;
    }
    #tags-preview {
        display:flex; flex-wrap:wrap; gap:5px; margin-top:8px;
    }
    
    .col-create-cover { width: 100px; height: 100px; background: #f7f7f7; border-radius: 10px; margin: 25px auto; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 1px dashed #ccc; overflow: hidden; }
    .col-create-cover img { width: 100%; height: 100%; object-fit: cover; display: none; }
    .editor-input-group { position: relative; }
    .editor-input-group input { width: 100%; border: none; font-size: 1.19rem; padding: 10px 0; border-bottom: 1px solid #eee; margin-bottom: 15px; }
    .editor-input-group textarea {width: 100%; min-height: 300px; border: none; resize: none; font-size: 1.04rem; line-height: 1.6; color: #555; font-family: inherit; }
    .editor-tools-bottom { padding: 10px 15px; padding-bottom: calc(10px + var(--safe-bottom)); border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff; flex-shrink: 0; }
    .et-left { display: flex; gap: 15px; align-items: center; }
    .col-pill-btn { display: flex; align-items: center; gap: 5px; background: #f2f2f2; color: #666; padding: 6px 12px; border-radius: 18px; font-size: 0.89rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .col-pill-btn.active { background: #333; color: #fff; }
    .col-pill-remove { display: none; width: 14px; height: 14px; background: rgba(255,255,255,0.3); border-radius: 50%; align-items: center; justify-content: center; font-size: 0.74rem; color: #fff; }
    .col-pill-btn.active .col-pill-remove { display: flex; }
    .bg-tool-btn { width: 32px; height: 32px; border-radius: 50%; display: flex; justify-content: center; align-items: center; background: #fff; color: #666; cursor: pointer; }
    .bg-tool-btn.has-bg { background: #333; color: #fff; }
    .word-count-tip { position: fixed; right: 20px; bottom: 80px; font-size: 0.89rem; color: #ccc; pointer-events: none; transition: opacity 0.3s; opacity: 0; }
    .word-count-tip.show { opacity: 1; }

    /* 详情页头部 (全透明修改) */
    .detail-nav { 
        display: flex; align-items: center; justify-content: space-between; 
        padding: calc(10px + var(--safe-top)) 15px 10px 15px; 
        position: sticky; top: 0; 
        background: transparent; 
        backdrop-filter: none; 
        z-index: 50; 
    }
    .d-user-info { display: flex; align-items: center; }
    .d-avatar { width: 30px; height: 30px; border-radius: 50%; margin-right: 8px; background: #eee; }
    .detail-body { padding-bottom: 70px; background: transparent; }
    .d-slider-container { position: relative; width: 100%; overflow: hidden; background: #000; }
    .d-slider { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; scrollbar-width: none; scroll-behavior: smooth; }
    .d-slider::-webkit-scrollbar { display: none; }
    .d-slider-item { flex: 0 0 100%; width: 100%; scroll-snap-align: center; scroll-snap-stop: always; display: flex; justify-content: center; align-items: center; background: #000; min-height: 250px; }
    .d-slider-item img { max-width: 100%; max-height: 80vh; object-fit: contain; display: block; }
    .d-slider-indicator { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.5); color: #fff; padding: 3px 8px; border-radius: 10px; font-size: 0.81rem; font-weight: bold; pointer-events: none; }
    .d-content { padding: 10px 20px; font-size: 1.11rem; line-height: 1.8; color: #333; white-space: normal; word-wrap: break-word; }
    
    /* 标签容器 */
.post-tags {
    display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px;
}
.d-tags {
    display: flex; flex-wrap: wrap; gap: 5px; padding: 10px 20px;
}

/* 标签本体：一套样式兼容日间/夜间 */
.post-tag,
.d-tag {
    background: rgba(255,255,255,0.6);        /* 半透明白色胶囊 */
    color: #111;                               /* 深色文字 */
    border: 1px solid rgba(0,0,0,0.25);        /* 略深描边 */
    padding: 2px 10px;
    border-radius: 999px;                      /* 完全圆角 */
    font-size: 0.78rem;
    display: inline-block;
}
    
    /* Markdoom 样式系统 */
    .d-content h1 { font-size: 1.7em; font-weight: 800; color: #111; margin: 25px 0 15px; letter-spacing: -0.5px; line-height: 1.3; }
    .d-content h2 { font-size: 1.4em; font-weight: 700; color: #333; margin: 20px 0 10px; }
    .d-content h3 { font-size: 1.15em; font-weight: 700; color: #555; margin: 15px 0 8px; }
    .d-content hr { border: none; height: 1px; background: #f0f0f0; margin: 20px 0; }
    .d-content .md-subtext { font-size: 0.85em; color: #999; margin-top: -5px; margin-bottom: 10px; display: block; }
    .d-content .md-ul-item { padding-left: 20px; position: relative; margin-bottom: 4px; }
    .d-content .md-ul-item::before { content: ""; width: 6px; height: 6px; background: #333; border-radius: 50%; position: absolute; left: 6px; top: 10px; }
    .d-content .md-ol-item { padding-left: 0; margin-bottom: 4px; display: flex; }
    .d-content .md-ol-num { font-weight: bold; color: #333; margin-right: 8px; min-width: 20px; }
    .d-content b { font-weight: bold; color: #000; }
    .d-content i { font-style: italic; color: #666; font-family: Georgia, serif; }
    .d-content u { text-decoration: underline; text-decoration-thickness: 1px; text-underline-offset: 3px; }
    .d-content s { color: #ccc; text-decoration: line-through; }
    .d-content div { min-height: 1.5em; margin-bottom: 6px; }
    
    .d-content.text-mode { font-size: 1.19rem; line-height: 1.8; letter-spacing: 0.5px; text-align: left; padding: 15px; }
    .d-meta { padding: 8px 20px; font-size: 0.81rem; color: #bbb; display: flex; justify-content: space-between; margin-bottom: 15px; }
    .divider { height: 1px; background: #f0f0f0; margin: 0 20px; }
    .comments-section { padding: 15px; background: transparent; }
    .comment-item { display: flex; margin-bottom: 20px; }
    .c-avatar { width: 32px; height: 32px; border-radius: 50%; margin-right: 10px; background: #f0f0f0; }
    .c-right { flex: 1; }
    .c-top { display: flex; justify-content: space-between; margin-bottom: 3px; font-size: 0.89rem; color: #999; }
    .c-text { font-size: 1rem; line-height: 1.5; color: #333; }
    .c-date { font-size: 0.81rem; color: #ccc; margin-top: 4px; }
    
    /* 评论操作按钮样式 */
    .c-actions {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-left: auto;
    }
    
    .c-action-btn {
        background: none;
        border: none;
        color: #999;
        font-size: 0.81rem;
        cursor: pointer;
        padding: 2px 5px;
        border-radius: 3px;
    }
    
    .c-action-btn:hover {
        background: #f0f0f0;
    }
    
    .c-action-btn.edit {
        color: #1890ff;
    }
    
    .c-action-btn.delete {
        color: #ff4d4f;
    }
    
    .c-edit-input {
        width: 100%;
        padding: 8px;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
        font-size: 0.96rem;
        margin-bottom: 5px;
    }
    
    .c-edit-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 5px;
    }
    
    .c-edit-btn {
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.81rem;
        cursor: pointer;
        border: none;
    }
    
    .c-edit-btn.c-edit-save {
        background: #333; /* 改为深灰色 */
        color: white;
    }
    
    /* 顺便优化一下取消按钮，让它更轻量 */
    .c-edit-btn.c-edit-cancel {
        background: rgba(0, 0, 0, 0.05);
        color: #666;
    }
    
    .input-bar { 
        position: fixed; bottom: 0; left: 0; width: 100%; 
        background: var(--bottom-bar-bg); 
        background-size: cover; background-position: center;
        backdrop-filter: blur(10px);
        box-shadow: 0 -1px 3px rgba(0,0,0,0.05); 
        padding: 6px 15px; padding-bottom: calc(6px + var(--safe-bottom)); 
        display: flex; align-items: center; z-index: 3002; 
    }
    .input-bar input { flex: 1; background: rgba(255,255,255,0.7); backdrop-filter: blur(5px); border-radius: 18px; padding: 8px 15px; border: 1px solid rgba(0,0,0,0.1); font-size: 0.96rem; margin-right: 10px; }
    .send-btn { color: #333; font-weight: bold; padding: 5px 10px; cursor: pointer; font-size: 0.96rem; }
    .static-input-bar { margin: 0; background: transparent; padding: 10px 20px; display: flex; align-items: center; }
    .static-input-bar input { flex: 1; background: rgba(255,255,255,0.8); border-radius: 20px; padding: 10px 15px; border: 1px solid rgba(0,0,0,0.1); font-size: 0.96rem; margin-right: 10px; backdrop-filter: blur(5px); }
    
    .reading-toolbar-bottom { 
        position: fixed; bottom: 0; left: 0; width: 100%; height: calc(50px + var(--safe-bottom)); 
        padding-bottom: var(--safe-bottom); 
        background: var(--bottom-bar-bg); 
        background-size: cover; background-position: center;
        backdrop-filter: blur(10px); 
        border-top: 1px solid #eee; display: none; justify-content: space-between; align-items: center; padding-left: 10px; padding-right: 10px; z-index: 3005; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); 
    }
    .rt-btn { flex: 1; text-align: center; color: #333; font-size: 0.96rem; font-weight: 500; cursor: pointer; padding: 10px; }
    .rt-btn:active { opacity: 0.6; }
    .rt-btn.disabled { color: #ccc; pointer-events: none; }
    
    .dir-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4000; display: none; flex-direction: column; justify-content: flex-end; }
    .dir-panel { background: #fff; width: 100%; height: 70vh; border-radius: 16px 16px 0 0; display: flex; flex-direction: column; animation: slideUpDir 0.3s ease; padding-bottom: var(--safe-bottom); }
    .dir-header { padding: 12px; text-align: center; font-weight: bold; border-bottom: 1px solid #eee; font-size: 1.11rem; position: relative;}
    .dir-close { position: absolute; right: 15px; top: 12px; color: #999; cursor: pointer; }
    .dir-list { flex: 1; overflow-y: auto; padding: 10px 0; }
    .dir-item { padding: 12px 20px; font-size: 0.96rem; color: #333; border-bottom: 1px solid #f9f9f9; display: flex; justify-content: space-between; }
    .dir-item.active { color: var(--text-main); font-weight: bold; background: #f5f5f5; }
    .dir-item.active::after { content: '当前'; font-size: 0.81rem; color: #999; font-weight: normal;}
    @keyframes slideUpDir { from { transform: translateY(100%); } to { transform: translateY(0); } }

    .post-html-preview { width: 100%; padding-top: 100%; height: 0; position: relative; background: #fff; overflow: hidden; }
    .post-html-preview iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; pointer-events: none; background: #fff; }

    .html-fab-add { position: fixed; bottom: calc(70px + var(--safe-bottom)); right: 20px; width: 50px; height: 50px; background: #fff; color: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 2200; cursor: pointer; transition: transform 0.2s; }
    .html-fab-add:active { transform: scale(0.95); }
    .html-fab-add svg { width: 24px; height: 24px; stroke: currentColor; stroke-width: 2; }
    
    #view-html-detail { position: relative; width: 100%; height: 100%; overflow: hidden; background: #fff; }
    #html-iframe-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
    
    .html-action-bar {
        position: fixed; bottom: calc(20px + var(--safe-bottom)); left: 50%; transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
        padding: 8px 15px; border-radius: 30px;
        display: flex; gap: 15px; align-items: center;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        z-index: 3100; border: 1px solid rgba(0,0,0,0.05);
    }
    .hab-btn {
        width: 36px; height: 36px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; color: #333; transition: background 0.2s;
    }
    .hab-btn:active { background: rgba(0,0,0,0.05); }
    .hab-btn svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; }

    .html-comment-sheet {
        position: fixed; bottom: 0; left: 0; width: 100%; height: 60vh;
        background: #fff; border-radius: 20px 20px 0 0;
        z-index: 3200; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        display: flex; flex-direction: column; box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        padding-bottom: var(--safe-bottom);
    }
    .html-comment-sheet.active { transform: translateY(0); }
    .hcs-header { padding: 15px; text-align: center; font-weight: bold; border-bottom: 1px solid #eee; position: relative; color: #333; }
    .hcs-close { position: absolute; right: 15px; top: 15px; color: #999; cursor: pointer; }
    .hcs-body { flex: 1; overflow-y: auto; padding: 15px; }
    .hcs-footer { padding: 10px 15px; border-top: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
    .hcs-input { flex: 1; background: #f5f5f5; border: none; border-radius: 20px; padding: 8px 15px; font-size: 0.96rem; }
    .hcs-send { color: #333; font-weight: bold; padding: 5px 10px; cursor: pointer; font-size: 0.96rem; }
    
    .sheet-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3150; display: none; opacity: 0; transition: opacity 0.3s; }
    .sheet-overlay.active { display: block; opacity: 1; }

    .col-item { display: flex; padding: 12px; background: #fff; border-radius: 10px; margin: 12px; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer; }
    .col-cover { width: 70px; height: 70px; border-radius: 10px; background: #eee; object-fit: cover; margin-right: 12px; }
    .col-info { flex: 1; }
    .col-title { font-size: 1.11rem; font-weight: bold; color: #333; margin-bottom: 4px; }
    .col-desc { font-size: 0.89rem; color: #999; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .cd-header { position: relative; height: 260px; overflow: hidden; color: #fff; display: flex; flex-direction: column; padding-top: var(--safe-top); }
    .cd-bg-layer { position: absolute; top:0; left:0; width:100%; height:100%; background-size: cover; background-position: center; filter: blur(20px) brightness(0.8); transform: scale(1.2); z-index: 1; }
    .cd-navbar { position: relative; z-index: 10; display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; height: 44px; }
    .cd-info-area { position: relative; z-index: 10; flex: 1; display: flex; flex-direction: column; padding: 0 20px 20px; }
    .cd-info-top { display: flex; gap: 15px; align-items: flex-start; margin-bottom: 15px; }
    .cd-cover { width: 90px; height: 90px; border-radius: 10px; object-fit: cover; background: #fff; flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .cd-text { flex: 1; padding-top: 5px; }
    .cd-title { font-size: 1.33rem; font-weight: bold; margin-bottom: 6px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
    .cd-meta { font-size: 0.81rem; opacity: 0.9; display: flex; align-items: center; gap: 5px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
    .cd-user-avatar { width: 14px; height: 14px; border-radius: 50%; }
    .cd-stats { display: flex; justify-content: space-between; text-align: center; padding: 0 10px; }
    .cd-stat-item { flex: 1; }
    .cd-stat-num { font-size: 1.11rem; font-weight: bold; display: block; outline: 1px dashed transparent; }
    .cd-stat-num:focus { outline: 1px dashed rgba(255,255,255,0.5); background: rgba(0,0,0,0.2); border-radius:4px; }
    .cd-stat-label { font-size: 0.74rem; opacity: 0.7; margin-top: 4px; display: block; }
    .cd-body { position: relative; z-index: 20; background: transparent; border-radius: 16px 16px 0 0; margin-top: -16px; min-height: 500px; padding: 15px 10px 80px 10px; }
    .cd-footer { position: fixed; bottom: 0; left: 0; width: 100%; height: calc(60px + var(--safe-bottom)); padding-bottom: var(--safe-bottom); background: rgba(255,255,255,0.7); backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.3); z-index: 100; display: flex; align-items: center; justify-content: center; gap: 12px; padding: 0 20px; }
    .cd-btn { flex: 1; height: 40px; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.96rem; }
    .cd-btn-sub { background: #f0f0f0; color: #333; cursor: pointer;}
    .cd-btn-read { background: #333; color: #fff; cursor: pointer; }

    .profile-card { background: transparent; box-shadow: none; margin-top: -30px; border-radius: 16px 16px 0 0; position: relative; z-index: 5; padding-bottom: 20px; min-height: 600px; }
    .header-bg { width: 100%; height: 240px; background-color: #ddd; background-size: cover; background-position: center; }
    .avatar-area { position: relative; height: 50px; display: flex; justify-content: center; }
    .avatar-wrapper { position: absolute; top: -40px; width: 80px; height: 80px; background: #fff; border-radius: 50%; padding: 3px; }
    .avatar-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
    .user-info { text-align: center; margin-top: 5px; }
    .user-name { font-size: 1.33rem; font-weight: bold; margin-bottom: 4px; outline: 1px dashed transparent; transition: outline 0.2s; }
    .user-name:focus, .editable-span:focus { outline: 1px dashed #333; background: rgba(0,0,0,0.02); }
    .user-meta { font-size: 0.81rem; color: #999; }
    .editable-span { border-bottom: none; }
    .profile-tab-container { display: flex; border-bottom: 1px solid rgba(0,0,0,0.05); background: transparent; margin-top: 10px; }
    .p-tab { flex: 1; text-align: center; padding: 12px 0; font-weight: bold; color: #999; cursor: pointer; transition: color 0.2s; font-size: 1.04rem; }
    .p-tab.active { color: #333; border-bottom: 2px solid #333; }
    .new-col-btn { margin: 15px; padding: 12px; background: #fff; border: 1px solid #eee; border-radius: 8px; text-align: center; color: #666; cursor: pointer; font-weight: bold; font-size: 0.96rem;}

    .theme-page { padding: calc(15px + var(--safe-top)) 15px 15px 15px; background: transparent; min-height: 100vh; }
    .btn-white { display: flex; justify-content: space-between; width: 100%; background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; margin-bottom: 10px; font-size: 0.96rem; cursor: pointer; }
    .theme-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
    .theme-icon-box { background: #f9f9f9; border: 1px solid #eee; border-radius: 8px; padding: 12px; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
    .theme-icon-box img { width: 28px; height: 28px; margin-bottom: 5px; object-fit: cover; }
    .theme-icon-box span { font-size: 0.81rem; color: #666; }
    
    .works-tab {
        flex: 1;
        font-size: 0.96rem;
        color: #999;
        padding: 5px 0;
        position: relative;
        cursor: pointer;
        font-weight: 500;
        text-align: center;
    }
    .works-tab.active {
        color: var(--text-main);
        font-weight: bold;
    }
    .works-tab.active::after {
        content: '';
        position: absolute;
        bottom: -11px;
        left: 20%;
        width: 60%;
        height: 3px;
        background: var(--active-color);
        border-radius: 2px;
    }
    .sub-tag {
        padding: 4px 12px;
        background: rgba(0,0,0,0.05);
        border-radius: 15px;
        font-size: 0.81rem;
        color: #666;
        cursor: pointer;
    }
    .sub-tag.active {
        background: #333;
        color: #fff;
    }
    
        /* 快捷复制按钮样式 */
    .card-copy-btn {
        position: absolute;
        top: 8px;
        right: 8px; /* 放在右上角 */
        width: 28px;
        height: 28px;
        background: rgba(255,255,255,0.7);
        backdrop-filter: blur(5px);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 30;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        color: #333;
        cursor: pointer;
        transition: all 0.2s;
    }
    .card-copy-btn:active {
        transform: scale(0.9);
        background: #333;
        color: #fff;
    }
    .card-copy-btn svg {
        width: 14px;
        height: 14px;
        fill: none;
        stroke: currentColor;
        stroke-width: 2.5;
    }
    
    /* 详情页统一背景：日间纯白，方便阅读 */
    #view-detail, #view-html-detail {
        background-color: #ffffff !important;
        transition: opacity 0.25s ease-in-out;
    }

    /* HTML作品预览框：强制纯白背景 */
    #html-detail-iframe {
        background-color: #ffffff !important;
        width: 100%;
        height: 100%;
        border: none;
    }

    /* 深色模式自动适配：背景变深灰，文字变浅灰 */
    @media (prefers-color-scheme: dark) {
        #view-detail, #view-html-detail, #html-detail-iframe {
            background-color: #1c1c1e !important; /* Ins风格的深黑灰色 */
        }
        .d-content, .post-title, #d-username {
            color: #e0e0e0 !important;
        }
    }
    
        /* 强制深色模式样式 (手动切换用) */
    html[data-theme='dark'] #global-bg-layer { background-color: transparent; }
    html[data-theme='dark'] body { background-color: transparent; color: #eee; }
    html[data-theme='dark'] .post-card { background-color: rgba(0, 0, 0, 0.35); }
    html[data-theme='dark'] .bottom-bar,
    html[data-theme='dark'] .input-bar,
    html[data-theme='dark'] .reading-toolbar-bottom { 
        background-color: rgba(0, 0, 0, 0.65); 
        backdrop-filter: blur(14px); 
    }
    html[data-theme='dark'] #view-detail, 
    html[data-theme='dark'] #view-html-detail, 
    html[data-theme='dark'] #html-detail-iframe { background-color: #1c1c1e !important; }
    html[data-theme='dark'] .d-content, 
    html[data-theme='dark'] .post-title, 
    html[data-theme='dark'] #d-username { color: #e0e0e0 !important; }

    /* 设置页里的主题选项按钮样式 */
    .theme-mode-box {
        display: flex;
        background: rgba(0,0,0,0.05);
        padding: 4px;
        border-radius: 12px;
        margin-bottom: 20px;
    }
    .theme-mode-btn {
        flex: 1;
        padding: 8px 0;
        text-align: center;
        font-size: 0.85rem;
        color: #999;
        cursor: pointer;
        border-radius: 10px;
        transition: all 0.2s;
    }
    .theme-mode-btn.active {
        background: #fff;
        color: #333;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        font-weight: bold;
    }
    
    /* 深色模式适配 */
@media (prefers-color-scheme: dark) {
    /* 让壁纸继续可见，不要整片纯黑 */
    html, body {
        background-color: transparent !important;
    }
    #global-bg-layer {
        background-color: transparent; /* 让壁纸真正露出来 */
    }

    /* 卡片和底部栏适当变暗，但保留透明感 */
    .post-card {
        background-color: rgba(0, 0, 0, 0.35);
    }
    .bottom-bar,
    .input-bar,
    .reading-toolbar-bottom {
        background-color: rgba(0, 0, 0, 0.65);
        backdrop-filter: blur(14px);
    }

    /* 搜索框和标签输入框略暗一些 */
    .search-box,
    .tag-input {
        background: rgba(0, 0, 0, 0.35);
        border-color: rgba(255, 255, 255, 0.15);
        color: #f0f0f0;
    }
    .search-box input::placeholder,
    .tag-input::placeholder {
        color: #aaaaaa;
    }
}
</style>
</head>
<body>

<div id="global-bg-layer"></div>

<div class="loading-mask" id="loadingMask">
    <div class="loading-spinner"></div>
    <div id="loadingText">处理中...</div>
</div>

<div class="view-container">

    <!-- 1. 主页 -->
<div id="view-home" class="view active">
    <div class="home-header" id="homeHeader">
        <div class="search-box">
            <svg class="icon" style="width:14px; height:14px; margin-right:5px; color:#666;" viewBox="0 0 24 24">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" id="searchInput" placeholder="搜索..." 
       oninput="HomeRenderer.resetAndRender()" 
       onkeydown="HomeRenderer.handleSearchKey(event)">
        </div>
        <button style="background:none; border:none; padding:5px; margin-right:5px;" onclick="HomeRenderer.showFilterMenu()">
            <svg class="icon" style="color:#333;" viewBox="0 0 24 24">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
            </svg>
        </button>
        <button style="background:none; border:none; padding:5px;" onclick="HomeRenderer.toggleLayout()">
            <svg id="layout-icon" class="icon" style="color:#333;" viewBox="0 0 24 24">
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
            </svg>
        </button>
    </div>

    <!-- 当前标签提示条（新加的这一块） -->
    <div id="tag-active-bar" style="display:none; padding:4px 16px 0; font-size:12px; color:#666;">
        当前标签：<span id="tag-active-text" style="font-weight:bold;"></span>
        <span onclick="HomeRenderer.clearTagFilter()" style="margin-left:6px; cursor:pointer;">✕</span>
    </div>
    
        <!-- 当前合集提示条 -->
    <div id="col-active-bar" style="display:none; padding:4px 16px 0; font-size:12px; color:#666;">
        当前合集：<span id="col-active-text" style="font-weight:bold;"></span>
        <span onclick="HomeRenderer.setColFilter(null)" style="margin-left:6px; cursor:pointer;">✕</span>
    </div>

    <div id="posts-list" class="posts-container mode-grid"></div>
    <div id="timeline-list" class="timeline-wrapper"></div>
    <div id="scroll-sentinel"></div>
    <div id="empty-state" style="text-align:center; padding:50px; color:#999; display:none;">
        还没有内容<br><small>点击下方 + 号发布</small>
    </div>
</div>
        <!-- 升级后的作品中心 -->
    <div id="view-html-home" class="view">
        <div class="home-header" style="padding-top: calc(12px + var(--safe-top));">
            <div class="search-box">
                <svg class="icon" style="width:14px; height:14px; margin-right:5px; color:#666;" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <input type="text" id="worksSearchInput" placeholder="在作品中搜索..." oninput="HtmlHomeRenderer.render()">
            </div>
            <!-- 作品页专属漏斗 -->
            <button style="background:none; border:none; padding:5px;" onclick="HtmlHomeRenderer.showFilterMenu()">
                <svg class="icon" style="color:#333; width:20px; height:20px;" viewBox="0 0 24 24"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
            </button>
        </div>
        
        <div style="display:flex; padding:0 0 10px; border-bottom:1px solid rgba(0,0,0,0.05); text-align:center;">
            <div class="works-tab active" id="wtab-html" onclick="HtmlHomeRenderer.switchTab('html')">HTML</div>
            <div class="works-tab"        id="wtab-char" onclick="HtmlHomeRenderer.switchTab('char')">角色卡</div>
            <div class="works-tab"        id="wtab-link" onclick="HtmlHomeRenderer.switchTab('link')">链接</div>
        </div>

        <div id="works-sub-bar" style="display:flex; overflow-x:auto; padding:10px 15px; gap:10px; white-space:nowrap; scrollbar-width:none;"></div>

        <!-- 作品页当前标签提示条 -->
        <div id="works-tag-active-bar" style="display:none; padding:0 15px 10px; font-size:12px; color:#666;">
            当前标签：<span id="works-tag-active-text" style="font-weight:bold;"></span>
            <span onclick="HtmlHomeRenderer.clearTagFilter()" style="margin-left:6px; cursor:pointer;">✕</span>
        </div>

        <div id="html-posts-list" class="posts-container mode-grid" style="padding-top:0;"></div>
        <div id="html-empty-state" style="text-align:center; padding:50px; color:#999; display:none;">这里空空如也<br><small>点击下方 + 号开始创作</small></div>
        
        <div class="html-fab-add" onclick="HtmlHomeRenderer.quickAdd()"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></div>
    </div>
    
    <!-- 批量操作栏 -->
    <div class="batch-bar" id="batchBar">
        <div style="flex:1; text-align:center; color:#ff4d4f; font-weight:bold; cursor:pointer;" onclick="BatchMgr.deleteSelected()">批量删除</div>
        <div style="width:1px; height:20px; background:#eee;"></div>
        <div style="flex:1; text-align:center; color:#333; font-weight:bold; cursor:pointer;" onclick="BatchMgr.addToCollection()">加入合集</div>
        <div style="width:1px; height:20px; background:#eee;"></div>
        <div style="flex:1; text-align:center; color:#666; cursor:pointer;" onclick="BatchMgr.exit()">取消</div>
    </div>

    <!-- 2. 编辑器 -->
    <div id="view-editor" class="view">
        <div class="editor-header">
            <div onclick="Router.back()" style="font-size:1.04rem; color:#666;">取消</div>
            <div style="font-weight:bold;">发布内容</div>
            <div onclick="Editor.publish()" style="font-size:1.04rem; color:#333; font-weight:bold;">发布</div>
        </div>
        <div class="editor-content">
            <div class="editor-gallery" id="editor-gallery">
                <div id="img-upload-btn" class="image-upload-area" onclick="document.getElementById('post-img-input').click()">
                    <svg class="icon" viewBox="0 0 24 24" style="stroke:#ccc;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                    <span style="font-size:0.81rem; margin-top:5px;">添加图片</span>
                </div>
            </div>
            <input type="file" id="post-img-input" class="hidden-input" accept="image/*" multiple onchange="Editor.handleImages(this)">
            
            <div class="editor-tags-input">
                <div class="tags-input-row">
                    <input type="text" id="post-tags-input" class="tag-input" placeholder="标签">
                    <button style="background:#e0e0e0; border:none; padding:6px 12px; border-radius:4px; font-size:0.81rem;" onclick="Editor.addTagFromInput()">添加</button>
                </div>
                <div id="tags-preview"></div>
            </div>
            
        <div class="editor-input-group">
            <input type="text" id="post-title" placeholder="标题...">
            
            <div id="field-standard">
            <input type="text" id="work-category-std" placeholder="子分类 (例如: 游戏 / 网页)" style="display:none; font-size:0.85rem; background:#f5f5f5; padding:8px; border-radius:6px; margin-bottom:10px; width:100%; border:none;">
                <textarea id="post-content" placeholder="记录这一刻..." oninput="Editor.updateWordCount()"></textarea>
            </div>

            <div id="field-char" style="display:none; padding:10px 0;">
                <input type="text" id="char-category" placeholder="分类 (例如: 自创 / 转载)" style="font-size:0.89rem; background:#f9f9f9; padding:8px; border-radius:6px; margin-bottom:10px; width:100%; border:none;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                    <input type="text" id="char-name" placeholder="角色姓名" style="margin-bottom:0; font-size:1rem;">
                    <input type="text" id="char-gender" placeholder="性别" style="margin-bottom:0; font-size:1rem;">
                    <input type="text" id="char-age" placeholder="年龄" style="margin-bottom:0; font-size:1rem;">
                    <input type="text" id="char-identity" placeholder="身份/阵营" style="margin-bottom:0; font-size:1rem;">
                </div>
                <textarea id="char-desc" placeholder="性格、经历等详细设定..." style="min-height:150px; font-size:0.96rem; border:1px solid #eee; padding:10px; border-radius:8px; width:100%; resize:none;"></textarea>
            </div>

            <div id="field-link" style="display:none; padding:10px 0;">
                <input type="text" id="link-category" placeholder="分类 (例如: 签到 / 工具)" style="font-size:0.89rem; background:#f9f9f9; padding:8px; border-radius:6px; margin-bottom:10px; width:100%; border:none;">
                <input type="text" id="link-label" placeholder="卡片显示的文字 (例如: 每日签到)" style="margin-bottom:10px; font-weight:bold;">
                <input type="text" id="link-url" placeholder="URL 链接 (以 http 开头)" style="color:#1890ff;">
            </div>

                <div id="word-count-display" class="word-count-tip">0 字</div>
            </div>
        </div>
        <div class="editor-tools-bottom">
            <div class="et-left">
                <div class="col-pill-btn" id="editor-col-btn" onclick="Editor.openColPicker()">
                    <span id="editor-col-text">+ 加入合集</span>
                    <div class="col-pill-remove" style="display:none;" onclick="Editor.removeCollection(event)">×</div>
                </div>
            </div>
            <div class="et-right">
                <div class="bg-tool-btn" id="editor-bg-btn" onclick="document.getElementById('post-bg-file').click()">
                    <svg class="icon" style="width:18px; height:18px;" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                </div>
                <input type="file" id="post-bg-file" class="hidden-input" accept="image/*" onchange="Editor.handlePostBg(this)">
            </div>
        </div>
    </div>

    <!-- 3. 详情页 -->
    <div id="view-detail" class="view">
        <div class="detail-nav">
            <div onclick="Router.back()" style="cursor:pointer;"><svg class="icon" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg></div>
            <div class="d-user-info"><img id="d-avatar-img" src="" class="d-avatar"><span id="d-username" style="font-size:0.96rem; font-weight:500;"></span></div>
            <div onclick="ContextMenu.showDetailMenu(event, DetailRenderer.currentPostId)" style="cursor:pointer;">
                <svg class="icon" style="width:18px;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
            </div>
        </div>
        <div class="detail-body">
            <div id="d-body-content"></div>
            <!-- 标签展示区 -->
            <div class="d-tags" id="d-tags-container"></div>
            <div class="d-meta"><span id="d-date"></span></div>
            <div class="divider"></div>
            <div id="d-inline-input-area"></div>
            <div class="comments-section" id="d-comments-list"></div>
        </div>
        <div class="reading-toolbar-bottom" id="reading-toolbar">
            <div class="rt-btn" id="rt-prev" onclick="DetailRenderer.prevPost()">上一篇</div>
            <div class="rt-btn" onclick="DetailRenderer.showDirectory()">目录</div>
            <div class="rt-btn" id="rt-next" onclick="DetailRenderer.nextPost()">下一篇</div>
        </div>
        <div class="input-bar" id="float-input-bar">
            <input type="text" id="comment-input" placeholder="自言自语一下...">
            <div class="send-btn" onclick="DetailRenderer.addComment()">发送</div>
        </div>
    </div>

    <!-- 目录 -->
    <div class="dir-overlay" id="dir-overlay" onclick="document.getElementById('dir-overlay').style.display='none'">
        <div class="dir-panel" onclick="event.stopPropagation()">
            <div class="dir-header">合集目录<div class="dir-close" onclick="document.getElementById('dir-overlay').style.display='none'">×</div></div>
            <div class="dir-list" id="dir-list-container"></div>
        </div>
    </div>

    <!-- HTML 详情页 -->
    <div id="view-html-detail" class="view">
        <div id="html-iframe-wrapper">
            <iframe id="html-detail-iframe" sandbox="allow-scripts allow-same-origin"></iframe>
        </div>
        
        
        <!-- 悬浮操作栏 -->
        <div class="html-action-bar">
            <div class="hab-btn" onclick="handleHtmlBack()">
                <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
            </div>
            <div style="width:1px; height:16px; background:#eee;"></div>
            <div class="hab-btn" onclick="DetailRenderer.copyHtml()">
                <svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </div>
            <div class="hab-btn" onclick="DetailRenderer.toggleHtmlComments()">
                <svg viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
            </div>
        </div>

        <div class="sheet-overlay" id="html-sheet-overlay" onclick="DetailRenderer.toggleHtmlComments(false)"></div>
        
        <div class="html-comment-sheet" id="html-comment-sheet">
            <div class="hcs-header">
                评论
                <div class="hcs-close" onclick="handleHtmlBack()">×</div>
            </div>
            <div class="hcs-body" id="html-comments-list-simple"></div>
            <div class="hcs-footer">
                <input type="text" id="html-comment-input" class="hcs-input" placeholder="说点什么...">
                <div class="hcs-send" onclick="DetailRenderer.addHtmlComment()">发送</div>
            </div>
        </div>
    </div>

    <!-- 创建合集 -->
    <div id="view-collection-create" class="view">
        <div class="editor-header">
            <div onclick="Router.back()" style="font-size:1.04rem; color:#666;">取消</div>
            <div style="font-weight:bold;">编辑合集</div>
            <div onclick="ColMgr.save()" style="font-size:1.04rem; color:#333; font-weight:bold;">完成</div>
        </div>
        <div class="editor-content" style="padding:20px;">
            <div class="col-create-cover" onclick="document.getElementById('col-cover-input').click()">
                <span id="col-cover-tip" style="color:#ccc;">+ 封面</span>
                <img id="col-cover-preview">
            </div>
            <input type="file" id="col-cover-input" class="hidden-input" accept="image/*" onchange="ColMgr.handleCover(this)">
            <div class="editor-input-group">
                <input type="text" id="col-title-input" placeholder="合集名称">
                <textarea id="col-desc-input" placeholder="写点简介..." style="min-height:100px;"></textarea>
            </div>
        </div>
    </div>

    <!-- 合集详情 -->
    <div id="view-collection-detail" class="view">
        <div class="cd-header">
            <div class="cd-bg-layer" id="cd-bg"></div>
            <div class="cd-navbar">
                <div onclick="ProfileRenderer.returnToCols()" style="color:#fff; cursor:pointer;"><svg class="icon" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg></div>
                <div style="color:#fff; cursor:pointer;" onclick="ColDetailMgr.showMenu()"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="2"/><circle cx="12" cy="5" r="2"/><circle cx="12" cy="19" r="2"/></svg></div>
            </div>
            <div class="cd-info-area">
                <div class="cd-info-top">
                    <img id="cd-cover" class="cd-cover" src="">
                    <div class="cd-text">
                        <div class="cd-title" id="cd-title">合集标题</div>
                        <div class="cd-meta">
                            <img id="cd-avatar" class="cd-user-avatar">
                            <span id="cd-author">创建者</span>
                        </div>
                    </div>
                </div>
                <div class="cd-stats">
                    <div class="cd-stat-item"><span class="cd-stat-num" id="cd-stat-sub" contenteditable="true" onblur="ColDetailMgr.saveStat(this, 'sub')">0</span><span class="cd-stat-label">订阅数</span></div>
                    <div class="cd-stat-item"><span class="cd-stat-num" id="cd-stat-hot" contenteditable="true" onblur="ColDetailMgr.saveStat(this, 'hot')">0</span><span class="cd-stat-label">总热度</span></div>
                    <div class="cd-stat-item"><span class="cd-stat-num" id="cd-stat-view" contenteditable="true" onblur="ColDetailMgr.saveStat(this, 'view')">0</span><span class="cd-stat-label">浏览数</span></div>
                </div>
            </div>
        </div>
        <div class="cd-body">
            <div id="cd-post-list" class="posts-container mode-grid" style="padding:0; margin-top:15px;"></div>
            <div id="cd-empty" style="text-align:center; padding:50px; color:#ccc; display:none;">
                <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="#ddd" stroke-width="1"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
                <div style="margin-top:10px; font-size:0.81rem;">作者还在加油创作中</div>
            </div>
        </div>
        <div class="cd-footer">
            <div class="cd-btn cd-btn-sub" onclick="ColDetailMgr.toggleSubscribe(this)">订阅合集</div>
            <div class="cd-btn cd-btn-read" onclick="ColDetailMgr.startReading()">开始阅读</div>
        </div>
    </div>

    <!-- 个人主页 -->
    <div id="view-profile" class="view">
        <div class="header-bg" id="profileBg" onclick="document.getElementById('bgInput').click()">
            <input type="file" id="bgInput" class="hidden-input" accept="image/*" onchange="updateImage(this, 'profileBg', 'bg')">
        </div>
        <div class="profile-card">
            <div class="avatar-area">
                <div class="avatar-wrapper" onclick="document.getElementById('avatarInput').click()">
                    <img id="avatarImg" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Jiang" class="avatar-img">
                    <input type="file" id="avatarInput" class="hidden-input" accept="image/*" onchange="updateImage(this, 'avatarImg', 'img')">
                </div>
            </div>
            <div class="user-info">
                <div class="user-name" id="userName" contenteditable="true" onblur="saveProfileMeta()">江忱</div>
                <div class="user-meta">
                    <span>ID: <span id="userId" class="editable-span" contenteditable="true" onblur="saveProfileMeta()">123456789</span></span>
                    <span style="margin:0 5px;">|</span>
                    <span>IP: <span id="userIp" class="editable-span" contenteditable="true" onblur="saveProfileMeta()">中国台湾</span></span>
                </div>
            </div>
            <div class="profile-tab-container">
                <div class="p-tab active" id="ptab-posts" onclick="ProfileRenderer.switchTab('posts')">帖子</div>
                <div class="p-tab" id="ptab-cols" onclick="ProfileRenderer.switchTab('cols')">合集</div>
            </div>
            <div id="profile-posts-area">
                <div id="profile-posts-list" class="posts-container mode-list" style="padding:0 12px;"></div>
                <div id="profile-empty" style="text-align:center; padding:30px; color:#ddd; display:none;">暂无内容</div>
            </div>
            <div id="profile-cols-area" style="display:none;">
                <div class="new-col-btn" onclick="ColMgr.openCreate()">+ 新建合集</div>
                <div id="col-list-container"></div>
            </div>
        </div>
    </div>

    <!-- 设置页 -->
    <div id="view-theme" class="view">
        <div class="theme-page">
            <h2 style="margin-bottom:20px;">设置与备份</h2>
            
            
            <div style="font-size:12px; color:#999; margin:20px 0 8px;">数据导出</div>
            <div class="btn-white" onclick="DBMgr.showExportYearMenu()">
                <span>备份数据 (支持选择保存位置)</span>
                <span style="color:#999;font-size:0.89rem;">ZIP</span>
            </div>
            <div class="btn-white" onclick="DBMgr.exportTextOnly()">
                <span>仅导出文字 (JSON)</span>
                <span style="color:#999;font-size:0.89rem;">轻量级</span>
            </div>

            <div style="font-size:0.89rem; color:#999; margin:20px 0 8px;">数据导入</div>
            <div class="btn-white" style="position:relative;">
                <span>恢复数据 (选择 ZIP 或 JSON 文件)</span>
                <input type="file" class="hidden-input" style="display:block; opacity:0; position:absolute; top:0; left:0; width:100%; height:100%;" onchange="DBMgr.importData(this)">
            </div>
            <div class="btn-white" onclick="DBMgr.clearAll()" style="color:red; margin-top:10px;"><span>清空所有数据</span></div>

            <div style="font-size:0.89rem; color:#999; margin:20px 0 8px;">云端备份 (GitHub)</div>
            <div class="btn-white" style="display:block; cursor:default;">
                <div onclick="const el=document.getElementById('gh-config-area'); const icon=this.querySelector('.toggle-icon'); if(el.style.display==='none'){el.style.display='block'; icon.style.transform='rotate(180deg)';}else{el.style.display='none'; icon.style.transform='rotate(0deg)';}" style="display:flex; justify-content:space-between; align-items:center; cursor:pointer; padding-bottom:5px;">
                    <div style="display:flex; align-items:center;">
                        <span style="color:#333; font-weight:500;">🔧 配置参数</span>
                        <div onclick="event.stopPropagation(); document.getElementById('gh-help-overlay').style.display='flex';" style="margin-left:8px; display:flex; align-items:center; padding:2px;">
                            <svg style="width:16px; height:16px; color:#1890ff;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                        </div>
                    </div>
                    <svg class="toggle-icon" style="width:14px; height:14px; color:#999; transition:transform 0.3s;" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></polyline></svg>
                </div>
                <div id="gh-config-area" style="display:none; margin-top:10px; padding-top:10px; border-top:1px dashed #eee;">
                    <div style="margin-bottom:10px;">
                        <div style="font-size:0.81rem; color:#666; margin-bottom:5px;">GitHub Token</div>
                        <div style="position:relative;">
                            <input type="password" id="gh-token-input" placeholder="ghp_xxxx..." style="width:100%; border:1px solid #eee; padding:8px; padding-right:35px; border-radius:4px; font-size:0.89rem;" onchange="GitHubMgr.saveConfig()">
                            <div onclick="const input=document.getElementById('gh-token-input'); const type=input.getAttribute('type')==='password'?'text':'password'; input.setAttribute('type', type); this.innerHTML=type==='text'?'<svg viewBox=\'0 0 24 24\' width=\'16\' height=\'16\' stroke=\'currentColor\' stroke-width=\'2\' fill=\'none\' stroke-linecap=\'round\' stroke-linejoin=\'round\'><path d=\'M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24\'></path><line x1=\'1\' y1=\'1\' x2=\'23\' y2=\'23\'></line></svg>':'<svg viewBox=\'0 0 24 24\' width=\'16\' height=\'16\' stroke=\'currentColor\' stroke-width=\'2\' fill=\'none\' stroke-linecap=\'round\' stroke-linejoin=\'round\'><path d=\'M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z\'></path><circle cx=\'12\' cy=\'12\' r=\'3\'></circle></svg>';" style="position:absolute; right:10px; top:50%; transform:translateY(-50%); color:#999; cursor:pointer; display:flex;">
                                <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                            </div>
                        </div>
                    </div>
                    <div style="margin-bottom:10px;">
                        <div style="font-size:0.81rem; color:#666; margin-bottom:5px;">仓库路径 (用户名/仓库名)</div>
                        <input type="text" id="gh-repo-input" placeholder="username/repo" style="width:100%; border:1px solid #eee; padding:8px; border-radius:4px; font-size:0.89rem;" onchange="GitHubMgr.saveConfig()">
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px; border-top:1px solid #f5f5f5; padding-top:10px;">
                    <span>自动备份开关</span>
                    <label class="switch" style="position:relative; display:inline-block; width:40px; height:24px;">
                        <input type="checkbox" id="gh-auto-switch" style="opacity:0; width:0; height:0;" onchange="GitHubMgr.saveConfig()">
                        <span style="position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#ccc; transition:.4s; border-radius:24px;" id="gh-switch-slider"></span>
                        <style>
                            #gh-auto-switch:checked + #gh-switch-slider { background-color: #333; }
                            #gh-switch-slider:before { position:absolute; content:""; height:16px; width:16px; left:4px; bottom:4px; background-color:white; transition:.4s; border-radius:50%; }
                            #gh-auto-switch:checked + #gh-switch-slider:before { transform: translateX(16px); }
                        </style>
                    </label>
                </div>
                <div id="gh-interval-setting" style="display:none; justify-content:space-between; align-items:center; margin-top:10px;">
                    <span style="font-size:0.89rem; color:#666;">备份频率</span>
                    <select id="gh-interval-select" style="border:1px solid #eee; padding:5px; border-radius:4px; font-size:0.89rem; background:#fff;" onchange="GitHubMgr.saveConfig()">
                        <option value="24">每 24 小时</option>
                        <option value="36">每 36 小时</option>
                        <option value="48">每 48 小时</option>
                    </select>
                </div>
                <div style="margin-top:15px; display:flex; gap:10px;">
                    <div style="flex:1; background:#333; color:#fff; text-align:center; padding:8px; border-radius:4px; font-size:0.89rem; cursor:pointer;" onclick="GitHubMgr.testUpload()">立即备份</div>
                    <div style="flex:1; background:#1890ff; color:#fff; text-align:center; padding:8px; border-radius:4px; font-size:0.89rem; cursor:pointer;" onclick="GitHubMgr.restoreLatest()">恢复最新</div>
                    <div style="flex:1; background:#f5f5f5; color:#666; text-align:center; padding:8px; border-radius:4px; font-size:0.89rem; cursor:pointer;" onclick="GitHubMgr.checkStatus()">检查状态</div>
                </div>
                <div id="gh-status-msg" style="margin-top:10px; font-size:0.74rem; color:#999;"></div>
            </div>

            <div style="font-size:0.89rem; color:#999; margin:20px 0 8px;">栏目外观</div>
            <div class="btn-white" onclick="document.getElementById('bottomBarInput').click()"><span>底部栏背景</span><input type="file" id="bottomBarInput" class="hidden-input" accept="image/*" onchange="ThemeMgr.setBarBg('bottom', this)"></div>
            <div class="btn-white" onclick="document.getElementById('globalBgInput').click()"><span>全局背景图</span><input type="file" id="globalBgInput" class="hidden-input" accept="image/*" onchange="setGlobalBg(this)"></div>
            <div class="btn-white" onclick="document.getElementById('postBgInput').click()"><span>帖子默认名片背景</span><input type="file" id="postBgInput" class="hidden-input" accept="image/*" onchange="ThemeMgr.setPostBg(this)"></div>

            <div style="font-size:0.89rem; color:#999; margin:20px 0 8px;">字体设置</div>
            <div class="btn-white" onclick="FontMgr.showMenu()"><span>字体管理</span><span id="current-font-name" style="color:#999;font-size:0.89rem;">默认</span></div>
            <div class="btn-white" style="display:block; padding-bottom:5px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span>全局字号</span>
                    <span id="font-size-val" style="color:#999;font-size:0.89rem;">13.5px</span>
                </div>
                <input type="range" min="10" max="22" step="0.5" value="13.5" id="fontSizeSlider" style="width:100%; height:4px;" oninput="ThemeMgr.setFontSize(this.value)">
            </div>

            <div style="font-size:0.89rem; color:#999; margin:20px 0 8px;">底部图标</div>
            <div class="theme-grid">
                <div class="theme-icon-box" onclick="document.getElementById('icon1Input').click()"><img id="icon1Preview" src=""><span style="margin-top:5px;">首页</span><input type="file" id="icon1Input" class="hidden-input" accept="image/*" onchange="ThemeMgr.setIcon(0, this)"></div>
                <div class="theme-icon-box" onclick="document.getElementById('icon2Input').click()"><img id="icon2Preview" src=""><span style="margin-top:5px;">HTML</span><input type="file" id="icon2Input" class="hidden-input" accept="image/*" onchange="ThemeMgr.setIcon(1, this)"></div>
                <div class="theme-icon-box" onclick="document.getElementById('icon3Input').click()"><img id="icon3Preview" src=""><span style="margin-top:5px;">发布</span><input type="file" id="icon3Input" class="hidden-input" accept="image/*" onchange="ThemeMgr.setIcon(2, this)"></div>
                <div class="theme-icon-box" onclick="document.getElementById('icon4Input').click()"><img id="icon4Preview" src=""><span style="margin-top:5px;">我的</span><input type="file" id="icon4Input" class="hidden-input" accept="image/*" onchange="ThemeMgr.setIcon(3, this)"></div>
                <div class="theme-icon-box" onclick="document.getElementById('icon5Input').click()"><img id="icon5Preview" src=""><span style="margin-top:5px;">设置</span><input type="file" id="icon5Input" class="hidden-input" accept="image/*" onchange="ThemeMgr.setIcon(4, this)"></div>
            </div>
            <div class="btn-white" onclick="ThemeMgr.resetAll()" style="margin-top:20px;"><span>重置美化设置</span></div>
        </div>
    </div>

    <!-- 底部导航 -->
    <div class="bottom-bar" id="bottomBar">
        <div class="nav-item active" onclick="Router.go('home', this)" id="nav-0"><svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div>
        <div class="nav-item" onclick="Router.go('html-home', this)" id="nav-1"><svg class="icon" viewBox="0 0 24 24"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg></div>
        <div class="nav-item" id="nav-2">
    <div class="nav-icon-plus" onclick="PlusMenu.show()">
        <svg viewBox="0 0 24 24" id="svg-plus"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    </div>
</div>
        <div class="nav-item" onclick="Router.go('profile', this)" id="nav-3"><svg class="icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
        <div class="nav-item" onclick="Router.go('theme', this)" id="nav-4"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div>
    </div>
</div>

<div class="image-viewer-overlay" id="imageViewer" onclick="ImageViewer.close()">
    <div class="iv-img-wrapper"><img id="iv-img" src="" onclick="event.stopPropagation()"></div>
    <div class="iv-controls" onclick="event.stopPropagation()">
        <div class="iv-btn" onclick="ImageViewer.download()">
            <svg class="icon" style="width:16px; height:16px;" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>保存图片
        </div>
        <div class="iv-btn" onclick="ImageViewer.close()">关闭</div>
    </div>
</div>

<div class="overlay" id="contextOverlay" onclick="ContextMenu.hide()">
    <div class="context-menu" id="contextMenuBody" onclick="event.stopPropagation()"></div>
</div>

<div class="overlay" id="colSelectOverlay" onclick="document.getElementById('colSelectOverlay').style.display='none'">
    <div class="context-menu" id="colSelectMenu" onclick="event.stopPropagation()">
        <div style="padding:15px; font-weight:bold; border-bottom:1px solid #eee;">添加到合集</div>
        <div id="colSelectOptions" style="max-height:300px; overflow-y:auto;"></div>
        <div class="menu-item" onclick="document.getElementById('colSelectOverlay').style.display='none'">取消</div>
    </div>
</div>

<div class="overlay" id="exportYearOverlay" onclick="document.getElementById('exportYearOverlay').style.display='none'">
    <div class="context-menu" onclick="event.stopPropagation()">
        <div style="padding:15px; font-weight:bold; border-bottom:1px solid #eee; text-align:center;">选择导出年份</div>
        <div id="exportYearOptions" style="max-height:300px; overflow-y:auto;"></div>
        <div class="menu-item" style="color:#666;" onclick="document.getElementById('exportYearOverlay').style.display='none'">取消</div>
    </div>
</div>

<div class="overlay" id="fontOverlay" onclick="document.getElementById('fontOverlay').style.display='none'">
    <div class="context-menu" style="height:60vh; display:flex; flex-direction:column;" onclick="event.stopPropagation()">
        <div style="padding:15px; font-weight:bold; border-bottom:1px solid #eee; text-align:center; display:flex; justify-content:space-between; align-items:center;">
            <span>字体管理</span>
            <div style="font-size:12px; color:#333; background:#f0f0f0; padding:4px 8px; border-radius:4px; cursor:pointer;" onclick="FontMgr.addFontClick()">+ 添加</div>
        </div>
        <div id="font-list-container" style="flex:1; overflow-y:auto;"></div>
        <div class="menu-item" style="color:#666; border-top:1px solid #eee;" onclick="document.getElementById('fontOverlay').style.display='none'">关闭</div>
    </div>
</div>

<div class="overlay" id="addFontOverlay" style="z-index: 4100;" onclick="document.getElementById('addFontOverlay').style.display='none'">
    <div class="context-menu" onclick="event.stopPropagation()">
        <div style="padding:15px; font-weight:bold; border-bottom:1px solid #eee; text-align:center;">添加新字体</div>
        <div class="menu-item" onclick="document.getElementById('font-file-input').click()">上传本地字体文件 (.ttf/.otf/.woff)</div>
        <input type="file" id="font-file-input" class="hidden-input" accept=".ttf,.otf,.woff,.woff2" onchange="FontMgr.handleFileSelect(this)">
        <div class="menu-item" onclick="FontMgr.addByUrl()">输入网络字体 URL</div>
        <div class="menu-item" style="color:#666;" onclick="document.getElementById('addFontOverlay').style.display='none'">取消</div>
    </div>
</div>

<div class="overlay" id="gh-help-overlay" onclick="this.style.display='none'" style="z-index:6000;">
    <div class="context-menu" onclick="event.stopPropagation()" style="padding:20px; max-height:80vh; overflow-y:auto; width:85%;">
        <h3 style="margin-bottom:15px; text-align:center; font-size:1.1rem;">GitHub 配置指南</h3>
        <!-- 说明内容略，保持原样 -->
        <h4 style="margin:10px 0 5px; color:#333;">1. 获取 Token</h4>
        <ol style="padding-left:20px; font-size:0.89rem; color:#555; line-height:1.6;">
            <li>登录 GitHub，点击右上角头像 <br>→ <strong>Settings</strong></li>
            <li>左侧菜单滑到底 <br>→ <strong>Developer settings</strong></li>
            <li>点击 <strong>Personal access tokens</strong> <br>→ <strong>Tokens (classic)</strong></li>
            <li>点击 <strong>Generate new token (classic)</strong></li>
            <li>Note 随便填，Expiration 建议选 No expiration (永不过期)</li>
            <li><strong>Scopes 必须勾选 <code style="background:#eee;padding:2px 4px;border-radius:3px;">repo</code> (包含所有子项)</strong></li>
            <li>点击页底 Generate token，页面会显示一串以 <code>ghp_</code> 开头的字符。<br><strong style="color:#ff4d4f;">一定要现在复制并保存好！一旦刷新页面，你就再也看不到它了。</strong></li>
        </ol>
        <h4 style="margin:15px 0 5px; color:#333;">2. 创建仓库</h4>
        <ol style="padding-left:20px; font-size:0.89rem; color:#555; line-height:1.6;">
            <li>点击右上角 + 号 → <strong>New repository</strong></li>
            <li>Repository name 填个名字（如 my-backup）</li>
            <li>建议选 <strong>Private</strong> (私有)</li>
            <li>点击 Create repository</li>
        </ol>
        <h4 style="margin:15px 0 5px; color:#333;">3. 填写示例</h4>
        <ul style="padding-left:20px; font-size:0.89rem; color:#555; line-height:1.6;">
            <li><strong>Token:</strong> <code>ghp_xxxxxxxxxxxx...</code></li>
            <li><strong>仓库路径:</strong> <code>用户名/仓库名</code> <br><span style="font-size:0.81rem;color:#999;">(例如: zhangsan/my-backup)</span></li>
        </ul>
        <div class="menu-item" style="margin-top:20px; background:#f5f5f5; border-radius:8px; font-weight:bold;" onclick="document.getElementById('gh-help-overlay').style.display='none'">我学会了</div>
    </div>
</div>

<script>
    function parseMarkdoom(text) {
        if (!text) return '';
        const lines = text.split('\n');
        let html = '';
        lines.forEach(line => {
            let l = line;
            let rowHtml = '';
            if (l.trim() === '---') {
                rowHtml = '<hr>';
            }
            else if (l.match(/^###\s/)) {
                rowHtml = `<h3>${parseInline(l.substring(4))}</h3>`;
            } else if (l.match(/^##\s/)) {
                rowHtml = `<h2>${parseInline(l.substring(3))}</h2>`;
            } else if (l.match(/^#\s/)) {
                rowHtml = `<h1>${parseInline(l.substring(2))}</h1>`;
            }
            else if (l.match(/^-#\s/)) {
                rowHtml = `<span class="md-subtext">${parseInline(l.substring(3))}</span>`;
            }
            else if (l.match(/^[\*\-]\s/)) {
                rowHtml = `<div class="md-ul-item">${parseInline(l.substring(2))}</div>`;
            }
            else if (l.match(/^\d+\.\s/)) {
                const match = l.match(/^(\d+\.)\s(.*)/);
                if (match) {
                    rowHtml = `<div class="md-ol-item"><span class="md-ol-num">${match[1]}</span><span>${parseInline(match[2])}</span></div>`;
                } else {
                     rowHtml = `<div>${parseInline(l)}</div>`;
                }
            }
            else {
                if (l.trim() === '') rowHtml = '<div style="height:10px"></div>';
                else rowHtml = `<div>${parseInline(l)}</div>`;
            }
            html += rowHtml;
        });
        return html;
    }

    function parseInline(str) {
        if (!str) return '';
        let s = str;
        s = s.replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">");
        s = s.replace(/\*\*\*(.*?)\*\*\*/g, '<b><i>$1</i></b>');
        s = s.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
        s = s.replace(/\*([^\s\*].*?)\*/g, '<i>$1</i>');
        s = s.replace(/__(.*?)__/g, '<u>$1</u>');
        s = s.replace(/~~(.*?)~~/g, '<s>$1</s>');
        return s;
    }

    function saveFileUniversal(blob, fileName) {
        if (window.plus) {
            document.getElementById('loadingText').innerText = '正在调起系统保存...';
            plus.io.requestFileSystem(plus.io.PRIVATE_DOC, function(fs) {
                fs.root.getFile(fileName, { create: true }, function(fileEntry) {
                    fileEntry.createWriter(function(writer) {
                        writer.onwriteend = function() {
                            document.getElementById('loadingMask').style.display = 'none';
                            plus.share.sendWithSystem({
                                type: 'text',
                                content: '我的备份数据', 
                                href: fileEntry.toURL(),
                                title: fileName
                            }, function(){
                                console.log('分享成功');
                            }, function(e){
                                console.log('分享失败: ' + JSON.stringify(e));
                            });
                        };
                        writer.onerror = function(e) { alert('写入临时文件失败: ' + e.message); };
                        writer.write(blob); 
                    }, function(e) { alert('无法创建写入器: ' + e.message); });
                }, function(e) { alert('无法创建文件: ' + e.message); });
            }, function(e) { alert('无法访问文件系统: ' + e.message); });
        } else {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = fileName;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 10000);
            document.getElementById('loadingMask').style.display = 'none';
        }
    }

    // ======================= 新增：备份管理器 =======================
    const BackupMgr = {
        // 备份所有纯文本数据（去除图片字段）
        backup: async () => {
            try {
                // 获取所有帖子（含图片）
                const allPosts = await DBMgr.getAllPosts();
                // 去除图片和背景图，只保留文字信息
                const postsForBackup = allPosts.map(p => {
                    const { images, image, postBg, ...rest } = p;
                    return rest;
                });

                // 获取所有合集（并去除封面图片）
                const allCols = await DBMgr.getAllCollections();
                const colsForBackup = allCols.map(c => {
                    const { cover, ...rest } = c;
                    return rest;
                });

                const backupData = {
                    posts: postsForBackup,
                    collections: colsForBackup,
                    timestamp: Date.now()
                };

                localStorage.setItem('full_backup', JSON.stringify(backupData));
                console.log('备份成功');
            } catch (e) {
                console.warn('备份失败', e);
            }
        },

        // 尝试从 localStorage 恢复数据（仅在 IndexedDB 为空时调用）
        restoreIfNeeded: async () => {
            const meta = await DBMgr.getAllPostMeta();
            if (meta.length > 0) return; // 已有数据，不恢复

            const backupStr = localStorage.getItem('full_backup');
            if (!backupStr) return;

            if (confirm('检测到本地备份，是否恢复之前的数据？（图片将无法恢复，文字内容可恢复）')) {
                try {
                    const backup = JSON.parse(backupStr);
                    const { posts = [], collections = [] } = backup;

                    // 恢复合集
                    for (let col of collections) {
                        // 给合集一个全新的 id，避免冲突（如果原本 id 已存在则覆盖）
                        col.id = col.id || Date.now() + Math.random();
                        await DBMgr.saveCollection(col);
                    }

                    // 恢复帖子（同样重新生成 id 或保留原 id）
                    for (let post of posts) {
                        post.id = post.id || Date.now() + Math.random();
                        // 清除可能残留的图片字段
                        post.images = [];
                        post.image = null;
                        post.postBg = null;
                        await DBMgr.savePost(post);
                    }

                    alert('数据恢复成功！');
                    // 刷新当前视图
                    HomeRenderer.resetAndRender();
                    HtmlHomeRenderer.render();
                } catch (e) {
                    console.error('恢复失败', e);
                    alert('恢复失败，备份文件可能损坏');
                }
            }
        }
    };
    // ======================= 备份管理器结束 =======================

    const DBMgr = {
        dbName: 'LofterArchiveDB', dbVersion: 4,
        db: null,
        init: () => new Promise((resolve, reject) => {
            const request = indexedDB.open(DBMgr.dbName, DBMgr.dbVersion);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('posts')) {
                    const store = db.createObjectStore('posts', { keyPath: 'id' });
                    store.createIndex('tags', 'tags', { multiEntry: true });
                }
                if (!db.objectStoreNames.contains('collections')) db.createObjectStore('collections', { keyPath: 'id' });
                if (!db.objectStoreNames.contains('fonts')) db.createObjectStore('fonts', { keyPath: 'id' });
            };
            request.onsuccess = (event) => { DBMgr.db = event.target.result; resolve(DBMgr.db); }; 
            request.onerror = (event) => reject(event);
        }),
        getAllPostMeta: async () => {
            if(!DBMgr.db) await DBMgr.init();
            return new Promise((resolve) => {
                const tx = DBMgr.db.transaction(['posts'], 'readonly');
                const store = tx.objectStore('posts');
                const metaList = [];
                const request = store.openCursor(); 
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        const p = cursor.value;
                        const tagString = p.tags ? p.tags.join(' ') : '';
                        const searchString = (p.title + (p.content ? p.content.slice(0, 50) : '') + tagString).toLowerCase();
                        metaList.push({ 
                            id: p.id, 
                            date: p.date, 
                            isTop: p.isTop, 
                            type: p.type, 
                            tags: p.tags || [],
                            searchString: searchString, 
                            hasImage: (p.images && p.images.length > 0) || !!p.image
                        });
                        cursor.continue();
                    } else { resolve(metaList); }
                };
            });
        },
        // 新增：获取所有完整帖子（含图片）
        getAllPosts: async () => {
            if(!DBMgr.db) await DBMgr.init();
            return new Promise((resolve, reject) => {
                const tx = DBMgr.db.transaction(['posts'], 'readonly');
                const store = tx.objectStore('posts');
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        },
        getPostsByTag: async (tag) => {
            if(!DBMgr.db) await DBMgr.init();
            return new Promise((resolve) => {
                const tx = DBMgr.db.transaction(['posts'], 'readonly');
                const store = tx.objectStore('posts');
                const index = store.index('tags');
                const request = index.getAll(tag);
                request.onsuccess = (e) => resolve(e.target.result || []);
            });
        },
        getAllTags: async () => {
            if(!DBMgr.db) await DBMgr.init();
            return new Promise((resolve) => {
                const tx = DBMgr.db.transaction(['posts'], 'readonly');
                const store = tx.objectStore('posts');
                const request = store.openCursor();
                const tags = new Set();
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        const p = cursor.value;
                        if (p.tags && Array.isArray(p.tags)) {
                            p.tags.forEach(tag => tags.add(tag));
                        }
                        cursor.continue();
                    } else {
                        resolve(Array.from(tags));
                    }
                };
            });
        },
        getPostsBatch: async (ids) => {
            if(!DBMgr.db) await DBMgr.init();
            return new Promise((resolve) => {
                const tx = DBMgr.db.transaction(['posts'], 'readonly');
                const store = tx.objectStore('posts');
                const results = [];
                let completed = 0;
                if(ids.length === 0) resolve([]);
                ids.forEach(id => {
                    const req = store.get(id);
                    req.onsuccess = (e) => { 
                        results.push(e.target.result); 
                        completed++; 
                        if(completed === ids.length) { 
                            const ordered = ids.map(id => results.find(r => r && r.id === id)).filter(x => x); 
                            resolve(ordered); 
                        } 
                    };
                    req.onerror = () => { completed++; if(completed === ids.length) resolve(results); };
                });
            });
        },
        getPost: async (id) => { 
            if(!DBMgr.db) await DBMgr.init(); 
            return new Promise((resolve) => { 
                const request = DBMgr.db.transaction(['posts'], 'readonly').objectStore('posts').get(id); 
                request.onsuccess = () => resolve(request.result); 
            }); 
        },
        savePost: async (post) => { 
            if(!DBMgr.db) await DBMgr.init(); 
            return new Promise((resolve) => { 
                const tx = DBMgr.db.transaction(['posts'], 'readwrite'); 
                tx.objectStore('posts').put(post); 
                tx.oncomplete = () => {
                    resolve(true);
                    // 备份纯文本数据（异步执行，不阻塞主流程）
                    setTimeout(() => BackupMgr.backup(), 10);
                }; 
            }); 
        },
        deletePost: async (id) => { 
            if(!DBMgr.db) await DBMgr.init(); 
            return new Promise((resolve) => { 
                const tx = DBMgr.db.transaction(['posts'], 'readwrite'); 
                tx.objectStore('posts').delete(id); 
                tx.oncomplete = () => resolve(true); 
            }); 
        },
        getAllCollections: async () => { 
            if(!DBMgr.db) await DBMgr.init(); 
            return new Promise((resolve) => { 
                const request = DBMgr.db.transaction(['collections'], 'readonly').objectStore('collections').getAll(); 
                request.onsuccess = () => resolve(request.result || []); 
            }); 
        },
        saveCollection: async (col) => { 
            if(!DBMgr.db) await DBMgr.init(); 
            return new Promise((resolve) => { 
                const request = DBMgr.db.transaction(['collections'], 'readwrite').objectStore('collections').put(col); 
                request.onsuccess = () => {
                    resolve(true);
                    // 备份纯文本数据
                    setTimeout(() => BackupMgr.backup(), 10);
                }; 
            }); 
        },
        deleteCollection: async (id) => { 
            if(!DBMgr.db) await DBMgr.init(); 
            return new Promise((resolve) => { 
                const tx = DBMgr.db.transaction(['collections'], 'readwrite'); 
                tx.objectStore('collections').delete(id); 
                tx.oncomplete = () => resolve(true); 
            }); 
        },
        saveFont: async (font) => { 
            if(!DBMgr.db) await DBMgr.init(); 
            return new Promise((resolve) => { 
                const tx = DBMgr.db.transaction(['fonts'], 'readwrite'); 
                tx.objectStore('fonts').put(font); 
                tx.oncomplete = () => resolve(true); 
            }); 
        },
        getAllFonts: async () => { 
            if(!DBMgr.db) await DBMgr.init(); 
            return new Promise((resolve) => { 
                const req = DBMgr.db.transaction(['fonts'], 'readonly').objectStore('fonts').getAll(); 
                req.onsuccess = () => resolve(req.result || []); 
            }); 
        },
        deleteFont: async (id) => { 
            if(!DBMgr.db) await DBMgr.init(); 
            return new Promise((resolve) => { 
                const tx = DBMgr.db.transaction(['fonts'], 'readwrite'); 
                tx.objectStore('fonts').delete(id); 
                tx.oncomplete = () => resolve(true); 
            }); 
        },
        showExportYearMenu: async () => {
            const meta = await DBMgr.getAllPostMeta();
            if(meta.length === 0) return alert('没有任何数据');
            const years = new Set(meta.map(m => new Date(m.date).getFullYear()));
            const sortedYears = Array.from(years).sort((a,b) => b-a);
            let html = '';
            sortedYears.forEach(y => { 
                const count = meta.filter(m => new Date(m.date).getFullYear() === y).length; 
                html += `<div class="menu-item" onclick="DBMgr.exportYear(${y})">${y} 年 <span style="font-size:11px;color:#999;margin-left:5px;">(${count}篇)</span></div>`; 
            });
            html += `<div style="height:1px;background:#eee;margin:5px 0;"></div><div class="menu-item" onclick="DBMgr.exportYear('all')" style="color:#ff4d4f;">导出全部 (可能卡顿)</div>`;
            document.getElementById('exportYearOptions').innerHTML = html;
            document.getElementById('exportYearOverlay').style.display = 'flex';
        },
        generateBackupZip: async (year = 'all', onProgress) => {
            if (typeof JSZip === 'undefined') throw new Error('需要网络加载JSZip组件');
            if(!onProgress) onProgress = (msg) => { document.getElementById('loadingText').innerText = msg; };
            
            const zip = new JSZip(); const imagesFolder = zip.folder("images");
            const fullConfig = {}; 
            for (let i = 0; i < localStorage.length; i++) { 
                const key = localStorage.key(i); 
                if (key.startsWith('profile_') || key.startsWith('theme_') || key === 'global_bg' || key === 'gh_config') 
                    fullConfig[key] = localStorage.getItem(key); 
            }
            
            const tx = DBMgr.db.transaction(['collections'], 'readonly');
            const collections = await new Promise(r => tx.objectStore('collections').getAll().onsuccess = e => r(e.target.result));
            
            const exportPosts = [];
            const postTx = DBMgr.db.transaction(['posts'], 'readonly');
            const store = postTx.objectStore('posts');
            const request = store.openCursor();
            let count = 0;
            
            await new Promise((resolve, reject) => {
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        const p = cursor.value;
                        const pYear = new Date(p.date).getFullYear();
                        if (year === 'all' || pYear == year) { 
                            const pCopy = { ...p, images: [], image: null, postBg: null };
                            if (p.images && p.images.length > 0) { 
                                for (let i = 0; i < p.images.length; i++) { 
                                    const blob = p.images[i]; 
                                    const ext = blob.type.split('/')[1] || 'jpg'; 
                                    const fName = `p_${p.id}_${i}.${ext}`; 
                                    imagesFolder.file(fName, blob); 
                                    pCopy.images.push(fName); 
                                } 
                            }
                            if (p.image) { 
                                const ext = p.image.type.split('/')[1] || 'jpg'; 
                                const fName = `p_${p.id}_cover.${ext}`; 
                                imagesFolder.file(fName, p.image); 
                                pCopy.image = fName; 
                            }
                            if (p.postBg) { 
                                const ext = p.postBg.type.split('/')[1] || 'jpg'; 
                                const fName = `p_${p.id}_bg.${ext}`; 
                                imagesFolder.file(fName, p.postBg); 
                                pCopy.postBg = fName; 
                            }
                            exportPosts.push(pCopy); 
                            count++;
                            if (count % 10 === 0) onProgress(`处理中: ${count} 篇...`);
                        }
                        cursor.continue();
                    } else { resolve(); }
                };
                request.onerror = (e) => reject(e);
            });
            
            const data = { version: 51, timestamp: Date.now(), year: year, posts: exportPosts, collections: collections, localStorage: fullConfig };
            zip.file(`data_${year}.json`, JSON.stringify(data));
            
            onProgress('正在压缩...');
            const content = await zip.generateAsync({type:"blob", compression: "DEFLATE"}, (meta) => { onProgress(`打包中 ${meta.percent.toFixed(0)}%`); });
            return content;
        },
        exportYear: async (year) => {
            document.getElementById('exportYearOverlay').style.display = 'none';
            document.getElementById('loadingMask').style.display = 'flex';
            document.getElementById('loadingText').innerText = '准备数据...';
            setTimeout(async () => {
                try {
                    const content = await DBMgr.generateBackupZip(year);
                    saveFileUniversal(content, `Backup_${year}_${new Date().toISOString().slice(0,10)}.zip`);
                } catch(e) { 
                    console.error(e); 
                    alert('导出失败: ' + e.message); 
                    document.getElementById('loadingMask').style.display = 'none'; 
                }
            }, 100);
        },
        exportTextOnly: async () => {
            document.getElementById('loadingMask').style.display = 'flex';
            document.getElementById('loadingText').innerText = '正在导出纯文本...';
            setTimeout(async () => {
                try {
                    const tx = DBMgr.db.transaction(['posts'], 'readonly'); 
                    const store = tx.objectStore('posts');
                    const allPosts = await new Promise(r => store.getAll().onsuccess = e => r(e.target.result));
                    const cleanPosts = allPosts.map(p => { 
                        const { images, image, postBg, ...rest } = p; 
                        return rest; 
                    });
                    const blob = new Blob([JSON.stringify(cleanPosts)], {type: "application/json"});
                    saveFileUniversal(blob, `TextOnly_Backup_${new Date().toISOString().slice(0,10)}.json`);
                } catch(e) { 
                    alert('导出失败: ' + e.message); 
                    document.getElementById('loadingMask').style.display = 'none'; 
                }
            }, 50);
        },
        importData: async (input) => {
            const file = input.files[0]; if(!file) return;
            if(!confirm('导入将覆盖当前数据，确定？')) return;
            await DBMgr.processImport(file);
            input.value = '';
        },
        processImport: async (file) => {
            document.getElementById('loadingMask').style.display = 'flex';
            try {
                if (file.name.toLowerCase().endsWith('.zip')) {
                    document.getElementById('loadingText').innerText = '正在读取备份文件...';
                    const zip = await new JSZip().loadAsync(file);
                    const jsonFile = Object.values(zip.files).find(f => f.name.endsWith('.json') && f.name.includes('data'));
                    if (!jsonFile) throw new Error('压缩包内未找到数据文件 (data_*.json)');
                    const jsonStr = await jsonFile.async('string');
                    const json = JSON.parse(jsonStr);
                    document.getElementById('loadingText').innerText = '正在解压图片资源...';
                    const postsToSave = [];
                    const sourcePosts = json.posts || [];
                    for (let p of sourcePosts) {
                        if (Array.isArray(p.images) && p.images.length > 0) {
                            const blobPromises = p.images.map(async (fileName) => {
                                if (typeof fileName === 'string') {
                                    const imgFile = zip.file("images/" + fileName);
                                    if (imgFile) return await imgFile.async('blob');
                                }
                                return null;
                            });
                            p.images = (await Promise.all(blobPromises)).filter(b => b);
                        }
                        if (p.image && typeof p.image === 'string') {
                            const imgFile = zip.file("images/" + p.image);
                            if (imgFile) p.image = await imgFile.async('blob');
                            else p.image = null;
                        }
                        if (p.postBg && typeof p.postBg === 'string') {
                            const imgFile = zip.file("images/" + p.postBg);
                            if (imgFile) p.postBg = await imgFile.async('blob');
                            else p.postBg = null;
                        }
                        postsToSave.push(p);
                    }
                    document.getElementById('loadingText').innerText = '正在写入数据库...';
                    const tx = DBMgr.db.transaction(['posts', 'collections'], 'readwrite');
                    const postStore = tx.objectStore('posts');
                    const colStore = tx.objectStore('collections');
                    postStore.clear();
                    colStore.clear();
                    if(json.localStorage) {
                        Object.keys(json.localStorage).forEach(key => localStorage.setItem(key, json.localStorage[key]));
                    }
                    if(json.collections) {
                        for (let col of json.collections) colStore.put(col);
                    }
                    for (let p of postsToSave) {
                        postStore.put(p);
                    }
                    tx.oncomplete = () => {
                        alert('恢复成功！');
                        location.reload();
                    };
                    tx.onerror = (e) => {
                        throw new Error('数据库写入失败: ' + e.target.error.message);
                    };
                } else {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const json = JSON.parse(e.target.result);
                            const tx = DBMgr.db.transaction(['posts', 'collections'], 'readwrite');
                            tx.objectStore('posts').clear();
                            tx.objectStore('collections').clear();
                            if(json.localStorage) Object.keys(json.localStorage).forEach(key => localStorage.setItem(key, json.localStorage[key]));
                            if(json.collections) for (let col of json.collections) tx.objectStore('collections').put(col);
                            if(json.posts || Array.isArray(json)) {
                                const posts = json.posts || json;
                                for (let post of posts) { tx.objectStore('posts').put(post); }
                            }
                            tx.oncomplete = () => { alert('恢复成功！'); location.reload(); };
                        } catch(err) {
                            alert('JSON 解析失败: ' + err.message);
                        } finally {
                            document.getElementById('loadingMask').style.display = 'none';
                        }
                    };
                    reader.readAsText(file);
                }
            } catch(err) {
                console.error(err);
                alert('导入失败: ' + err.message);
                document.getElementById('loadingMask').style.display = 'none';
            }
        },
        clearAll: async () => { 
            if(confirm('确定清空？')) { 
                const tx = DBMgr.db.transaction(['posts', 'collections'], 'readwrite'); 
                tx.objectStore('posts').clear(); 
                tx.objectStore('collections').clear(); 
                localStorage.removeItem('full_backup'); // 新增：同时删除备份
                localStorage.clear(); 
                location.reload(); 
            } 
        }
    };

    const Utils = {
        formatDate: (ts) => { 
            const d = new Date(ts); 
            return { 
                day: d.getDate().toString().padStart(2, '0'), 
                ym: `/ ${d.getMonth()+1} ${d.getFullYear()}`, 
                full: `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate()}` 
            }; 
        },
        getCurrentUser: () => { 
            return { 
                name: localStorage.getItem('profile_name') || 'Lofter用户', 
                avatar: localStorage.getItem('profile_avatar') || 'https://api.dicebear.com/7.x/avataaars/svg?seed=Jiang' 
            }; 
        },
        getImgSrc: (imgData) => { 
            if (!imgData) return ''; 
            if (typeof imgData === 'string') return imgData; 
            return URL.createObjectURL(imgData); 
        },
        fileToBase64: (file, callback) => { 
            const reader = new FileReader(); 
            reader.onload = (e) => callback(e.target.result); 
            reader.readAsDataURL(file); 
        },
        compressImage: (file) => {
            return new Promise((resolve) => {
                resolve(file); 
            });
        },
        extractTags: (text) => {
            if (!text) return [];
            const regex = /#([^\s#]+)/g;
            let m, tags = [];
            while ((m = regex.exec(text)) !== null) {
                tags.push(m[1].trim());
            }
            return [...new Set(tags)];
        },
        copyText: (text) => {
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            try {
                document.execCommand('copy');
                alert('设定内容已复制到剪贴板');
            } catch (err) {
                alert('复制失败，请手动选择复制');
            }
            document.body.removeChild(el);
        },
    };

    const Router = { 
        history: ['home'], 
        
        // 点击底栏图标切换
        go: (viewName, navEl) => { 
            if(viewName === 'home') Router.history = ['home']; 
            else if (Router.history[Router.history.length - 1] !== viewName) {
                Router.history.push(viewName); 
            }

            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); 
            if(navEl) navEl.classList.add('active'); 

            document.querySelectorAll('.view').forEach(el => el.classList.remove('active')); 
            const targetView = document.getElementById(`view-${viewName}`);
            if(targetView) targetView.classList.add('active'); 

            if(viewName === 'home') HomeRenderer.checkAndRender(); 
            if(viewName === 'html-home') HtmlHomeRenderer.render(); 
            if(viewName === 'profile') ProfileRenderer.render(); 
        }, 

        // 处理返回逻辑 (防闪烁加固版)
        back: () => { 
            if(Router.history.length > 1) { 
                const currentView = document.querySelector('.view.active');
                const currentViewId = currentView ? currentView.id : '';
                
                // 1. HTML详情页返回：走专用函数处理
                if (currentViewId === 'view-html-detail') {
                    handleHtmlBack();
                    return;
                }
                
                Router.history.pop(); 
                const prev = Router.history[Router.history.length-1];
                
                // 2. 先执行视图切换 (内容还在，遮住底下的白屏)
                document.querySelectorAll('.view').forEach(el => el.classList.remove('active')); 
                const prevView = document.getElementById(`view-${prev}`);
                if(prevView) prevView.classList.add('active'); 

                // 3. 亮起正确的底栏图标
                const navMap = { 'home': 0, 'html-home': 1, 'profile': 3, 'theme': 4 };
                if (navMap[prev] !== undefined) {
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                    const navEl = document.getElementById(`nav-${navMap[prev]}`);
                    if(navEl) navEl.classList.add('active');
                }

                // 4. 【核心：延迟清空】动画播完后才清空内容，彻底消灭闪烁
                if (currentViewId === 'view-detail') {
                    setTimeout(() => {
                        DetailRenderer.currentPostId = null;
                        const dBody = document.getElementById('d-body-content');
                        if(dBody) dBody.innerHTML = '';
                    }, 300);
                }

                if(prev === 'home') HomeRenderer.checkAndRender(); 
                if(prev === 'html-home') HtmlHomeRenderer.render(); 
                if(prev === 'profile') ProfileRenderer.render(); 
            } else { 
                Router.go('home', document.getElementById('nav-0')); 
            } 
        } 
    }; // 这里的 }; 绝对要保留！

    const ContextMenu = { 
        targetId: null, 
        show: (e, id) => { 
            e.preventDefault(); 
            ContextMenu.targetId = id; 
            const isCollectionMode = document.getElementById('view-collection-detail').classList.contains('active');
            let deleteHtml = `<div class="menu-item danger" onclick="ContextMenu.del()">删除帖子</div>`;
            if (isCollectionMode) {
                deleteHtml = `<div class="menu-item danger" onclick="ContextMenu.removeFromCollection()">从合集移除</div>`;
            }
            const menuHtml = `
                <div class="menu-item" onclick="ContextMenu.toggleTop()">置顶/取消置顶</div>
                <div class="menu-item" onclick="ContextMenu.edit()">编辑</div>
                <div class="menu-item" onclick="BatchMgr.enter()">批量管理</div>
                ${deleteHtml}
                <div class="menu-item" onclick="ContextMenu.hide()">取消</div>
            `;
            document.getElementById('contextMenuBody').innerHTML = menuHtml; 
            document.getElementById('contextOverlay').style.display = 'flex'; 
        }, 
        showDetailMenu: (e, id) => { 
            e.stopPropagation(); 
            ContextMenu.targetId = id; 
            const menuHtml = `<div class="menu-item" onclick="ContextMenu.edit()">编辑帖子</div><div class="menu-item" onclick="ContextMenu.addToColSingle(${id})">加入合集</div><div class="menu-item danger" onclick="ContextMenu.delFromDetail()">删除帖子</div><div class="menu-item" onclick="ContextMenu.hide()">取消</div>`; 
            document.getElementById('contextMenuBody').innerHTML = menuHtml; 
            document.getElementById('contextOverlay').style.display = 'flex'; 
        }, 
                // --- 新增：评论操作菜单 ---
        showCommentMenu: (e, commentIdx, isHtml = false) => {
            e.stopPropagation();
            const editFn = isHtml ? `DetailRenderer.editHtmlComment(${commentIdx})` : `DetailRenderer.editComment(${commentIdx})`;
            const delFn = isHtml ? `DetailRenderer.deleteHtmlComment(${commentIdx})` : `DetailRenderer.deleteComment(${commentIdx})`;
            
            const menuHtml = `
                <div class="menu-item" onclick="ContextMenu.hide(); ${editFn}">编辑评论</div>
                <div class="menu-item danger" onclick="ContextMenu.hide(); ${delFn}">删除评论</div>
                <div class="menu-item" onclick="ContextMenu.hide()">取消</div>
            `;
            document.getElementById('contextMenuBody').innerHTML = menuHtml; 
            document.getElementById('contextOverlay').style.display = 'flex'; 
        },
        hide: () => { document.getElementById('contextOverlay').style.display = 'none'; }, 
        del: async () => { 
            if(confirm('彻底删除这条内容?')) { 
                await DBMgr.deletePost(ContextMenu.targetId); 
                HomeRenderer.resetAndRender(); 
                HtmlHomeRenderer.render(); 
                ContextMenu.hide(); 
            } 
        }, 
        removeFromCollection: async () => {
            const colId = ColDetailMgr.currentColId;
            const postId = ContextMenu.targetId;
            if(!colId) return;
            if(confirm('将帖子移出当前合集（不会删除原帖）？')) {
                const cols = await DBMgr.getAllCollections();
                const target = cols.find(c => c.id === colId);
                if (target && target.postIds) {
                    target.postIds = target.postIds.filter(pid => pid !== postId);
                    await DBMgr.saveCollection(target);
                    await ColMgr.openDetail(colId);
                }
                ContextMenu.hide();
            }
        },
        delFromDetail: async () => { 
            if(confirm('删除当前帖子?')) { 
                await DBMgr.deletePost(ContextMenu.targetId); 
                HomeRenderer.resetAndRender(); 
                HtmlHomeRenderer.render(); 
                ContextMenu.hide(); 
                Router.back(); 
            } 
        }, 
        edit: async () => { 
            const post = await DBMgr.getPost(ContextMenu.targetId); 
            Editor.open(post, post.type || 'normal'); 
            ContextMenu.hide(); 
        }, 
        toggleTop: async () => { 
            const post = await DBMgr.getPost(ContextMenu.targetId); 
            post.isTop = !post.isTop;
            await DBMgr.savePost(post); 
            HomeRenderer.resetAndRender(); 
            HtmlHomeRenderer.render(); 
            ContextMenu.hide(); 
        }, 
        addToColSingle: (id) => { ContextMenu.showCollectionSelector([id]); }, 
        showCollectionSelector: async (postIds) => { 
            const cols = await DBMgr.getAllCollections(); 
            if(cols.length === 0) { 
                ContextMenu.hide(); 
                return alert('请先去"合集"页创建一个合集'); 
            } 
            const listEl = document.getElementById('colSelectOptions'); 
            listEl.innerHTML = cols.map(c => `<div class="menu-item" onclick="ContextMenu.executeAdd([${postIds}], ${c.id})">${c.title}</div>`).join(''); 
            document.getElementById('colSelectOverlay').style.display = 'flex'; 
            ContextMenu.hide(); 
        }, 
        executeAdd: async (postIds, colId) => { 
            const col = await DBMgr.getAllCollections(); 
            const target = col.find(c => c.id === colId); 
            if(!target.postIds) target.postIds = []; 
            for(let pid of postIds) { 
                if(!target.postIds.includes(pid)) target.postIds.push(pid); 
            } 
            await DBMgr.saveCollection(target); 
            document.getElementById('colSelectOverlay').style.display = 'none'; 
            alert('已加入合集'); 
        } 
    };
    
        // 加号菜单：发普通 / HTML
const PlusMenu = {
    show: () => {
        const html = `
            <div class="menu-item" onclick="PlusMenu.newPost()">发布帖子</div>
            <div class="menu-item" onclick="PlusMenu.newHtml()">发布HTML</div>
            <div class="menu-item" onclick="PlusMenu.newChar()">发布角色卡</div>
            <div class="menu-item" onclick="PlusMenu.newLink()">发布链接</div>
            <div class="menu-item" onclick="ContextMenu.hide()">取消</div>
        `;
        document.getElementById('contextMenuBody').innerHTML = html;
        document.getElementById('contextOverlay').style.display = 'flex';
    },
    newPost: () => { ContextMenu.hide(); Editor.open(null, 'normal'); },
    newHtml: () => { ContextMenu.hide(); Editor.open(null, 'html'); },
    newChar: () => { ContextMenu.hide(); Editor.open(null, 'char'); }, // 稍后做
    newLink: () => { ContextMenu.hide(); Editor.open(null, 'link'); }  // 稍后做
};

    const ColDetailMgr = { 
        currentColId: null, postIds: [], 
        saveStat: async (el, type) => { 
            const val = el.innerText; 
            const cols = await DBMgr.getAllCollections(); 
            const target = cols.find(c => c.id === ColDetailMgr.currentColId); 
            if(target) { 
                if(type === 'sub') target.subCount = val; 
                if(type === 'hot') target.hotCount = val; 
                if(type === 'view') target.viewCount = val; 
                await DBMgr.saveCollection(target); 
            } 
        },
        startReading: () => { 
            if(!ColDetailMgr.postIds || ColDetailMgr.postIds.length === 0) return alert('合集是空的'); 
            DetailRenderer.open(ColDetailMgr.postIds[0], ColDetailMgr.currentColId); 
        },
        showMenu: () => { 
            const html = `<div class="menu-item" onclick="ColMgr.editFromDetail()">编辑合集</div><div class="menu-item danger" onclick="ColDetailMgr.deleteCurrent()">删除合集</div><div class="menu-item" onclick="ContextMenu.hide()">取消</div>`; 
            document.getElementById('contextMenuBody').innerHTML = html; 
            document.getElementById('contextOverlay').style.display = 'flex'; 
        },
        deleteCurrent: async () => { 
            if(confirm('确定要删除这个合集吗？')) { 
                await DBMgr.deleteCollection(ColDetailMgr.currentColId); 
                ContextMenu.hide(); 
                Router.go('profile'); 
                setTimeout(() => ProfileRenderer.switchTab('cols'), 100); 
            } 
        },
        toggleSubscribe: (btn) => { 
            if(btn.innerText === '订阅合集') { 
                btn.innerText = '已订阅'; 
                btn.style.background = '#ccc'; 
                btn.style.color = '#fff'; 
            } else { 
                btn.innerText = '订阅合集'; 
                btn.style.background = '#333'; 
                btn.style.color = '#fff'; 
            } 
        }
    };

    const DetailRenderer = {
        currentPostId: null, contextColId: null,
        open: async (id, colId = null) => {
                    // --- 彻底清空上一次的内容，防止干扰 ---
            if (Router.history[Router.history.length - 1] !== 'detail') Router.history.push('detail');
            DetailRenderer.currentPostId = id; 
            DetailRenderer.contextColId = colId;
            const post = await DBMgr.getPost(id); 
            if(!post) return;
            
            if(post.type === 'html') { 
                DetailRenderer.openHtmlDetail(post); 
                return; 
            }

            const user = Utils.getCurrentUser(); 
            document.getElementById('d-avatar-img').src = user.avatar; 
            document.getElementById('d-username').innerText = user.name;
            const detailView = document.getElementById('view-detail');
            
            if(post.postBg) {
                detailView.style.backgroundImage = `url(${Utils.getImgSrc(post.postBg)})`;
            } else {
                detailView.style.backgroundImage = ''; 
            }

            const bodyEl = document.getElementById('d-body-content'); 
            let html = ''; 
            const images = post.images || (post.image ? [post.image] : []);

            if (post.type === 'char' && post.charData) {
                const c = post.charData;
                html += `
                    <div style="padding:20px;">
                        <div style="display:flex; gap:15px; align-items:flex-start; margin-bottom:20px;">
                            ${images.length > 0 ? `<img src="${Utils.getImgSrc(images[0])}" style="width:120px; height:160px; object-fit:cover; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1);" onclick="ImageViewer.open(this.src)">` : ''}
                            <div style="flex:1;">
                                <h2 style="margin:0 0 10px 0; color:#333;">${c.name || '未命名角色'}</h2>
                                <div style="font-size:0.9rem; color:#666; line-height:1.8;">
                                    <p><b>性别：</b>${c.gender || '未知'}</p>
                                    <p><b>年龄：</b>${c.age || '未知'}</p>
                                    <p><b>身份：</b>${c.identity || '暂无'}</p><button onclick="DetailRenderer.copyFullChar(${post.id})" style="margin-top:8px; background:#333; color:#fff; border:none; padding:4px 10px; border-radius:12px; font-size:0.75rem; cursor:pointer;">复制设定文本</button>
                                </div>
                            </div>
                        </div>
                        <div style="background:rgba(0,0,0,0.03); padding:15px; border-radius:10px; line-height:1.6; color:#444; font-size:1rem;">
                            <div style="font-weight:bold; margin-bottom:8px; color:#333; border-left:3px solid #333; padding-left:8px;">详细设定</div>
                            ${parseMarkdoom(c.desc || '暂无详细描述')}
                        </div>
                    </div>
                `;
            } else {
                if(images.length > 0) {
                    let sliderItems = images.map(blob => `<div class="d-slider-item"><img src="${Utils.getImgSrc(blob)}" onclick="ImageViewer.open(this.src)"></div>`).join('');
                    html += `<div class="d-slider-container"><div class="d-slider">${sliderItems}</div>${images.length > 1 ? `<div class="d-slider-indicator">1 / ${images.length}</div>` : ''}</div>`;
                    if(post.title) html += `<div style="padding:15px 20px 0; font-size:1.33rem; font-weight:bold;">${post.title}</div>`;
                    if(post.content) html += `<div class="d-content">${parseMarkdoom(post.content)}</div>`;
                } else {
                    if(post.title) html += `<div style="padding:20px 20px 0; font-size:1.33rem; font-weight:bold;">${post.title}</div>`;
                    html += `<div class="d-content text-mode">${parseMarkdoom(post.content)}</div>`;
                }
            }
            
            html += '<div style="height:60px;"></div>';
            bodyEl.innerHTML = html; 

            const tagsContainer = document.getElementById('d-tags-container');
            if (post.tags && post.tags.length > 0) {
                tagsContainer.innerHTML = post.tags.map(tag => `<span class="d-tag" onclick="HomeRenderer.filterByTag('${tag}')">#${tag}</span>`).join('');
            } else {
                tagsContainer.innerHTML = '';
            }
            document.getElementById('d-date').innerText = Utils.formatDate(post.date).full; 
            DetailRenderer.renderComments(post);
            
            const inputBar = document.getElementById('float-input-bar');
            const toolbar = document.getElementById('reading-toolbar');
            if(colId) { 
                inputBar.style.display = 'none'; 
                toolbar.style.display = 'flex'; 
                document.getElementById('d-inline-input-area').innerHTML = `<div class="static-input-bar"><input type="text" id="inline-comment-input" placeholder="评论..."><div class="send-btn" onclick="DetailRenderer.addComment()">发送</div></div>`; 
                const ids = ColDetailMgr.postIds; 
                const idx = ids.indexOf(id); 
                document.getElementById('rt-prev').className = idx <= 0 ? 'rt-btn disabled' : 'rt-btn';
                document.getElementById('rt-next').className = (idx === -1 || idx >= ids.length - 1) ? 'rt-btn disabled' : 'rt-btn';
            } else { 
                inputBar.style.display = 'flex'; 
                toolbar.style.display = 'none'; 
                document.getElementById('d-inline-input-area').innerHTML = ''; 
            }
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active')); 
            document.getElementById('view-detail').classList.add('active');
        },
                openHtmlDetail: (post) => {
            DetailRenderer.currentPostId = post.id; 
                        // 确保普通详情页不被渲染
            document.getElementById('view-detail').classList.remove('active');
            const container = document.getElementById('view-html-detail');
            const iframe = document.getElementById('html-detail-iframe');
            iframe.srcdoc = post.content;
            const user = Utils.getCurrentUser();
            const comments = post.comments || [];
            
            // 渲染评论列表，使用三个点图标代替按钮
            let commentsHtml = comments.length === 0 ? 
                '<div style="text-align:center; color:#ccc; font-size:0.89rem; padding:10px;">暂无评论</div>' : 
                comments.map((c, index) => `
                    <div style="margin-bottom:15px; font-size:0.96rem; display:flex; justify-content:space-between; align-items:flex-start;">
                        <div style="flex:1;">
                            <span style="font-weight:bold; color:#333;">${user.name}:</span> 
                            <span id="html-comment-text-${index}" style="color:#555;">${c.text}</span>
                        </div>
                        <!-- 三个点菜单 -->
                        <div style="margin-left:10px; padding: 5px; cursor:pointer;" onclick="ContextMenu.showCommentMenu(event, ${index}, true)">
                            <svg class="icon" style="width:14px; color:#ccc;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="5" r="1.5"/><circle cx="12" cy="19" r="1.5"/></svg>
                        </div>
                    </div>
                `).join('');
            
            const listEl = document.getElementById('html-comments-list-simple');
            if(listEl) listEl.innerHTML = commentsHtml;
            
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            container.classList.add('active');
            if (!Router.history.includes('html-detail')) Router.history.push('html-detail');
        },
        toggleHtmlComments: (show) => {
            const sheet = document.getElementById('html-comment-sheet');
            const overlay = document.getElementById('html-sheet-overlay');
            const currentState = sheet.classList.contains('active');
            const shouldShow = show !== undefined ? show : !currentState;
            if (shouldShow) {
                sheet.classList.add('active');
                overlay.classList.add('active');
            } else {
                sheet.classList.remove('active');
                overlay.classList.remove('active');
            }
        },
        copyHtml: async () => {
            const post = await DBMgr.getPost(DetailRenderer.currentPostId);
            if (!post || !post.content) return alert('内容为空');
            try {
                const textarea = document.createElement('textarea');
                textarea.value = post.content;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('HTML 代码已复制');
            } catch (err) {
                console.error('复制失败:', err);
                alert('复制失败，请手动复制');
            }
        },
        renderComments: (post) => {
            const listEl = document.getElementById('d-comments-list');
            if (!post.comments || post.comments.length === 0) {
                listEl.innerHTML = '<div style="text-align:center; color:#eee;">暂无评论</div>';
                return;
            }
            const user = Utils.getCurrentUser();
            listEl.innerHTML = post.comments.map((c, index) => `
                <div class="comment-item" id="comment-${index}">
                    <img src="${user.avatar}" class="c-avatar">
                    <div class="c-right">
                        <div class="c-top">
                            <span>${user.name}</span>
                            <div class="c-actions" style="padding: 5px; cursor:pointer;" onclick="ContextMenu.showCommentMenu(event, ${index})">
    <svg class="icon" style="width:16px; color:#999;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="5" r="1.5"/><circle cx="12" cy="19" r="1.5"/></svg>
</div>
                        </div>
                        <div class="c-text" id="comment-text-${index}">${c.text}</div>
                        <div class="c-date">${Utils.formatDate(c.date).full}</div>
                    </div>
                </div>
            `).join('');
        },
        deleteComment: async (index) => {
            if (!confirm('确定要删除这条评论吗？')) return;
            const post = await DBMgr.getPost(DetailRenderer.currentPostId);
            if (!post.comments || index >= post.comments.length) return;
            post.comments.splice(index, 1);
            await DBMgr.savePost(post);
            DetailRenderer.renderComments(post);
        },
        editComment: (index) => {
            const commentEl = document.getElementById(`comment-text-${index}`);
            if (!commentEl) return;
            DBMgr.getPost(DetailRenderer.currentPostId).then(async (post) => {
                if (!post.comments || index >= post.comments.length) return;
                const originalText = post.comments[index].text;
                commentEl.innerHTML = `
                    <input type="text" class="c-edit-input" id="edit-input-${index}" value="${originalText.replace(/"/g, '&quot;')}" autofocus>
                    <div class="c-edit-buttons">
                        <button class="c-edit-btn c-edit-save" onclick="DetailRenderer.saveCommentEdit(${index})">保存</button>
                        <button class="c-edit-btn c-edit-cancel" onclick="DetailRenderer.cancelCommentEdit(${index}, '${originalText.replace(/'/g, "\\'")}')">取消</button>
                    </div>
                `;
                setTimeout(() => {
                    const input = document.getElementById(`edit-input-${index}`);
                    if (input) {
                        input.focus();
                        input.select();
                    }
                }, 50);
            });
        },
        saveCommentEdit: async (index) => {
            const input = document.getElementById(`edit-input-${index}`);
            if (!input) return;
            const newText = input.value.trim();
            if (!newText) {
                alert('评论内容不能为空');
                return;
            }
            const post = await DBMgr.getPost(DetailRenderer.currentPostId);
            if (!post.comments || index >= post.comments.length) return;
            post.comments[index].text = newText;
            post.comments[index].date = Date.now();
            await DBMgr.savePost(post);
            DetailRenderer.renderComments(post);
        },
        cancelCommentEdit: (index, originalText) => {
            const commentEl = document.getElementById(`comment-text-${index}`);
            if (commentEl) {
                commentEl.innerHTML = originalText;
            }
        },
        deleteHtmlComment: async (index) => {
            if (!confirm('确定要删除这条评论吗？')) return;
            const post = await DBMgr.getPost(DetailRenderer.currentPostId);
            if (!post.comments || index >= post.comments.length) return;
            post.comments.splice(index, 1);
            await DBMgr.savePost(post);
            const user = Utils.getCurrentUser();
            const comments = post.comments || [];
            const listEl = document.getElementById('html-comments-list-simple');
            let commentsHtml = comments.length === 0 ? 
                '<div style="text-align:center; color:#ccc; font-size:0.89rem; padding:10px;">暂无评论</div>' : 
                comments.map((c, idx) => `
                    <div style="margin-bottom:10px; font-size:0.96rem; display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <span style="font-weight:bold;">${user.name}:</span> 
                            <span id="html-comment-text-${idx}">${c.text}</span>
                        </div>
                        <div style="display:flex; gap:5px; margin-left:10px;">
                            <button onclick="DetailRenderer.editHtmlComment(${idx})" style="background:none; border:none; color:#1890ff; font-size:0.81rem; cursor:pointer;">编辑</button>
                            <button onclick="DetailRenderer.deleteHtmlComment(${idx})" style="background:none; border:none; color:#ff4d4f; font-size:0.81rem; cursor:pointer;">删除</button>
                        </div>
                    </div>
                `).join('');
            listEl.innerHTML = commentsHtml;
        },
        editHtmlComment: async (index) => {
            const post = await DBMgr.getPost(DetailRenderer.currentPostId);
            if (!post.comments || index >= post.comments.length) return;
            const originalText = post.comments[index].text;
            const commentElement = document.getElementById(`html-comment-text-${index}`).parentElement.parentElement;
            commentElement.innerHTML = `
                <div style="width:100%;">
                    <input type="text" id="html-edit-input-${index}" value="${originalText.replace(/"/g, '&quot;')}" style="width:100%; padding:5px; margin-bottom:5px; border:1px solid #e0e0e0; border-radius:3px;">
                    <div style="display:flex; gap:5px; justify-content:flex-end;">
                        <button onclick="DetailRenderer.saveHtmlCommentEdit(${index})" style="background:#333; color:white; border:none; padding:3px 8px; border-radius:3px; font-size:0.81rem; cursor:pointer;">保存</button>
                        <button onclick="DetailRenderer.cancelHtmlCommentEdit(${index}, '${originalText.replace(/'/g, "\\'")}')" style="background:#f0f0f0; color:#666; border:none; padding:3px 8px; border-radius:3px; font-size:0.81rem; cursor:pointer;">取消</button>
                    </div>
                </div>
            `;
            setTimeout(() => {
                const input = document.getElementById(`html-edit-input-${index}`);
                if (input) {
                    input.focus();
                    input.select();
                }
            }, 50);
        },
                saveHtmlCommentEdit: async (index) => {
            const input = document.getElementById(`html-edit-input-${index}`);
            if (!input) return;
            const newText = input.value.trim();
            if (!newText) return alert('内容不能为空');
            
            const post = await DBMgr.getPost(DetailRenderer.currentPostId);
            if (!post.comments || index >= post.comments.length) return;
            
            post.comments[index].text = newText;
            post.comments[index].date = Date.now();
            await DBMgr.savePost(post);
            
            // 重新刷新整个 HTML 评论列表，确保 UI 统一
            DetailRenderer.openHtmlDetail(post);
        },
        cancelHtmlCommentEdit: (index, originalText) => {
            const commentElement = document.getElementById(`html-edit-input-${index}`).parentElement.parentElement;
            const user = Utils.getCurrentUser();
            commentElement.innerHTML = `
                <div style="margin-bottom:10px; font-size:0.96rem; display:flex; justify-content:space-between; align-items:flex-start;">
                    <div>
                        <span style="font-weight:bold;">${user.name}:</span> 
                        <span id="html-comment-text-${index}">${originalText}</span>
                    </div>
                    <div style="display:flex; gap:5px; margin-left:10px;">
                        <button onclick="DetailRenderer.editHtmlComment(${index})" style="background:none; border:none; color:#1890ff; font-size:0.81rem; cursor:pointer;">编辑</button>
                        <button onclick="DetailRenderer.deleteHtmlComment(${index})" style="background:none; border:none; color:#ff4d4f; font-size:0.81rem; cursor:pointer;">删除</button>
                    </div>
                </div>
            `;
        },
        addComment: async () => { 
            let text = ''; 
            const floatInput = document.getElementById('comment-input'); 
            const inlineInput = document.getElementById('inline-comment-input'); 
            if (inlineInput && document.body.contains(inlineInput) && inlineInput.offsetParent !== null) { 
                text = inlineInput.value; 
                inlineInput.value = ''; 
            } else if (floatInput && floatInput.value) { 
                text = floatInput.value; 
                floatInput.value = ''; 
            } 
            if(!text) return; 
            const post = await DBMgr.getPost(DetailRenderer.currentPostId); 
            if(!post.comments) post.comments = []; 
            post.comments.push({ text: text, date: Date.now() }); 
            await DBMgr.savePost(post); 
            DetailRenderer.renderComments(post); 
            if(!document.getElementById('d-inline-input-area').innerHTML) { 
                setTimeout(() => { 
                    document.getElementById('view-detail').scrollTop = document.getElementById('view-detail').scrollHeight; 
                }, 100); 
            } 
        },
                copyFullChar: async (id) => {
            const p = await DBMgr.getPost(id);
            if(!p || !p.charData) return;
            const c = p.charData;
            // 拼装你要求的格式
            const text = `【姓名】${c.name || '未命名'}\n【性别】${c.gender || '未知'}\n【年龄】${c.age || '未知'}\n【身份】${c.identity || '暂无'}\n【详细设定】\n${c.desc || ''}`;
            Utils.copyText(text);
        },
         addHtmlComment: async () => { 
            const input = document.getElementById('html-comment-input'); 
            const text = input.value.trim(); 
            if(!text) return; 
            
            const post = await DBMgr.getPost(DetailRenderer.currentPostId); 
            if(!post.comments) post.comments = []; 
            post.comments.push({ text: text, date: Date.now() }); 
            await DBMgr.savePost(post); 
            
            input.value = ''; 
            // 重新刷新列表，自动带上“三个点”
            DetailRenderer.openHtmlDetail(post);
            
            // 自动滚动到底部看新评论
            setTimeout(() => {
                const body = document.querySelector('.hcs-body');
                if(body) body.scrollTop = body.scrollHeight;
            }, 100);
        },
        nextPost: () => { 
            if(!DetailRenderer.contextColId) return; 
            const ids = ColDetailMgr.postIds; 
            const idx = ids.indexOf(DetailRenderer.currentPostId); 
            if(idx !== -1 && idx < ids.length - 1) DetailRenderer.open(ids[idx+1], DetailRenderer.contextColId); 
        },
        prevPost: () => { 
            if(!DetailRenderer.contextColId) return; 
            const ids = ColDetailMgr.postIds; 
            const idx = ids.indexOf(DetailRenderer.currentPostId); 
            if(idx > 0) DetailRenderer.open(ids[idx-1], DetailRenderer.contextColId); 
        },
        showDirectory: async () => { 
            const listEl = document.getElementById('dir-list-container'); 
            const ids = ColDetailMgr.postIds; 
            let html = ''; 
            const batchPosts = await DBMgr.getPostsBatch(ids); 
            batchPosts.forEach(p => { 
                const isActive = p.id === DetailRenderer.currentPostId; 
                const title = p.title || (p.content ? p.content.substring(0, 20) + '...' : '无标题'); 
                html += `<div class="dir-item ${isActive?'active':''}" onclick="DetailRenderer.jumpFromDir(${p.id})"><span>${title}</span></div>`; 
            }); 
            listEl.innerHTML = html; 
            document.getElementById('dir-overlay').style.display = 'flex'; 
        },
        jumpFromDir: (id) => { 
            document.getElementById('dir-overlay').style.display = 'none'; 
            DetailRenderer.open(id, DetailRenderer.contextColId); 
        }
    };
    
const Editor = {
    currentImages: [], currentId: null, currentType: 'normal', currentPostBg: null, currentColId: null,
    currentTags: [], 
    
    open: async (post, type = 'normal') => { 
        Editor.currentType = type; 
        document.getElementById('post-title').value = ''; 
        document.getElementById('post-content').value = ''; 
        document.getElementById('char-name').value = '';
        document.getElementById('char-gender').value = '';
        document.getElementById('char-age').value = '';
        document.getElementById('char-identity').value = '';
        document.getElementById('char-desc').value = '';
        document.getElementById('link-url').value = '';
                const htmlCatInput = document.getElementById('work-category-std');
        if(htmlCatInput) htmlCatInput.style.display = (type === 'html') ? 'block' : 'none';
        if(post && type === 'html' && htmlCatInput) htmlCatInput.value = post.workCategory || '';

        Editor.currentImages = []; 
        Editor.currentId = null; 
        Editor.currentPostBg = null; 
        Editor.currentColId = null;
        Editor.currentTags = []; 
        
        document.getElementById('editor-bg-btn').classList.remove('has-bg'); 
        document.getElementById('editor-col-btn').classList.remove('active'); 
        document.getElementById('editor-col-text').innerText = '+ 加入合集';
        document.getElementById('tags-preview').innerHTML = '';
        
        const standardField = document.getElementById('field-standard');
        const charField = document.getElementById('field-char');
        const linkField = document.getElementById('field-link');
        const imgBtn = document.getElementById('img-upload-btn');
        const wordCountEl = document.getElementById('word-count-display');

        standardField.style.display = 'none';
        charField.style.display = 'none';
        linkField.style.display = 'none';
        wordCountEl.style.display = 'none';
        imgBtn.style.display = 'flex'; 

        if (type === 'char') {
            charField.style.display = 'block';
        } else if (type === 'link') {
            linkField.style.display = 'block';
            imgBtn.style.display = 'none'; 
        } else {
            standardField.style.display = 'block';
            wordCountEl.style.display = 'block';
            if (type === 'html') imgBtn.style.display = 'none';
        }
        
        if(post) { 
            Editor.currentId = post.id; 
            document.getElementById('post-title').value = post.title || ''; 
            if(type === 'char' && post.charData) {
                document.getElementById('char-name').value = post.charData.name || '';
                document.getElementById('char-gender').value = post.charData.gender || '';
                document.getElementById('char-age').value = post.charData.age || '';
                document.getElementById('char-identity').value = post.charData.identity || '';
                document.getElementById('char-desc').value = post.charData.desc || '';
            } else if(type === 'link') {
                document.getElementById('link-url').value = post.content || '';
            } else {
                document.getElementById('post-content').value = post.content || ''; 
            }

            if(post.images && post.images.length > 0) Editor.currentImages = [...post.images]; 
            if(post.postBg) { 
                Editor.currentPostBg = post.postBg; 
                document.getElementById('editor-bg-btn').classList.add('has-bg'); 
            }
            if(post.tags) { Editor.currentTags = [...post.tags]; Editor.renderTagsPreview(); }
            
            const cols = await DBMgr.getAllCollections(); 
            const parentCol = cols.find(c => c.postIds && c.postIds.includes(post.id)); 
            if(parentCol) Editor.selectCollection(parentCol.id, parentCol.title);
        } 
        Editor.renderGallery(); 
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active')); 
        document.getElementById('view-editor').classList.add('active'); 
        if (!Router.history.includes('editor')) Router.history.push('editor');
    },

    publish: async () => { 
        const title = document.getElementById('post-title').value; 
        let content = '', charData = null, workCategory = '', linkLabel = '';

                if (Editor.currentType === 'char') {
            charData = { name: document.getElementById('char-name').value, gender: document.getElementById('char-gender').value, age: document.getElementById('char-age').value, identity: document.getElementById('char-identity').value, desc: document.getElementById('char-desc').value };
            content = charData.desc;
            workCategory = document.getElementById('char-category').value.trim();
        } else if (Editor.currentType === 'link') {
            content = document.getElementById('link-url').value;
            workCategory = document.getElementById('link-category').value.trim();
            linkLabel = document.getElementById('link-label').value.trim();
        } else {
            content = document.getElementById('post-content').value;
            // --- 新增：如果是 HTML 作品，抓取它的专用分类框 ---
            if (Editor.currentType === 'html') {
                const hCat = document.getElementById('work-category-std');
                workCategory = hCat ? hCat.value.trim() : '';
            }
        }

        if(!content && !title && Editor.currentImages.length === 0) return alert('请填写内容');
        const postId = Editor.currentId || Date.now();
        let allTags = [...Editor.currentTags];
        if (Editor.currentType === 'normal' || Editor.currentType === 'char') {
            allTags = [...new Set([...allTags, ...Utils.extractTags(content)])];
        }
        if(allTags.length === 0) allTags.push('未分类');

        const post = { id: postId, type: Editor.currentType, title, content, charData, workCategory: workCategory || '未分类', linkLabel, images: Editor.currentImages, date: Date.now(), tags: allTags, comments: [] };
        await DBMgr.savePost(post); 
        if(Editor.currentType === 'normal') Router.go('home'); else { Router.go('html-home'); HtmlHomeRenderer.switchTab(Editor.currentType); }
    },

    updateWordCount: () => { 
        const content = document.getElementById('post-content').value; 
        const el = document.getElementById('word-count-display');
        if(el) el.innerText = content.length + ' 字'; 
    },
    handleImages: async (input) => { 
        if(input.files) { 
            for (let file of input.files) { 
                const compressed = await Utils.compressImage(file); 
                Editor.currentImages.push(compressed); 
            } 
            Editor.renderGallery(); 
        } 
    },
    handlePostBg: async (input) => { 
        if(input.files && input.files[0]) { 
            Editor.currentPostBg = await Utils.compressImage(input.files[0]); 
            document.getElementById('editor-bg-btn').classList.add('has-bg'); 
        } 
    },
    addTagFromInput: () => {
        const input = document.getElementById('post-tags-input');
        const val = input.value.trim();
        if(val) { Editor.currentTags.push(val); Editor.renderTagsPreview(); input.value = ''; }
    },
    renderTagsPreview: () => {
        document.getElementById('tags-preview').innerHTML = Editor.currentTags.map(t => `<span class="post-tag">#${t} <span onclick="Editor.removeTag('${t}')">×</span></span>`).join('');
    },
    removeTag: (tag) => { Editor.currentTags = Editor.currentTags.filter(t => t !== tag); Editor.renderTagsPreview(); },
    renderGallery: () => {
        const gallery = document.getElementById('editor-gallery');
        const btn = document.getElementById('img-upload-btn');
        if(!gallery || !btn) return;
        gallery.querySelectorAll('.editor-img-item').forEach(el => el.remove());
        Editor.currentImages.forEach((img, idx) => {
            const div = document.createElement('div');
            div.className = 'editor-img-item';
            div.innerHTML = `<img src="${Utils.getImgSrc(img)}"><div class="editor-img-remove" onclick="Editor.removeImage(${idx})">×</div>`;
            gallery.insertBefore(div, btn);
        });
    },
    removeImage: (idx) => { Editor.currentImages.splice(idx, 1); Editor.renderGallery(); },
    openColPicker: async () => { 
        const cols = await DBMgr.getAllCollections(); 
        document.getElementById('colSelectOptions').innerHTML = cols.map(c => `<div class="menu-item" onclick="Editor.selectCollection(${c.id}, '${c.title}')">${c.title}</div>`).join(''); 
        document.getElementById('colSelectOverlay').style.display = 'flex'; 
    },
    selectCollection: (id, title) => { Editor.currentColId = id; document.getElementById('editor-col-text').innerText = title; document.getElementById('editor-col-btn').classList.add('active'); document.getElementById('colSelectOverlay').style.display = 'none'; }
};

  const HomeRenderer = {
    layout: 0,
    allMeta: [],
    currentIndex: 0,
    BATCH_SIZE: 15,
    observer: null,
    sortOrder: 'desc',
    filterType: 'all',
    isLoading: false,
    currentTag: null,        // 单标签模式
    currentTagList: [],      // 多标签模式
    currentColId: null, // 记录当前筛选的合集ID

    layoutIcons: [
        '<path d="M3 12h18M3 6h18M3 18h18"/>',
        '<rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>',
        '<rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect>'
    ],

    toggleLayout: () => {
        HomeRenderer.layout = (HomeRenderer.layout + 1) % 3;
        HomeRenderer.updateIcon();
        HomeRenderer.resetAndRender();
    },

    updateIcon: () => {
        document.getElementById('layout-icon').innerHTML = HomeRenderer.layoutIcons[HomeRenderer.layout];
    },

        showFilterMenu: async () => { 
            // 获取所有合集
            const cols = await DBMgr.getAllCollections();

            let html = `<div class="menu-section-title">排序方式</div>
                <div class="menu-item ${HomeRenderer.sortOrder==='desc'?'active':''}" onclick="HomeRenderer.setSort('desc')">最新发布</div>
                <div class="menu-item ${HomeRenderer.sortOrder==='asc'?'active':''}" onclick="HomeRenderer.setSort('asc')">最早发布</div>
                <div class="menu-section-title">内容筛选</div>
                <div class="menu-item ${HomeRenderer.filterType==='all'?'active':''}" onclick="HomeRenderer.setFilter('all')">全部内容</div>
                <div class="menu-item ${HomeRenderer.filterType==='image'?'active':''}" onclick="HomeRenderer.setFilter('image')">仅看图片</div>
                <div class="menu-item ${HomeRenderer.filterType==='text'?'active':''}" onclick="HomeRenderer.setFilter('text')">仅看文字</div>`;
            
            if (cols.length > 0) {
                html += `<div class="menu-section-title">合集筛选</div>`;
                html += `<div class="menu-item ${HomeRenderer.currentColId===null?'active':''}" onclick="HomeRenderer.setColFilter(null)">全部帖子</div>`;
                cols.forEach(c => {
                    html += `<div class="menu-item ${HomeRenderer.currentColId===c.id?'active':''}" onclick="HomeRenderer.setColFilter(${c.id})">${c.title}</div>`;
                });
            }
            
            html += `<div class="menu-item" style="color:#666;margin-top:10px;" onclick="ContextMenu.hide()">关闭</div>`;
            document.getElementById('contextMenuBody').innerHTML = html; 
            document.getElementById('contextOverlay').style.display = 'flex';
        },

    setSort: (order) => { 
        HomeRenderer.sortOrder = order; 
        ContextMenu.hide(); 
        HomeRenderer.resetAndRender(); 
    },

    setFilter: (type) => { 
        HomeRenderer.filterType = type; 
        ContextMenu.hide(); 
        HomeRenderer.resetAndRender(); 
    },

    // 更新顶部“当前标签”提示条
    updateTagBar: () => {
        const bar = document.getElementById('tag-active-bar');
        const textSpan = document.getElementById('tag-active-text');
        if (!bar || !textSpan) return;

        // 如果有多标签，就显示多个可单独删除的标签
        if (HomeRenderer.currentTagList && HomeRenderer.currentTagList.length) {
            textSpan.innerHTML = HomeRenderer.currentTagList.map(tag =>
                `<span style="margin-right:6px;">
                    #${tag}
                    <span style="margin-left:2px; cursor:pointer;"
                          onclick="event.stopPropagation(); HomeRenderer.removeOneTag('${tag}')">×</span>
                </span>`
            ).join('');
            bar.style.display = 'block';
        }
        // 没有多标签，但有单标签（菜单或点卡片时的旧逻辑）
        else if (HomeRenderer.currentTag) {
            textSpan.textContent = '#' + HomeRenderer.currentTag;
            bar.style.display = 'block';
        }
        // 没有任何标签筛选
        else {
            bar.style.display = 'none';
        }
    },
        // 筛选合集的功能
        setColFilter: (colId) => {
            HomeRenderer.currentColId = colId;
            ContextMenu.hide();
            
            const bar = document.getElementById('col-active-bar');
            const textSpan = document.getElementById('col-active-text');
            
            if (colId) {
                // 如果选了合集，去找这个合集的名字显示出来
                DBMgr.getAllCollections().then(cols => {
                    const target = cols.find(c => c.id === colId);
                    if (textSpan) textSpan.textContent = target ? target.title : '未命名合集';
                    if (bar) bar.style.display = 'block';
                });
            } else {
                if (bar) bar.style.display = 'none';
            }
            HomeRenderer.resetAndRender();
        },
        
    // 漏斗菜单里选标签（单标签模式）
    setTagFilter: (tag) => { 
        HomeRenderer.currentTag = tag; 
        HomeRenderer.currentTagList = [];   // 菜单选择时仅用单标签
        ContextMenu.hide(); 
        HomeRenderer.updateTagBar();
        HomeRenderer.resetAndRender(); 
    },

    // 在卡片 / 详情页点击标签时调用（单标签模式）
    filterByTag: (tag) => {
        HomeRenderer.currentTag = tag;
        HomeRenderer.currentTagList = [];   // 点击标签也只用单标签
        const navHome = document.getElementById('nav-0');
        Router.go('home', navHome);
        HomeRenderer.updateTagBar();
    },

    // 顶部 ✕ 按钮：清除所有标签筛选
    clearTagFilter: () => {
        HomeRenderer.currentTag = null;
        HomeRenderer.currentTagList = [];
        HomeRenderer.updateTagBar();
        HomeRenderer.resetAndRender();
    },

    // 从多标签列表中移除其中一个标签
    removeOneTag: (tag) => {
        HomeRenderer.currentTagList = HomeRenderer.currentTagList.filter(t => t !== tag);
        // 如果删完没有标签了，就等同于清空筛选
        if (HomeRenderer.currentTagList.length === 0) {
            HomeRenderer.clearTagFilter();
        } else {
            HomeRenderer.updateTagBar();
            HomeRenderer.resetAndRender();
        }
    },
    
    // 处理搜索框按键：回车提交 #标签
    handleSearchKey: (e) => {
        if (e.key === 'Enter') {
            const input = document.getElementById('searchInput');
            if (!input) return;
            const raw = input.value.trim();
            if (raw.startsWith('#') && raw.length > 1) {
                const tag = raw.slice(1).toLowerCase();
                if (!HomeRenderer.currentTagList.includes(tag)) {
                    HomeRenderer.currentTagList.push(tag);
                }
                // 进入多标签模式时，忽略单个 currentTag
                HomeRenderer.currentTag = null;
                input.value = '';
                HomeRenderer.updateTagBar();
                HomeRenderer.resetAndRender();
                e.preventDefault();
            }
        }
    },

    checkAndRender: () => HomeRenderer.resetAndRender(),

    resetAndRender: async () => {
        if (HomeRenderer.observer) { 
            HomeRenderer.observer.disconnect(); 
            HomeRenderer.observer = null; 
        }

        let meta = await DBMgr.getAllPostMeta();
        meta = meta.filter(p => !p.type || p.type === 'normal');

        // 搜索框普通文字（不再在这里解析 #标签）
        const term = document.getElementById('searchInput').value.toLowerCase().trim();
        if (term) {
            meta = meta.filter(p => p.searchString.includes(term));
        }

        // 多标签模式：currentTagList AND 过滤
        if (HomeRenderer.currentTagList && HomeRenderer.currentTagList.length) {
            meta = meta.filter(p => {
                if (!p.tags || !p.tags.length) return false;
                const lowerTags = p.tags.map(t => t.toLowerCase());
                return HomeRenderer.currentTagList.every(t => lowerTags.includes(t));
            });
        }
        // 单标签模式
        else if (HomeRenderer.currentTag) {
            meta = meta.filter(p => p.tags && p.tags.includes(HomeRenderer.currentTag));
        }

        // 图片 / 文字筛选
        if (HomeRenderer.filterType === 'image') meta = meta.filter(p => p.hasImage); 
        else if (HomeRenderer.filterType === 'text') meta = meta.filter(p => !p.hasImage);

        // 排序 + 置顶
        meta.sort((a, b) => { 
            if(a.isTop && !b.isTop) return -1; 
            if(!a.isTop && b.isTop) return 1; 
            if(HomeRenderer.sortOrder === 'asc') return a.date - b.date; 
            else return b.date - a.date; 
        });
        
                    // --- 真正的合集过滤逻辑 ---
            if (HomeRenderer.currentColId) {
                const cols = await DBMgr.getAllCollections();
                const target = cols.find(c => c.id === HomeRenderer.currentColId);
                if (target && target.postIds) {
                    meta = meta.filter(p => target.postIds.includes(p.id));
                }
            }

        HomeRenderer.allMeta = meta; 
        HomeRenderer.currentIndex = 0; 
        HomeRenderer.isLoading = false;

        const postsContainer = document.getElementById('posts-list'); 
        const timelineContainer = document.getElementById('timeline-list');
        postsContainer.style.display = 'none'; 
        timelineContainer.style.display = 'none'; 
        document.getElementById('empty-state').style.display = (meta.length === 0) ? 'block' : 'none';
        if(meta.length === 0) return;

        if(HomeRenderer.layout === 2) {
            timelineContainer.style.display = 'block'; 
            timelineContainer.innerHTML = ''; 
            const batchMeta = meta.slice(0, 100); 
            const batchPosts = await DBMgr.getPostsBatch(batchMeta.map(m=>m.id));
            HomeRenderer.renderTimelineFull(batchPosts);
        } else if (HomeRenderer.layout === 0) {
            postsContainer.style.display = 'block'; 
            postsContainer.className = 'posts-container mode-grid';
            postsContainer.innerHTML = `<div class="waterfall-container"><div class="waterfall-col" id="wf-col-0"></div><div class="waterfall-col" id="wf-col-1"></div></div>`;
            await HomeRenderer.loadMore(); 
            HomeRenderer.setupObserver();
        } else {
            postsContainer.style.display = 'block';
            postsContainer.className = 'posts-container mode-list';
            postsContainer.innerHTML = '';
            await HomeRenderer.loadMore(); 
            HomeRenderer.setupObserver();
        }
    },

    loadMore: async () => { 
        if (HomeRenderer.layout === 2) return; 
        if (HomeRenderer.isLoading) return; 
        if (HomeRenderer.currentIndex >= HomeRenderer.allMeta.length) return; 
        HomeRenderer.isLoading = true;
        try {
            const nextIndex = HomeRenderer.currentIndex + HomeRenderer.BATCH_SIZE; 
            const batchMeta = HomeRenderer.allMeta.slice(HomeRenderer.currentIndex, nextIndex);
            const batchPosts = await DBMgr.getPostsBatch(batchMeta.map(m => m.id));
            if (HomeRenderer.layout === 0) {
                const col0 = document.getElementById('wf-col-0');
                const col1 = document.getElementById('wf-col-1');
                batchPosts.forEach((p) => {
                    const html = HomeRenderer.createPostHTML(p);
                    if (col0.offsetHeight <= col1.offsetHeight) {
                        col0.insertAdjacentHTML('beforeend', html);
                    } else {
                        col1.insertAdjacentHTML('beforeend', html);
                    }
                });
            } else {
                const html = batchPosts.map(p => HomeRenderer.createPostHTML(p)).join(''); 
                document.getElementById('posts-list').insertAdjacentHTML('beforeend', html); 
            }
            HomeRenderer.currentIndex = nextIndex; 
        } finally { HomeRenderer.isLoading = false; }
    },

    setupObserver: () => { 
        if (HomeRenderer.observer) HomeRenderer.observer.disconnect(); 
        const options = { root: document.getElementById('view-home'), rootMargin: '200px', threshold: 0.1 }; 
        HomeRenderer.observer = new IntersectionObserver((entries) => { 
            if (entries[0].isIntersecting) { HomeRenderer.loadMore(); } 
        }, options); 
        HomeRenderer.observer.observe(document.getElementById('scroll-sentinel')); 
    },

    createPostHTML: (p, specificLayout = null) => { 
        if(!p) return '';
        const d = Utils.formatDate(p.date); 
        const user = Utils.getCurrentUser(); 
        const images = p.images || (p.image ? [p.image] : []); 
        let mediaHTML = ''; 
        const targetLayout = (specificLayout !== null) ? specificLayout : HomeRenderer.layout;
        const firstImg = images.length > 0 ? Utils.getImgSrc(images[0]) : '';
        if (images.length > 0) {
            if (targetLayout === 0) { 
                const badge = images.length > 1 ? `<div class="img-count-badge"><svg class="icon" style="width:10px;height:10px;" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> ${images.length}</div>` : ''; 
                mediaHTML = `<div class="post-img-grid"><img src="${firstImg}" loading="lazy">${badge}</div>`; 
            } else { 
                const displayImgs = images.slice(0, 4); 
                const count = displayImgs.length; 
                const imgs = displayImgs.map(blob => `<div class="post-img-item"><img src="${Utils.getImgSrc(blob)}"></div>`).join(''); 
                mediaHTML = `<div class="post-img-grid cols-${count}">${imgs}</div>`; 
            }
        }
        const contentText = p.content || ''; 
        const bgStyle = p.postBg ? `style="background-image: url(${Utils.getImgSrc(p.postBg)}) !important; background-attachment: scroll !important;"` : '';
        let tagsHTML = '';
        if (p.tags && p.tags.length > 0) {
            tagsHTML = `<div class="post-tags">${
                p.tags.slice(0, 3).map(tag =>
                    `<span class="post-tag" onclick="event.stopPropagation(); HomeRenderer.filterByTag('${tag}')">#${tag}</span>`
                ).join('')
            }</div>`;
        }
        return `<div class="post-card ${p.isTop?'is-top':''}" id="post-${p.id}" ${bgStyle} onclick="handlePostClick(${p.id}, this)" oncontextmenu="ContextMenu.show(event, ${p.id})">
            <div class="pin-mark"><svg viewBox="0 0 24 24"><line x1="4" y1="4" x2="20" y2="4"/><line x1="12" y1="20" x2="12" y2="8"/><polyline points="6 14 12 8 18 14"/></svg></div>
            <div class="post-header">
                <div style="display:flex;align-items:center;">
                    <img src="${user.avatar}" style="width:24px;height:24px;border-radius:50%;margin-right:8px; object-fit:cover;">
                    <div class="post-date"><span class="date-day">${d.day}</span><span class="date-info">${d.ym}</span></div>
                </div>
            </div>
            ${mediaHTML}
            <div class="post-content-wrap">
                ${p.title ? `<div class="post-title">${p.title}</div>` : ''}
                <div class="post-text">${contentText}</div>
                ${tagsHTML}
            </div>
        </div>`; 
    },

    renderTimelineFull: (posts) => { 
        const groups = {}; 
        posts.forEach(p => { 
            const d = new Date(p.date); 
            const key = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2, '0')}`; 
            if(!groups[key]) groups[key] = []; 
            groups[key].push(p); 
        }); 
        let tlHtml = ''; 
        Object.keys(groups).sort((a,b)=> new Date(b)-new Date(a)).forEach(key => { 
            const [year, month] = key.split('-'); 
            const monthPosts = groups[key]; 
            let gridHtml = monthPosts.map(p => { 
                const images = p.images || (p.image ? [p.image] : []); 
                if(images.length > 0) 
                    return `<div class="grid-item" onclick="DetailRenderer.open(${p.id})"><img src="${Utils.getImgSrc(images[0])}" loading="lazy"></div>`; 
                else 
                    return `<div class="grid-item" onclick="DetailRenderer.open(${p.id})"><div class="text-card"><div class="text-content-sm">${p.title || p.content}</div></div></div>`; 
            }).join(''); 
            tlHtml += `<div class="month-section">
                <div class="month-header">
                    <div class="month-left">
                        <span class="month-num">${parseInt(month)}月</span><span class="year-num">${year}</span>
                    </div>
                    <span class="post-count-badge">${monthPosts.length}篇</span>
                </div>
                <div class="grid-row">${gridHtml}</div>
            </div>`; 
        }); 
        document.getElementById('timeline-list').innerHTML = tlHtml; 
    }
};
    
    const ColMgr = { 
        currentCover: null, currentColId: null, 
        renderList: async () => { 
            const cols = await DBMgr.getAllCollections(); 
            const container = document.getElementById('col-list-container'); 
            if(cols.length === 0) { 
                container.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">暂无合集，点击右上角创建</div>'; 
                return; 
            } 
            container.innerHTML = cols.map(c => `
                <div class="col-item" onclick="ColMgr.openDetail(${c.id})">
                    <img src="${Utils.getImgSrc(c.cover) || 'https://via.placeholder.com/150'}" class="col-cover">
                    <div class="col-info">
                        <div class="col-title">${c.title}</div>
                        <div class="col-desc">${c.desc || '无描述'}</div>
                        <div style="font-size:0.89rem; color:#bbb; margin-top:5px;">${c.postIds ? c.postIds.length : 0} 篇</div>
                    </div>
                </div>`).join(''); 
        },
        openCreate: () => { 
            ColMgr.currentColId = null; 
            ColMgr.currentCover = null; 
            document.getElementById('col-title-input').value = ''; 
            document.getElementById('col-desc-input').value = ''; 
            document.getElementById('col-cover-preview').style.display = 'none'; 
            document.getElementById('col-cover-tip').style.display = 'block'; 
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active')); 
            document.getElementById('view-collection-create').classList.add('active'); 
        }, 
        handleCover: async (input) => { 
            if(input.files && input.files[0]) { 
                const compressed = await Utils.compressImage(input.files[0]); 
                Utils.fileToBase64(compressed, (base64) => { 
                    ColMgr.currentCover = base64; 
                    document.getElementById('col-cover-preview').src = base64; 
                    document.getElementById('col-cover-preview').style.display = 'block'; 
                    document.getElementById('col-cover-tip').style.display = 'none'; 
                }); 
            } 
        }, 
        save: async () => { 
            const title = document.getElementById('col-title-input').value; 
            const desc = document.getElementById('col-desc-input').value; 
            if(!title) return alert('请输入标题'); 
            let newCol; 
            if(ColMgr.currentColId) { 
                const cols = await DBMgr.getAllCollections(); 
                const existing = cols.find(c => c.id === ColMgr.currentColId); 
                newCol = { ...existing, title: title, desc: desc, cover: ColMgr.currentCover }; 
            } else { 
                newCol = { id: Date.now(), title: title, desc: desc, cover: ColMgr.currentCover, postIds: [] }; 
            } 
            await DBMgr.saveCollection(newCol); 
            Router.go('profile'); 
            setTimeout(() => ProfileRenderer.switchTab('cols'), 100); 
        }, 
        editFromDetail: async () => { 
            const cols = await DBMgr.getAllCollections(); 
            const target = cols.find(c => c.id === ColDetailMgr.currentColId); 
            if(!target) return; 
            ColMgr.currentColId = target.id; 
            ColMgr.currentCover = target.cover; 
            document.getElementById('col-title-input').value = target.title; 
            document.getElementById('col-desc-input').value = target.desc || ''; 
            if(target.cover) { 
                document.getElementById('col-cover-preview').src = Utils.getImgSrc(target.cover); 
                document.getElementById('col-cover-preview').style.display = 'block'; 
                document.getElementById('col-cover-tip').style.display = 'none'; 
            } else { 
                document.getElementById('col-cover-preview').style.display = 'none'; 
                document.getElementById('col-cover-tip').style.display = 'block'; 
            } 
            ContextMenu.hide(); 
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active')); 
            document.getElementById('view-collection-create').classList.add('active'); 
        },
        openDetail: async (colId) => { 
            const cols = await DBMgr.getAllCollections(); 
            const target = cols.find(c => c.id === colId); 
            if(!target) return; 
            Router.history.push('collection-detail');
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active')); 
            document.getElementById('view-collection-detail').classList.add('active');
            document.getElementById('cd-bg').style.backgroundImage = `url(${Utils.getImgSrc(target.cover) || ''})`; 
            document.getElementById('cd-cover').src = Utils.getImgSrc(target.cover) || 'https://via.placeholder.com/150'; 
            document.getElementById('cd-title').innerText = target.title; 
            const user = Utils.getCurrentUser(); 
            document.getElementById('cd-avatar').src = user.avatar; 
            document.getElementById('cd-author').innerText = `${user.name} · 创建于刚刚`; 
            document.getElementById('cd-stat-sub').innerText = target.subCount || '0'; 
            document.getElementById('cd-stat-hot').innerText = target.hotCount || '0'; 
            document.getElementById('cd-stat-view').innerText = target.viewCount || '0'; 
            let posts = []; 
            if(target.postIds && target.postIds.length > 0) { 
                posts = await DBMgr.getPostsBatch(target.postIds); 
            } 
            posts.sort((a,b) => b.date - a.date); 
            const listContainer = document.getElementById('cd-post-list'); 
            if(posts.length === 0) { 
                listContainer.innerHTML = ''; 
                document.getElementById('cd-empty').style.display = 'block'; 
            } else { 
                document.getElementById('cd-empty').style.display = 'none'; 
                listContainer.innerHTML = posts.map(p => HomeRenderer.createPostHTML(p, 0)).join(''); 
            } 
            ColDetailMgr.currentColId = colId; 
            ColDetailMgr.postIds = posts.map(p => p.id); 
        } 
    };

    const ProfileRenderer = {
        currentTab: 'posts', 
        render: async () => { 
            document.querySelectorAll('.p-tab').forEach(el => el.classList.remove('active')); 
            document.getElementById(`ptab-${ProfileRenderer.currentTab}`).classList.add('active'); 
            if(ProfileRenderer.currentTab === 'posts') { 
                document.getElementById('profile-posts-area').style.display = 'block'; 
                document.getElementById('profile-cols-area').style.display = 'none'; 
                await ProfileRenderer.renderPosts(); 
            } else { 
                document.getElementById('profile-posts-area').style.display = 'none'; 
                document.getElementById('profile-cols-area').style.display = 'block'; 
                await ColMgr.renderList(); 
            } 
        },
        switchTab: (tabName) => { ProfileRenderer.currentTab = tabName; ProfileRenderer.render(); },
        returnToCols: () => { Router.go('profile'); setTimeout(() => { ProfileRenderer.switchTab('cols'); }, 50); },
        renderPosts: async () => { 
            let meta = await DBMgr.getAllPostMeta(); 
            meta = meta.filter(p => !p.type || p.type === 'normal'); 
            meta.sort((a, b) => { 
                if(a.isTop && !b.isTop) return -1; 
                if(!a.isTop && b.isTop) return 1; 
                return b.date - a.date; 
            }); 
            const batchMeta = meta.slice(0, 50); 
            const posts = await DBMgr.getPostsBatch(batchMeta.map(m=>m.id)); 
            const container = document.getElementById('profile-posts-list'); 
            if (posts.length === 0) { 
                container.innerHTML = ''; 
                document.getElementById('profile-empty').style.display = 'block'; 
            } else { 
                document.getElementById('profile-empty').style.display = 'none'; 
                container.innerHTML = posts.map(p => HomeRenderer.createPostHTML(p, 1)).join(''); 
            } 
        }
    };

const HtmlHomeRenderer = { 
    currentTab: 'html', currentSubTab: '全部', currentTag: null,
    
    switchTab: (t) => { HtmlHomeRenderer.currentTab = t; HtmlHomeRenderer.currentSubTab = '全部'; HtmlHomeRenderer.currentTag = null; document.querySelectorAll('.works-tab').forEach(el => el.classList.remove('active')); document.getElementById(`wtab-${t}`).classList.add('active'); HtmlHomeRenderer.updateTagBar(); HtmlHomeRenderer.render(); },
    switchSubTab: (s) => { HtmlHomeRenderer.currentSubTab = s; HtmlHomeRenderer.render(); },
    quickAdd: () => { Editor.open(null, HtmlHomeRenderer.currentTab); },

    // 作品页漏斗：只显示当前分类（如：角色卡）下存在的标签
    showFilterMenu: async () => {
        const allMeta = await DBMgr.getAllPostMeta();
        const typeMeta = allMeta.filter(p => p.type === HtmlHomeRenderer.currentTab);
        const tags = new Set();
        typeMeta.forEach(m => { if(m.tags) m.tags.forEach(t => tags.add(t)); });
        const sortedTags = Array.from(tags).sort();

        let html = `<div class="menu-section-title">作品标签筛选</div>`;
        html += `<div class="menu-item ${HtmlHomeRenderer.currentTag===null?'active':''}" onclick="HtmlHomeRenderer.setTagFilter(null)">全部标签</div>`;
        sortedTags.forEach(tag => {
            html += `<div class="menu-item ${HtmlHomeRenderer.currentTag===tag?'active':''}" onclick="HtmlHomeRenderer.setTagFilter('${tag}')">#${tag}</div>`;
        });
        html += `<div class="menu-item" style="color:#666;margin-top:10px;" onclick="ContextMenu.hide()">关闭</div>`;
        document.getElementById('contextMenuBody').innerHTML = html; 
        document.getElementById('contextOverlay').style.display = 'flex';
    },

    setTagFilter: (t) => { HtmlHomeRenderer.currentTag = t; HtmlHomeRenderer.updateTagBar(); HtmlHomeRenderer.render(); ContextMenu.hide(); },
    clearTagFilter: () => { HtmlHomeRenderer.currentTag = null; HtmlHomeRenderer.updateTagBar(); HtmlHomeRenderer.render(); },
    
    updateTagBar: () => {
        const bar = document.getElementById('works-tag-active-bar');
        const text = document.getElementById('works-tag-active-text');
        if(HtmlHomeRenderer.currentTag) { text.textContent = '#' + HtmlHomeRenderer.currentTag; bar.style.display = 'block'; }
        else { bar.style.display = 'none'; }
    },

    render: async () => { 
        const container = document.getElementById('html-posts-list'); 
        const subBar = document.getElementById('works-sub-bar');
        if(!container) return;
        let meta = await DBMgr.getAllPostMeta(); 
        
        // 1. 大类过滤
        let filteredMeta = meta.filter(p => p.type === HtmlHomeRenderer.currentTab); 
        
        // 2. 子分类条生成
        const allPosts = await DBMgr.getPostsBatch(filteredMeta.map(m=>m.id));
        const subs = ['全部'];
        allPosts.forEach(p => { if(p.workCategory && !subs.includes(p.workCategory)) subs.push(p.workCategory); });
        subBar.innerHTML = subs.map(s => `<div class="sub-tag ${HtmlHomeRenderer.currentSubTab === s ? 'active' : ''}" onclick="HtmlHomeRenderer.switchSubSubTab('${s}')">${s}</div>`).join('');

        // 3. 子类过滤
        if(HtmlHomeRenderer.currentSubTab !== '全部') {
            filteredMeta = filteredMeta.filter(m => {
                const p = allPosts.find(x => x.id === m.id);
                return p && p.workCategory === HtmlHomeRenderer.currentSubTab;
            });
        }

        // 4. 标签过滤 (漏斗筛选)
        if(HtmlHomeRenderer.currentTag) {
            filteredMeta = filteredMeta.filter(m => m.tags && m.tags.includes(HtmlHomeRenderer.currentTag));
        }

        // 5. 搜索过滤
        const term = document.getElementById('worksSearchInput').value.toLowerCase().trim();
        if(term) filteredMeta = filteredMeta.filter(p => p.searchString.includes(term));

        filteredMeta.sort((a, b) => (a.isTop && !b.isTop) ? -1 : (!a.isTop && b.isTop ? 1 : b.date - a.date)); 
        const posts = await DBMgr.getPostsBatch(filteredMeta.map(m=>m.id)); 
        const empty = document.getElementById('html-empty-state');
        
        if(posts.length === 0) { container.innerHTML = ''; if(empty) empty.style.display = 'block'; } 
        else { 
            if(empty) empty.style.display = 'none'; 
            container.innerHTML = `<div class="waterfall-container"><div class="waterfall-col" id="hwf-0"></div><div class="waterfall-col" id="hwf-1"></div></div>`;
            const cols = [document.getElementById('hwf-0'), document.getElementById('hwf-1')];
            const user = Utils.getCurrentUser();
            posts.forEach((p) => {
                const bg = p.postBg ? `style="background-image: url(${Utils.getImgSrc(p.postBg)}) !important; background-attachment: scroll !important;"` : '';
                let main = '';
                                // 生成标签 HTML（HTML 卡片专用）
                let tagsHTML = '';
                if (p.tags && p.tags.length > 0) {
                    tagsHTML = `<div class="post-tags" style="padding:0 12px 10px;">${p.tags.slice(0, 3).map(tag => `<span class="post-tag" onclick="event.stopPropagation(); HomeRenderer.filterByTag('${tag}')">#${tag}</span>`).join('')}</div>`;
                }
                if(p.type === 'html') main = `<div class="post-html-preview"></div>`;
                                else if(p.type === 'link') {
                    // 生成快捷复制按钮：点它只会触发复制，不会点开网页
                    const copyBtn = `<div class="card-copy-btn" title="复制链接" 
                        onclick="event.stopPropagation(); Utils.copyText('${p.content.trim()}')">
                        <svg viewBox="0 0 24 24"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
                    </div>`;
                    
                    const label = p.linkLabel || '🔗 点击跳转';
                    main = `${copyBtn}<div style="padding:24px 15px; background:rgba(24,144,255,0.05); border-radius:8px; font-size:1rem; color:#1890ff; font-weight:bold; text-align:center; margin:0 12px;">${label}</div>`;
                }
                else if(p.type === 'char') {
                    const imgs = p.images || (p.image ? [p.image] : []);
                    main = imgs.length ? `<div class="post-img-grid"><img src="${Utils.getImgSrc(imgs[0])}" loading="lazy"></div>` : `<div style="padding:15px; background:rgba(0,0,0,0.03); border-radius:8px; font-size:0.9rem; color:#666; margin:0 12px; text-align:center;">👤 角色档案</div>`;
                }
                const html = `<div class="post-card ${p.isTop?'is-top':''}" ${bg} onclick="HtmlHomeRenderer.handleCardClick(${p.id}, this)" oncontextmenu="ContextMenu.show(event, ${p.id})">
                    <div class="pin-mark"><svg viewBox="0 0 24 24"><line x1="4" y1="4" x2="20" y2="4"/><line x1="12" y1="20" x2="12" y2="8"/><polyline points="6 14 12 8 18 14"/></svg></div>
                    <div class="post-header"><div style="display:flex;align-items:center;"><img src="${user.avatar}" style="width:20px;height:20px;border-radius:50%;margin-right:6px; object-fit:cover;"><div class="post-date"><span style="font-size:0.85rem; color:#999;">${p.workCategory || ''}</span></div></div></div>
                    ${main}<div class="post-content-wrap"><div class="post-title">${p.title || (p.type === 'link' ? '未命名链接' : '未命名')}</div>${tagsHTML}</div></div>`;
                const temp = document.createElement('template'); temp.innerHTML = html.trim(); const card = temp.content.firstChild;
                if(p.type === 'html') { const pre = card.querySelector('.post-html-preview'); if(pre) { const ifr = document.createElement('iframe'); ifr.srcdoc = p.content + `<style>body { transform: scale(0.4); transform-origin: top left; width: 250%; overflow: hidden; margin:0; }</style>`; ifr.loading = "lazy"; pre.appendChild(ifr); } }
                const target = cols[0].offsetHeight <= cols[1].offsetHeight ? cols[0] : cols[1]; target.appendChild(card);
            });
        } 
    },
    // 一个修正的小函数名，确保点击子分类正常
    switchSubSubTab: (s) => { HtmlHomeRenderer.currentSubTab = s; HtmlHomeRenderer.render(); },
    handleCardClick: async (id, el) => {
        if(BatchMgr.active) { BatchMgr.toggleSelect(id, el); return; }
        const p = await DBMgr.getPost(id);
        if(!p) return;
        if(p.type === 'link') { let url = p.content.trim(); if(!url.startsWith('http')) url = 'http://' + url; window.open(url, '_blank'); }
        else DetailRenderer.open(id);
    }
};

    const BatchMgr = { 
        active: false, selectedIds: new Set(), 
        enter: () => { 
            BatchMgr.active = true; 
            BatchMgr.selectedIds.clear(); 
            document.body.classList.add('batch-mode'); 
            ContextMenu.hide(); 
        }, 
        exit: () => { 
            BatchMgr.active = false; 
            BatchMgr.selectedIds.clear(); 
            document.body.classList.remove('batch-mode'); 
            document.querySelectorAll('.post-card').forEach(el => el.classList.remove('selected')); 
        }, 
        toggleSelect: (id, cardEl) => { 
            if(BatchMgr.selectedIds.has(id)) { 
                BatchMgr.selectedIds.delete(id); 
                cardEl.classList.remove('selected'); 
            } else { 
                BatchMgr.selectedIds.add(id); 
                cardEl.classList.add('selected'); 
            } 
        }, 
        deleteSelected: async () => { 
            if(BatchMgr.selectedIds.size === 0) return; 
            if(confirm(`确定删除选中的 ${BatchMgr.selectedIds.size} 篇内容？`)) { 
                for (let id of BatchMgr.selectedIds) { 
                    await DBMgr.deletePost(id); 
                } 
                BatchMgr.exit(); 
                HomeRenderer.resetAndRender(); 
                HtmlHomeRenderer.render(); 
            } 
        }, 
        addToCollection: async () => { 
            if(BatchMgr.selectedIds.size === 0) return; 
            ContextMenu.showCollectionSelector(Array.from(BatchMgr.selectedIds)); 
        } 
    };
    
    const ThemeMgr = {
        init: () => {
            const fs = localStorage.getItem('theme_font_size') || '13.5';
            document.documentElement.style.setProperty('--app-font-size', fs + 'px');
            const slider = document.getElementById('fontSizeSlider');
            if(slider) { slider.value = fs; document.getElementById('font-size-val').innerText = fs + 'px'; }
            if(localStorage.getItem('global_bg')) document.getElementById('global-bg-layer').style.backgroundImage = `url(${localStorage.getItem('global_bg')})`;
            if(localStorage.getItem('theme_bottom_bg')) document.documentElement.style.setProperty('--bottom-bar-bg', `url(${localStorage.getItem('theme_bottom_bg')})`); 
            if(localStorage.getItem('theme_post_bg')) document.documentElement.style.setProperty('--post-card-bg', `url(${localStorage.getItem('theme_post_bg')})`); 
            const defaultIcons = ['<svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="9 22 9 12 15 12 15 22"/></svg>', '<svg viewBox="0 0 24 24"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>', '<svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>', '<svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>', '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>']; 
            for(let i=0; i<5; i++) { 
                const iconSrc = localStorage.getItem(`theme_icon_${i}`); 
                const preview = document.getElementById(`icon${i+1}Preview`); 
                if(iconSrc) { ThemeMgr.renderIcon(i, iconSrc); if(preview) preview.src = iconSrc; } 
                else if(preview) { 
                    const svgString = defaultIcons[i].replace('<svg ', '<svg xmlns="http://www.w3.org/2000/svg" stroke="#999" fill="none" stroke-width="2" '); 
                    preview.src = 'data:image/svg+xml;base64,' + btoa(svgString); 
                } 
            } 
        }, 
        renderIcon: (index, src) => { 
            const nav = document.getElementById(`nav-${index}`); 
            if(!nav) return; 
            if(index === 2) { 
                const plusIcon = nav.querySelector('.nav-icon-plus') || nav; 
                plusIcon.innerHTML = `<img src="${src}" style="width:100%; height:100%; object-fit:cover; border-radius:8px;">`; 
                if(plusIcon.classList.contains('nav-icon-plus')) plusIcon.style.background = 'transparent'; 
            } else { 
                nav.innerHTML = `<img src="${src}" class="custom-nav-icon">`; 
            } 
            const preview = document.getElementById(`icon${index+1}Preview`); 
            if(preview) preview.src = src; 
        }, 
        setIcon: (index, input) => { 
            if (input.files && input.files[0]) { 
                Utils.fileToBase64(input.files[0], (base64) => { 
                    localStorage.setItem(`theme_icon_${index}`, base64); 
                    ThemeMgr.renderIcon(index, base64); 
                }); 
            } 
        }, 
        setBarBg: (type, input) => { 
            if (input.files && input.files[0]) { 
                Utils.fileToBase64(input.files[0], (base64) => { 
                    localStorage.setItem(`theme_${type}_bg`, base64); 
                    document.documentElement.style.setProperty(`--${type}-bar-bg`, `url(${base64})`); 
                }); 
            } 
        },
        setFontSize: (val) => {
            document.documentElement.style.setProperty('--app-font-size', val + 'px');
            document.getElementById('font-size-val').innerText = val + 'px';
            localStorage.setItem('theme_font_size', val);
        },
        setPostBg: async (input) => {
            if (input.files && input.files[0]) { 
                const compressed = await Utils.compressImage(input.files[0], 1024, 0.7);
                Utils.fileToBase64(compressed, (base64) => { 
                    try {
                        localStorage.setItem('theme_post_bg', base64); 
                        document.documentElement.style.setProperty('--post-card-bg', `url(${base64})`); 
                        alert('全局名片背景已更新');
                    } catch (e) {
                        alert('图片太大，无法保存到配置中，请换一张小图');
                    }
                }); 
                input.value = ''; 
            } 
        }, 
        resetAll: () => { 
            if(confirm('重置美化？')) { 
                Object.keys(localStorage).forEach(key => { 
                    if(key.startsWith('theme_') || key === 'global_bg') localStorage.removeItem(key); 
                }); 
                location.reload(); 
            } 
        }
    };

    const FontMgr = {
        currentFontId: null,
        init: async () => {
            const fonts = await DBMgr.getAllFonts();
            for (const font of fonts) {
                await FontMgr.loadFontFace(font);
            }
            const savedId = localStorage.getItem('theme_font_id');
            if (savedId) {
                const target = fonts.find(f => f.id == savedId);
                if (target) FontMgr.applyFont(target, true);
                else FontMgr.resetFont(true);
            }
        },
        loadFontFace: async (font) => {
            try {
                let source;
                if (font.type === 'url') {
                    source = `url(${font.data})`;
                } else {
                    const blobUrl = URL.createObjectURL(font.data);
                    source = `url(${blobUrl})`;
                }
                const fontFace = new FontFace(font.name, source);
                await fontFace.load();
                document.fonts.add(fontFace);
            } catch (e) {
                console.error('加载字体失败:', font.name, e);
            }
        },
        showMenu: async () => {
            const fonts = await DBMgr.getAllFonts();
            const currentId = localStorage.getItem('theme_font_id');
            const listEl = document.getElementById('font-list-container');
            let html = `<div class="menu-item ${!currentId ? 'active' : ''}" onclick="FontMgr.resetFont()">
                <div style="flex:1; text-align:left;">系统默认</div>
                ${!currentId ? '✓' : ''}
            </div>`;
            html += fonts.map(f => {
                const isActive = currentId == f.id;
                return `<div class="menu-item ${isActive ? 'active' : ''}" style="justify-content:space-between;">
                    <div style="flex:1; text-align:left; font-family:'${f.name}'; font-size:1.19rem;" onclick="FontMgr.applyById(${f.id})">${f.name}</div>
                    <div style="display:flex; gap:10px; align-items:center;">
                        ${isActive ? '✓' : ''}
                        <div style="color:#ff4d4f; font-size:1.33rem; padding:0 10px;" onclick="FontMgr.delete(${f.id}, event)">×</div>
                    </div>
                </div>`;
            }).join('');
            if (fonts.length === 0) {
                html += `<div style="padding:20px; text-align:center; color:#999; font-size:0.89rem;">暂无自定义字体</div>`;
            }
            listEl.innerHTML = html;
            document.getElementById('fontOverlay').style.display = 'flex';
        },
        addFontClick: () => {
            document.getElementById('addFontOverlay').style.display = 'flex';
        },
        addByUrl: async () => {
            const url = prompt('请输入字体文件 URL (ttf/woff/otf):');
            if (!url) return;
            let name = prompt('请输入字体名称:', '网络字体');
            if(!name) name = 'Font';
            name += '_' + Date.now();
            document.getElementById('loadingMask').style.display = 'flex';
            document.getElementById('loadingText').innerText = '正在验证字体...';
            try {
                const fontFace = new FontFace(name, `url(${url})`);
                await fontFace.load();
                const newFont = { id: Date.now(), name: name, type: 'url', data: url };
                await DBMgr.saveFont(newFont);
                await FontMgr.loadFontFace(newFont);
                FontMgr.applyFont(newFont);
                document.getElementById('addFontOverlay').style.display = 'none';
                FontMgr.showMenu();
            } catch(e) {
                alert('字体加载失败，请检查URL是否有效且允许跨域');
            } finally {
                document.getElementById('loadingMask').style.display = 'none';
            }
        },
        handleFileSelect: async (input) => {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                let customName = prompt('给字体起个名字 (留空使用文件名):');
                if (customName === null) { input.value = ''; return; }
                let name = customName.trim();
                if (!name) name = file.name.split('.')[0];
                document.getElementById('loadingMask').style.display = 'flex';
                document.getElementById('loadingText').innerText = '正在处理字体...';
                try {
                    const newFont = { id: Date.now(), name: name, type: 'blob', data: file };
                    const blobUrl = URL.createObjectURL(file);
                    const fontFace = new FontFace(name, `url(${blobUrl})`);
                    await fontFace.load();
                    await DBMgr.saveFont(newFont);
                    await FontMgr.loadFontFace(newFont);
                    FontMgr.applyFont(newFont);
                    document.getElementById('addFontOverlay').style.display = 'none';
                    FontMgr.showMenu();
                } catch(e) {
                    console.error(e);
                    alert('字体文件解析失败');
                } finally {
                    input.value = '';
                    document.getElementById('loadingMask').style.display = 'none';
                }
            }
        },
        applyById: async (id) => {
            const fonts = await DBMgr.getAllFonts();
            const target = fonts.find(f => f.id == id);
            if(target) FontMgr.applyFont(target);
        },
        applyFont: (font, silent = false) => {
            document.documentElement.style.setProperty('--app-font', `"${font.name}", var(--default-font)`);
            localStorage.setItem('theme_font_id', font.id);
            localStorage.setItem('theme_font_name', font.name);
            document.getElementById('current-font-name').innerText = font.name;
            if (!silent) FontMgr.showMenu();
        },
        resetFont: (silent = false) => {
            document.documentElement.style.setProperty('--app-font', 'var(--default-font)');
            localStorage.removeItem('theme_font_id');
            localStorage.removeItem('theme_font_name');
            document.getElementById('current-font-name').innerText = '默认';
            if (!silent) FontMgr.showMenu();
        },
        delete: async (id, e) => {
            e.stopPropagation();
            if(confirm('确定删除此字体？')) {
                await DBMgr.deleteFont(id);
                if (localStorage.getItem('theme_font_id') == id) {
                    FontMgr.resetFont();
                }
                FontMgr.showMenu();
            }
        }
    };

    const GitHubMgr = {
        config: { token: '', repo: '', auto: false, interval: 48, lastTime: 0 },
        init: () => {
            const confStr = localStorage.getItem('gh_config');
            if(confStr) GitHubMgr.config = JSON.parse(confStr);
            const tokenInput = document.getElementById('gh-token-input');
            const repoInput = document.getElementById('gh-repo-input');
            const autoSwitch = document.getElementById('gh-auto-switch');
            if(tokenInput) tokenInput.value = GitHubMgr.config.token || '';
            if(repoInput) repoInput.value = GitHubMgr.config.repo || '';
            if(autoSwitch) {
                autoSwitch.checked = GitHubMgr.config.auto || false;
                document.getElementById('gh-interval-setting').style.display = autoSwitch.checked ? 'flex' : 'none';
            }
            if(document.getElementById('gh-interval-select')) {
                document.getElementById('gh-interval-select').value = GitHubMgr.config.interval || 48;
            }
            GitHubMgr.updateStatusText();
            if(GitHubMgr.config.auto) GitHubMgr.checkAndBackup();
        },
        saveConfig: () => {
            const token = document.getElementById('gh-token-input').value.trim();
            const repo = document.getElementById('gh-repo-input').value.trim();
            const auto = document.getElementById('gh-auto-switch').checked;
            const interval = parseInt(document.getElementById('gh-interval-select').value);
            GitHubMgr.config.token = token;
            GitHubMgr.config.repo = repo;
            GitHubMgr.config.auto = auto;
            GitHubMgr.config.interval = interval;
            document.getElementById('gh-interval-setting').style.display = auto ? 'flex' : 'none';
            localStorage.setItem('gh_config', JSON.stringify(GitHubMgr.config));
            GitHubMgr.updateStatusText();
        },
        updateStatusText: () => {
            const el = document.getElementById('gh-status-msg');
            if(!el) return;
            if(!GitHubMgr.config.lastTime) el.innerText = '从未备份过';
            else {
                const date = new Date(GitHubMgr.config.lastTime);
                const nextTime = new Date(GitHubMgr.config.lastTime + (GitHubMgr.config.interval || 48) * 3600000);
                el.innerText = `上次: ${date.toLocaleString()} (下次约: ${nextTime.toLocaleString()})`;
            }
        },
        checkAndBackup: async () => {
            if(!GitHubMgr.config.token || !GitHubMgr.config.repo || !GitHubMgr.config.auto) return;
            const now = Date.now();
            const interval = GitHubMgr.config.interval || 48;
            const hours = (now - (GitHubMgr.config.lastTime || 0)) / (1000 * 60 * 60);
            if(hours >= interval) {
                const toast = document.createElement('div');
                toast.style.cssText = 'position:fixed; top:10px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.7); color:#fff; padding:8px 15px; border-radius:20px; font-size:12px; z-index:9999; pointer-events:none; transition:opacity 0.5s;';
                toast.innerText = '正在后台准备自动备份...';
                document.body.appendChild(toast);
                try {
                    await GitHubMgr.performUpload((msg) => { toast.innerText = '自动备份: ' + msg; });
                    toast.innerText = '自动备份成功！';
                    setTimeout(() => toast.remove(), 3000);
                } catch(e) {
                    console.error('自动备份失败', e);
                    toast.innerText = '自动备份失败: ' + e.message;
                    setTimeout(() => toast.remove(), 5000);
                }
            }
        },
        testUpload: async () => {
            if(!GitHubMgr.config.token || !GitHubMgr.config.repo) return alert('请先填写 Token 和 仓库路径');
            document.getElementById('loadingMask').style.display = 'flex';
            try {
                await GitHubMgr.performUpload((msg) => { document.getElementById('loadingText').innerText = msg; });
                alert('上传成功！');
            } catch(e) {
                alert('上传失败: ' + e.message);
            } finally {
                document.getElementById('loadingMask').style.display = 'none';
            }
        },
        performUpload: async (onProgress) => {
            onProgress('正在打包数据...');
            const zipBlob = await DBMgr.generateBackupZip('all', onProgress);
            onProgress('正在编码...');
            const base64Content = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const res = reader.result;
                    const base64 = res.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(zipBlob);
            });
            onProgress('正在上传至 GitHub...');
            const dateStr = new Date().toISOString().slice(0, 10);
            const fileName = `AutoBackup_${dateStr}_${Date.now()}.zip`;
            const path = fileName;
            const url = `https://api.github.com/repos/${GitHubMgr.config.repo}/contents/${path}`;
            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${GitHubMgr.config.token}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify({
                    message: `Auto backup ${dateStr}`,
                    content: base64Content
                })
            });
            if(!response.ok) {
                const errJson = await response.json();
                throw new Error(errJson.message || 'GitHub API Error');
            }
            GitHubMgr.config.lastTime = Date.now();
            localStorage.setItem('gh_config', JSON.stringify(GitHubMgr.config));
            GitHubMgr.updateStatusText();
        },
        checkStatus: async () => {
            if(!GitHubMgr.config.token || !GitHubMgr.config.repo) return alert('未配置');
            const url = `https://api.github.com/repos/${GitHubMgr.config.repo}`;
            try {
                const res = await fetch(url, { headers: { 'Authorization': `token ${GitHubMgr.config.token}` } });
                if(res.ok) {
                    const data = await res.json();
                    alert(`连接成功！\n仓库: ${data.full_name}\n私有: ${data.private}\n说明: 配置有效`);
                } else {
                    alert('连接失败，请检查 Token 或 仓库路径');
                }
            } catch(e) { alert('网络错误: ' + e.message); }
        },
        restoreLatest: async () => {
            if(!GitHubMgr.config.token || !GitHubMgr.config.repo) return alert('请先在配置中填写 Token 和 仓库路径');
            if(!confirm('⚠️ 警告：这将下载最新的自动备份并覆盖当前所有数据！\n\n确定要继续吗？')) return;
            document.getElementById('loadingMask').style.display = 'flex';
            document.getElementById('loadingText').innerText = '正在连接 GitHub...';
            try {
                const url = `https://api.github.com/repos/${GitHubMgr.config.repo}/contents/`;
                const res = await fetch(url, { headers: { 'Authorization': `token ${GitHubMgr.config.token}` } });
                if(!res.ok) {
                    if(res.status === 404) throw new Error('仓库不存在或路径错误');
                    if(res.status === 401) throw new Error('Token 无效或无权限');
                    throw new Error('获取列表失败: ' + res.status);
                }
                const files = await res.json();
                const backups = files.filter(f => f.name.startsWith('AutoBackup_') && f.name.endsWith('.zip'));
                if(backups.length === 0) throw new Error('仓库中没有找到任何自动备份文件');
                backups.sort((a, b) => {
                    const getTs = (name) => {
                        const match = name.match(/_(\d+)\.zip$/);
                        return match ? parseInt(match[1]) : 0;
                    };
                    return getTs(b.name) - getTs(a.name);
                });
                const latest = backups[0];
                document.getElementById('loadingText').innerText = '正在下载: ' + latest.name;
                const dlUrl = `https://api.github.com/repos/${GitHubMgr.config.repo}/contents/${latest.name}`;
                const dlRes = await fetch(dlUrl, {
                    headers: {
                        'Authorization': `token ${GitHubMgr.config.token}`,
                        'Accept': 'application/vnd.github.v3.raw'
                    }
                });
                if(!dlRes.ok) throw new Error('下载文件失败: ' + dlRes.status);
                const blob = await dlRes.blob();
                const file = new File([blob], latest.name, { type: 'application/zip' });
                document.getElementById('loadingText').innerText = '下载完成，准备导入...';
                await DBMgr.processImport(file);
            } catch(e) {
                console.error(e);
                alert('恢复失败: ' + e.message);
                document.getElementById('loadingMask').style.display = 'none';
            }
        }
    };

    function handlePostClick(id, el) {
        if(BatchMgr.active) { 
            BatchMgr.toggleSelect(id, el); 
        } else { 
            if (document.getElementById('view-collection-detail').classList.contains('active')) { 
                DetailRenderer.open(id, ColDetailMgr.currentColId); 
            } else { 
                DetailRenderer.open(id); 
            } 
        } 
    }

    let touchTimer = null; 
    document.addEventListener('touchstart', (e) => { 
        const card = e.target.closest('.post-card'); 
        if(card && !BatchMgr.active) { 
            touchTimer = setTimeout(() => { 
                const evt = new MouseEvent('contextmenu', { bubbles: true, cancelable: true, view: window }); 
                card.dispatchEvent(evt); 
            }, 600); 
        } 
    }); 
    document.addEventListener('touchend', () => clearTimeout(touchTimer)); 
    document.addEventListener('touchmove', () => clearTimeout(touchTimer));
    
    function updateImage(input, elemId, type) { 
        if (input.files && input.files[0]) { 
            Utils.fileToBase64(input.files[0], (base64) => { 
                if(type === 'bg') { 
                    document.getElementById(elemId).style.backgroundImage = `url(${base64})`; 
                    localStorage.setItem('profile_bg', base64); 
                } else { 
                    document.getElementById(elemId).src = base64; 
                    localStorage.setItem('profile_avatar', base64); 
                } 
            }); 
        } 
    }
    function saveProfileMeta() { 
        localStorage.setItem('profile_name', document.getElementById('userName').innerText); 
        localStorage.setItem('profile_id', document.getElementById('userId').innerText); 
        localStorage.setItem('profile_ip', document.getElementById('userIp').innerText); 
    }
    function setGlobalBg(input) { 
        if(input.files && input.files[0]) { 
            Utils.fileToBase64(input.files[0], (base64) => { 
                document.getElementById('global-bg-layer').style.backgroundImage = `url(${base64})`; 
                localStorage.setItem('global_bg', base64); 
            }); 
        } 
    }
// 处理HTML详情页的返回 (防闪烁优化版)
function handleHtmlBack() {
    // 1. 关闭评论抽屉
    DetailRenderer.toggleHtmlComments(false);
    
    // 2. 先把页面切回作品中心
    document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
    const worksHome = document.getElementById('view-html-home');
    if(worksHome) worksHome.classList.add('active');
    
    // 亮起作品中心图标
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    const worksNav = document.getElementById('nav-1');
    if(worksNav) worksNav.classList.add('active');

    // 3. 【核心：延迟清空】页面切走后，再清空 iframe
    setTimeout(() => {
        const iframe = document.getElementById('html-detail-iframe');
        if(iframe) {
            iframe.srcdoc = ''; 
            iframe.src = 'about:blank';
        }
        DetailRenderer.currentPostId = null;
        
        // 整理路由账本
        Router.history = Router.history.filter(view => view !== 'detail' && view !== 'html-detail');
        if(!Router.history.includes('html-home')) Router.history.push('html-home');
    }, 300);

    // 4. 刷新一下列表数据
    HtmlHomeRenderer.render();
}
    window.addEventListener('DOMContentLoaded', async () => {
        await DBMgr.init();
        // 初始化后尝试恢复备份（仅在数据为空时提示）
        await BackupMgr.restoreIfNeeded();
        
        if(localStorage.getItem('profile_bg')) document.getElementById('profileBg').style.backgroundImage = `url(${localStorage.getItem('profile_bg')})`;
        if(localStorage.getItem('profile_avatar')) document.getElementById('avatarImg').src = localStorage.getItem('profile_avatar');
        if(localStorage.getItem('profile_name')) document.getElementById('userName').innerText = localStorage.getItem('profile_name');
        if(localStorage.getItem('profile_id')) document.getElementById('userId').innerText = localStorage.getItem('profile_id');
        if(localStorage.getItem('profile_ip')) document.getElementById('userIp').innerText = localStorage.getItem('profile_ip');
        ThemeMgr.init();
        FontMgr.init();
        GitHubMgr.init();
        HomeRenderer.updateIcon();
        HomeRenderer.resetAndRender();
        document.addEventListener('plusready', function(){
            console.log("APP环境就绪，设置全屏");
            plus.navigator.setFullscreen(true);
        });
    });
</script>
</body>
</html>
